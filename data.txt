/* AME37A â€“ Full benefits by office (TOTAL, PA, NA) for Jan 2025)  */
/* Mirrors S01 (office list) + S04 (earliest AP per ICI per office) + READ-S02 (prev FS action) */
/* Office list = admin offices from TWNCASELD_DEBTLD excluding DC, DH, DL, DR */

WITH
-- S01: office driving list (admin only, exclude specific codes)
OFFICES AS (
  SELECT DISTINCT D.OFC_CD
  FROM W026DTF1.TWNCASELD_DEBTLD D
  WHERE D.PRGM_OFC_TYPE = 'A'
    AND D.OFC_CD NOT IN ('DC','DH','DL','DR')
),

-- S04: earliest AP per ICI **for that office** in the month (inclusive window)
FAC AS (
  SELECT
      C.OFC_CD,
      A.ICI,
      MIN(A.ACTN_TS) AS AP_TS
  FROM W026DTF1.TWNFAM_ACTNS      A
  JOIN W026DTF1.TWNFAM_CASELD_CASE C
    ON C.ICI = A.ICI
   AND C.PRGM_OFC_TYPE = 'A'
  WHERE A.PRGM_TYP = 'FS'
    AND A.ACTN_TYP = 'AP'
    AND A.ACTN_TS >= TIMESTAMP('2025-01-01-00.00.00')
    AND A.ACTN_TS <= TIMESTAMP('2025-01-31-23.59.59')
  GROUP BY C.OFC_CD, A.ICI
),

-- Keep only ICIs that belong to the driven admin office list (matches legacy per-office loop)
FAC_IN_SCOPE AS (
  SELECT F.*
  FROM FAC F
  JOIN OFFICES O ON O.OFC_CD = F.OFC_CD
),

-- READ-S02: previous FS action strictly before AP (per ICI)
PREV AS (
  SELECT
    F.ICI,
    F.OFC_CD,
    MAX(P.ACTN_TS) AS PREV_TS
  FROM FAC_IN_SCOPE F
  JOIN W026DTF1.TWNFAM_ACTNS P
    ON P.ICI = F.ICI
   AND P.PRGM_TYP = 'FS'
   AND P.ACTN_TS  < F.AP_TS
  GROUP BY F.ICI, F.OFC_CD
),

-- Filter to previous action types ('FA','RE','RI') exactly as EGL IF condition
PREV_OK AS (
  SELECT P.OFC_CD, P.ICI, P.PREV_TS
  FROM PREV P
  JOIN W026DTF1.TWNFAM_ACTNS R
    ON R.ICI = P.ICI
   AND R.PRGM_TYP = 'FS'
   AND R.ACTN_TS = P.PREV_TS
   AND R.ACTN_TYP IN ('FA','RE','RI')
),

-- FS suffix as-of the PREVIOUS action's timestamp (READ-S02 provides FS-SUFX)
CLASS AS (
  SELECT
    K.OFC_CD,
    K.ICI,
    (
      SELECT H.FS_SUFX
      FROM W026DTF1.TWNFAM_CASE_HSTRY H
      WHERE H.ICI = K.ICI
        AND H.PRD_BEG_DT <= DATE(K.PREV_TS)
        AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= DATE(K.PREV_TS)
      ORDER BY H.PRD_BEG_DT DESC
      FETCH FIRST 1 ROW ONLY
    ) AS FS_SUFX
  FROM PREV_OK K
)

-- Final by office: FULL (total), PA, NA
SELECT
  O.OFC_CD,
  COALESCE(COUNT(CX.ICI), 0) AS FULL_BENEFITS_TOTAL,
  COALESCE(SUM(CASE WHEN CX.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END), 0) AS PA_BENEFITS,
  COALESCE(SUM(CASE WHEN CX.FS_SUFX IN ('P','S','G','A') THEN 0 ELSE 1 END), 0) AS NA_BENEFITS
FROM OFFICES O
LEFT JOIN CLASS CX
  ON CX.OFC_CD = O.OFC_CD
GROUP BY O.OFC_CD
ORDER BY O.OFC_CD;
