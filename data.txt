SELECT
  RIGHT('000000000' || T1.WRNT_SEQ_NMB, 9) AS ISSUANCE_NUMBER,
  T1.WRNT_PRNT_DT AS ISSUANCE_DATE,
  RIGHT('000000000' || T2.SSN, 9) AS CASE,
  T3.ICI AS EBT_ICI,
  TRIM(T2.FRST_NM) || ' ' || TRIM(T2.MID_NM) || ' ' || TRIM(T2.MODFR) || ' ' || TRIM(T2.LST_NM) AS CASE_NAME,
  T1.OFC_CD AS DIST,
  T1.WRNT_STS_EFF_DT AS AVAIL_DATE,
  T1.WRNT_AMT AS TOTAL_FUND,

  -- Totals from filtered TWNAFDC_WRNT
  (SELECT COUNT(*) 
   FROM {?SCHEMA}.TWNAFDC_WRNT 
   WHERE WRNT_STS_CD = 'IS' 
     AND ISS_MTD = 'E' 
     AND WRNT_PRNT_DT <= (DATE({?DATE}) + 1 DAY) 
     AND WRNT_STS_EFF_DT > (DATE({?DATE}) + 1 DAY)
  ) AS CASES,

  (SELECT COUNT(*) 
   FROM {?SCHEMA}.TWNAFDC_WRNT 
   WHERE WRNT_STS_CD = 'IS' 
     AND ISS_MTD = 'E' 
     AND FUND_SRCE_TYPE = 'RG'
     AND WRNT_PRNT_DT <= (DATE({?DATE}) + 1 DAY) 
     AND WRNT_STS_EFF_DT > (DATE({?DATE}) + 1 DAY)
  ) AS RG,

  (SELECT COUNT(*) 
   FROM {?SCHEMA}.TWNAFDC_WRNT 
   WHERE WRNT_STS_CD = 'IS' 
     AND ISS_MTD = 'E' 
     AND FUND_SRCE_TYPE = 'SP'
     AND WRNT_PRNT_DT <= (DATE({?DATE}) + 1 DAY) 
     AND WRNT_STS_EFF_DT > (DATE({?DATE}) + 1 DAY)
  ) AS SP,

  (SELECT COUNT(*) 
   FROM {?SCHEMA}.TWNAFDC_WRNT 
   WHERE WRNT_STS_CD = 'IS' 
     AND ISS_MTD = 'E' 
     AND FUND_SRCE_TYPE = 'FD'
     AND WRNT_PRNT_DT <= (DATE({?DATE}) + 1 DAY) 
     AND WRNT_STS_EFF_DT > (DATE({?DATE}) + 1 DAY)
  ) AS FD,

  (SELECT SUM(WRNT_AMT) 
   FROM {?SCHEMA}.TWNAFDC_WRNT 
   WHERE WRNT_STS_CD = 'IS' 
     AND ISS_MTD = 'E' 
     AND WRNT_PRNT_DT <= (DATE({?DATE}) + 1 DAY) 
     AND WRNT_STS_EFF_DT > (DATE({?DATE}) + 1 DAY)
  ) AS TOTAL

FROM
  {?SCHEMA}.TWNAFDC_WRNT T1
  JOIN {?SCHEMA}.TWNFAM_CASE_HSTRY T3 
    ON T1.ICI = T3.ICI AND T3.PRD_END_DT = '9999-12-31'
  JOIN {?SCHEMA}.TWNPERSON T2 
    ON T3.HOH_UPI = T2.UPI

WHERE
  T1.WRNT_STS_CD = 'IS'
  AND T1.ISS_MTD = 'E'
  AND T1.WRNT_PRNT_DT <= (DATE({?DATE}) + 1 DAY)
  AND T1.WRNT_STS_EFF_DT > (DATE({?DATE}) + 1 DAY)

ORDER BY
  T1.WRNT_PRNT_DT,
  T3.ICI
