package PGM_T_Batch;
import egl.core.*;
import CommonMigratedParts.*;
import DataTables.*;
//*** PROGRAM=TEMPV1A ****
// COMPONENT NAME: TEMPV1A             - CALLED BATCH
// ===============
// 
// DESCRIPTION:
// ============
// This application handles the processing when an Employer
// is received from an outside institution in batch mode. The
// processing includes:
//         1) Create the Employer if it does not already exist
//            in NOMADS.
//         2) Update the Job History for the NCP
//         3) Update Functinal Area / Office / Caseload if
//            applicable via DCP27A (for every case the NCP
//            is associated with)
//         4) Generate NV0014 (Income Withholding) and GN0092
//            (Employment Verification) forms for every active
//            Order against the NCP.
//         5) Generate alert 370043 - Employer Verification
//            form is due to be returned.
// ************************
Program TEMPV1A type basicProgram //VAGen Info - called batch program
  (
   VDBCONTROL VDBCONTROL, // record
   VMESSAGE VMESSAGE, // record
   TEMPV1W TEMPV1W // record
  )
  {
  includeReferencedFunctions = yes, allowUnqualifiedItemReferences = yes, 
  throwNrfEofExceptions = yes, handleHardIOErrors = no, V60ExceptionCompatibility = yes, 
  I4GLItemsNullable = no, textLiteralDefaultIsString = no, localSQLScope = yes
  }

  // Data Declarations
  CEP01W CEP01W; // record
  GDW GDW; // record
  H2-EMPLOYER H2-EMPLOYER; // record
  H2-JOB-HISTORY H2-JOB-HISTORY; // record
  TIWTC1W TIWTC1W; // record
  VDBCOMMON VDBCOMMON; // record

  // VAGen Info - items needed for migration
  VAGen_EZESYS char(8);
  VAGen_EZEREPLY num(1);
  VAGen_EZE_WAIT_TIME bin(9,2);
  VAGen_EZE_ITEMLEN int;

  // Use Declarations
  use VDB00T1 {deleteAfterUse = yes}; // table

  function main()
    // VAGen Info - initialization needed for migration
    VAGen_EZESYS = VGLib.getVAGSysType();
    TEMPV1P1-MAIN: TEMPV1P1-MAIN();
  end // end main
end // end TEMPV1A


// Update JOB & create IW letter
Function TEMPV1P1-MAIN()
  VDBCOMMON.UAPPLNAM = "TEMPV1A";

  call "DATEAPP" (GDW, VDBCONTROL, VMESSAGE) {isNoRefresh = yes};

  set H2-JOB-HISTORY empty;
  H2-JOB-HISTORY.EMPLR-ID = TEMPV1W.EMPLR-FID;
  H2-JOB-HISTORY.UPI = TEMPV1W.UPI;
  TEMPV1P9-S01(); /* Get existing Job History for NCP /*/
                                   /* Employer*/

  if (H2-JOB-HISTORY.VRFN-STS == "P" || H2-JOB-HISTORY.VRFN-STS == "B"
   || H2-JOB-HISTORY.VRFN-STS == " ")
    TEMPV1P2-JOB-HIST(); /* Update Employer and Job History*/
  /* WI 23315 begin*/
    if (TEMPV1W.ALT-SSN-FG == "N")
  /* WI 23315 end*/
      TIWTC1W.UPI = TEMPV1W.UPI;
      TIWTC1W.EMPLR-FID = TEMPV1W.EMPLR-FID; /* Generate Forms*/
      call "TIWTC1A" (VDBCONTROL, VMESSAGE, TIWTC1W) {isNoRefresh = yes}; /* and Alert*/
    end
  end
  /*  */
end // end TEMPV1P1-MAIN


// INSERTS IN JOB TABLES
Function TEMPV1P2-JOB-HIST()
  /* Create Employer*/

  set H2-EMPLOYER empty;
  H2-EMPLOYER.EMPLR-ID = TEMPV1W.EMPLR-FID;
  TEMPV1P9-S02();
  if (H2-EMPLOYER is noRecordFound)
    set H2-EMPLOYER empty;
    H2-EMPLOYER.LST-UPD-USRID = TEMPV1W.APPL;
    H2-EMPLOYER.LST-CHNGD-DT = GDW.DTCD;
    H2-EMPLOYER.PHN-NMB = " ";
    H2-EMPLOYER.PHN-EXT = " ";
    H2-EMPLOYER.EMPLR-NM = TEMPV1W.EMPLR-NM;
    H2-EMPLOYER.ZIP-CD = TEMPV1W.EMPLR-ZIP;
    H2-EMPLOYER.ST-CD = TEMPV1W.EMPLR-ST-CD;
    H2-EMPLOYER.CITY = TEMPV1W.EMPLR-CITY;
    H2-EMPLOYER.AGNT-NM = " ";
    H2-EMPLOYER.CNTCT-PRSN = " ";
    H2-EMPLOYER.AGNT-ADR1 = " ";
    H2-EMPLOYER.AGNT-ADR2 = " ";
    H2-EMPLOYER.AGNT-CITY = " ";
    H2-EMPLOYER.AGNT-ST = " ";
    H2-EMPLOYER.AGNT-ZIP-CD = " ";
  /* WI 26398 begin*/
  /* MOVE TEMPV1W.EMPLR-ADR1 TO H2-EMPLOYER.ADR-LN1;*/
  /* MOVE TEMPV1W.EMPLR-ADR2 TO H2-EMPLOYER.ADR-LN2;*/
    if (TEMPV1W.EMPLR-ADR1 != ".")
      H2-EMPLOYER.ADR-LN1 = TEMPV1W.EMPLR-ADR1;
    end
    if (TEMPV1W.EMPLR-ADR2 != ".")
      H2-EMPLOYER.ADR-LN2 = TEMPV1W.EMPLR-ADR2;
    end
  /* WI 26398 end*/
    H2-EMPLOYER.DOING-BUS-AS-NM = TEMPV1W.EMPLR-NM;
    H2-EMPLOYER.CNTRY = TEMPV1W.EMPLR-CNTRY-CD;
    H2-EMPLOYER.AGNT-CNTRY = " ";
    H2-EMPLOYER.OFC-CD = " ";
    H2-EMPLOYER.PRGM-OFC-TYPE = " ";
    H2-EMPLOYER.BTCH-ENTRY-DT = "0001-01-01";
    H2-EMPLOYER.BTCH-NMB = 0;
    H2-EMPLOYER.EMPLR-ID = TEMPV1W.EMPLR-FID;
    H2-EMPLOYER.CHKS-RMT-IND = " ";
    TEMPV1P9-I01();
  end

  /* Update Job History*/

  if (H2-JOB-HISTORY is noRecordFound)
    set H2-JOB-HISTORY empty;
    H2-JOB-HISTORY.UPI = TEMPV1W.UPI;
    H2-JOB-HISTORY.EMPLR-ID = TEMPV1W.EMPLR-FID;
    H2-JOB-HISTORY.CRTN-DT = GDW.DTCD;
    H2-JOB-HISTORY.JOB-BEG-DT = TEMPV1W.EMP-DOH;
    H2-JOB-HISTORY.JOB-TITLE = " ";
    H2-JOB-HISTORY.JOB-END-DT = "9999-12-31";
    H2-JOB-HISTORY.UNION-NM = " ";
    H2-JOB-HISTORY.ZIP-CD = TEMPV1W.EMPLR-ZIP;
    H2-JOB-HISTORY.ST-CD = TEMPV1W.EMPLR-ST-CD;
    H2-JOB-HISTORY.CITY = TEMPV1W.EMPLR-CITY;
    H2-JOB-HISTORY.HLTH-INS-IND = " ";
    H2-JOB-HISTORY.OCPTN-CD = " ";
    H2-JOB-HISTORY.EMPLT-STS-EFF-DT = TEMPV1W.EMP-DOH;
    H2-JOB-HISTORY.EMPLT-STS = " ";
    H2-JOB-HISTORY.VRFD-DT = GDW.DTCD;
    H2-JOB-HISTORY.VRFD-BY = TEMPV1W.APPL;
    H2-JOB-HISTORY.EMPLT-INFO-SRC = TEMPV1W.INFO-SRC;
    H2-JOB-HISTORY.PHN-EXT = " ";
    H2-JOB-HISTORY.PHN-NMB = " ";
    H2-JOB-HISTORY.JH-NOTE = " ";
  /* WI 26398 begin*/
  /* MOVE TEMPV1W.EMPLR-ADR1 TO H2-JOB-HISTORY.ADR-LN1;*/
  /* MOVE TEMPV1W.EMPLR-ADR2 TO H2-JOB-HISTORY.ADR-LN2;*/
    if (TEMPV1W.EMPLR-ADR1 != ".")
      H2-JOB-HISTORY.ADR-LN1 = TEMPV1W.EMPLR-ADR1;
    end
    if (TEMPV1W.EMPLR-ADR2 != ".")
      H2-JOB-HISTORY.ADR-LN2 = TEMPV1W.EMPLR-ADR2;
    end
  /* WI 26398 end*/
    if (TEMPV1W.ALT-SSN-FG == "N")
      H2-JOB-HISTORY.VRFN-STS = "C";
    else
      H2-JOB-HISTORY.VRFN-STS = "B";
    end
    H2-JOB-HISTORY.INTRFC-SSN = TEMPV1W.INTRFC-SSN;
    H2-JOB-HISTORY.NCP-WWH-EFF-DT = "0001-01-01";
    H2-JOB-HISTORY.NCP-WWH-ESTD-AMT = 0.00;
    H2-JOB-HISTORY.UNION-CD = 0;
    H2-JOB-HISTORY.NCP-WWH-STS = " ";
    TEMPV1P9-I02();
  else
    if (TEMPV1W.ALT-SSN-FG == "N")
      H2-JOB-HISTORY.VRFN-STS = "C";
      H2-JOB-HISTORY.JOB-END-DT = "9999-12-31";
    else
      H2-JOB-HISTORY.VRFN-STS = "B";
      H2-JOB-HISTORY.JOB-END-DT = GDW.DTCD;
    end
    H2-JOB-HISTORY.INTRFC-SSN = TEMPV1W.INTRFC-SSN;
    TEMPV1P9-U01();
  end
end // end TEMPV1P2-JOB-HIST


// Insert EMPLOYER
Function TEMPV1P9-I01()
  /* *********************************************************************/
  /* This process replaces the record in the TWNSDNH table because the  */
  /* match indicator needs to be set on.                                */
  /* *********************************************************************/
  WDB00PI();
  VDBCOMMON.UAPPLNAM = "TEMPV1A";
  VDBCOMMON.USQLREC = "H2-EMPLOYER";
  VDBCONTROL.UPROC-NM = "TEMPV1P9-I01";
  VDBCONTROL.UPROC-OPT = "ADD";
  VDBCONTROL.UPROC-OBJ = "H2-EMPLOYER";
  VDBCONTROL.UACCTYP = "W";
  try
    add H2-EMPLOYER ;
  end

  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end TEMPV1P9-I01


// Insert job history
Function TEMPV1P9-I02()
  WDB00PI();
  VDBCOMMON.UAPPLNAM = "TEMPV1A";
  VDBCOMMON.USQLREC = "H2-JOB-HISTORY";
  VDBCONTROL.UPROC-NM = "TEMPV1P9-I02";
  VDBCONTROL.UPROC-OPT = "ADD";
  VDBCONTROL.UPROC-OBJ = "H2-JOB-HISTORY";
  VDBCONTROL.UACCTYP = "W";
  try
    add H2-JOB-HISTORY
      with #sql{
        insert into TWNJOB_HISTORY
        (UPI, EMPLR_ID, CRTN_DT, JOB_BEG_DT, JOB_TITLE,
          JOB_END_DT, UNION_NM, ZIP_CD, ST_CD, CITY,
          HLTH_INS_IND, OCPTN_CD, EMPLT_STS_EFF_DT,
          EMPLT_STS, VRFD_DT, VRFD_BY, EMPLT_INFO_SRC,
          PHN_EXT, PHN_NMB, JH_NOTE, ADR_LN1, ADR_LN2,
          VRFN_STS, NCP_WWH_EFF_DT, NCP_WWH_ESTD_AMT,
          UNION_CD, NCP_WWH_STS, INTRFC_SSN)
        values (:UPI, :EMPLR-ID, :CRTN-DT, :JOB-BEG-DT, :JOB-TITLE,
          :JOB-END-DT, :UNION-NM, :ZIP-CD, :ST-CD, :CITY,
          :HLTH-INS-IND, :OCPTN-CD, :EMPLT-STS-EFF-DT,
          :EMPLT-STS, :VRFD-DT, :VRFD-BY, :EMPLT-INFO-SRC,
          :PHN-EXT, :PHN-NMB, :JH-NOTE, :ADR-LN1, :ADR-LN2,
          :VRFN-STS, :NCP-WWH-EFF-DT, :NCP-WWH-ESTD-AMT,
          :UNION-CD, :NCP-WWH-STS, :INTRFC-SSN)
      } ;
  end

  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end TEMPV1P9-I02


// VERIFY EMPLOYER
Function TEMPV1P9-S01()
  WDB00PI();
  VDBCOMMON.UAPPLNAM = "TEMPV1A";
  VDBCOMMON.USQLREC = "H2-JOB-HISTORY";
  VDBCONTROL.UPROC-NM = "TEMPV1P9-S01";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  VDBCONTROL.UPROC-OBJ = "H2-JOB-HISTORY";
  VDBCONTROL.UACCTYP = "R";
  try
    get H2-JOB-HISTORY
      with #sql{
        select VRFN_STS, CRTN_DT
        from TWNJOB_HISTORY T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE
               UPI          = :UPI
           AND EMPLR_ID     = :EMPLR-ID
           AND (JOB_END_DT  >= :GDW.DTCD
	           or CRTN_DT = :GDW.DTCD)
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into VRFN-STS, CRTN-DT ;
  end

  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end TEMPV1P9-S01


// Get employer id
Function TEMPV1P9-S02()
  /* *********************************************************************/
  /* This process declares cursor for fetching data from the following  */
  /* table                                                              */
  /* 1. TWNEMPLOYER                                                     */
  /* *********************************************************************/
  WDB00PI();
  VDBCOMMON.UAPPLNAM = "TEMPV1A";
  VDBCOMMON.USQLREC = "H2-EMPLOYER";
  VDBCONTROL.UPROC-NM = "TEMPV1P9-S02";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  VDBCONTROL.UPROC-OBJ = "H2-EMPLOYER";
  VDBCONTROL.UACCTYP = "R";
  try
    get H2-EMPLOYER
      with #sql{
        select EMPLR_ID
        from TWNEMPLOYER T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE EMPLR_ID = :EMPLR-ID
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into EMPLR-ID ;
  end

  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end TEMPV1P9-S02


// Update Job History
Function TEMPV1P9-U01()
  WDB00PI();
  VDBCOMMON.UAPPLNAM = "TEMPV1A";
  VDBCOMMON.USQLREC = "H2-JOB-HISTORY";
  VDBCONTROL.UPROC-NM = "TEMPV1P9-U01";
  VDBCONTROL.UPROC-OPT = "SQLEXEC";
  VDBCONTROL.UPROC-OBJ = "H2-JOB-HISTORY";
  VDBCONTROL.UACCTYP = "W";
  try
    execute 
      #sql{
         --** INSERT SQL STATEMENT HERE **
        UPDATE TWNJOB_HISTORY
        SET EMPLT_INFO_SRC = :TEMPV1W.INFO-SRC,
            VRFN_STS       = :VRFN-STS,
            VRFD_BY        = :TEMPV1W.APPL,
            VRFD_DT        = :GDW.DTCD,
            INTRFC_SSN     = :INTRFC-SSN,
            JOB_END_DT     = :JOB-END-DT
        WHERE
            UPI      = :UPI       AND
            EMPLR_ID = :EMPLR-ID  AND
            CRTN_DT  = :CRTN-DT
      }
      for H2-JOB-HISTORY ; // model = none
  end

  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end TEMPV1P9-U01


