WITH SQ1 AS(
SELECT 
	WRNT_SEQ_NMB,
	OFC_CD,
	WRNT_STS_CD,
	WRNT_ISD_DT,
	WRNT_STS_EFF_DT,
	WRNT_AMT,
	ICI,
	WRNT_PRNT_DT,
	FUND_SRCE_TYPE,
	CASE WHEN FUND_SRCE_TYPE='RG' THEN 1 END AS RG,
	CASE WHEN FUND_SRCE_TYPE='SP' THEN 1 END AS SP,
	CASE WHEN FUND_SRCE_TYPE='FD' THEN 1 END AS FD,
	ISS_MTD
FROM 
	{?SCHEMA}.TWNAFDC_WRNT T1
WHERE
	WRNT_STS_CD IN ('IS') AND   
	ISS_MTD  = 'E' AND 
	WRNT_PRNT_DT <= (DATE({?DATE}) + 1 DAY) AND 
	WRNT_STS_EFF_DT >(DATE({?DATE}) + 1 DAY)
ORDER BY 
WRNT_PRNT_DT,ICI
),
SQ2 AS(
SELECT 
	TRIM(T1.FRST_NM)||' '||TRIM(T1.MID_NM)||' '||TRIM(T1.MODFR)||' '||TRIM(T1.LST_NM) AS CASE_NAME,
	T1.SSN,
	T2.HMLS_IND,
	T2.ICI
FROM 
	{?SCHEMA}.TWNPERSON T1,
	{?SCHEMA}.TWNFAM_CASE_HSTRY T2
WHERE
	T1.UPI = T2.HOH_UPI AND 
	T2.PRD_END_DT   = '9999-12-31'
),
SQ3 AS(
SELECT 
COUNT(SQ1.RG) AS RG,
COUNT(SQ1.SP) AS SP,
COUNT(SQ1.FD) AS FD,
COUNT(SQ1.WRNT_AMT) AS CASES,
SUM(SQ1.WRNT_AMT) AS TOTAL
FROM SQ1
)
SELECT
	RIGHT('000000000' ||SQ1.WRNT_SEQ_NMB, 9) AS ISSUANCE_NUMBER,
	SQ1.WRNT_PRNT_DT AS ISSUANCE_DATE,
	SQ2.SSN AS CASE,
	SQ2.ICI AS EBT_ICI,
	SQ2.CASE_NAME,
	SQ1.OFC_CD AS DIST,
	SQ1.WRNT_STS_EFF_DT AS AVAIL_DATE,
	SQ1.WRNT_AMT AS TOTAL_FUND,
	SQ3.CASES,
	SQ3.RG,
	SQ3.SP,
	SQ3.FD,
	SQ3.TOTAL
FROM SQ1,SQ2,SQ3
WHERE SQ2.ICI=SQ1.ICI
ORDER BY 
WRNT_PRNT_DT,SQ2.ICI