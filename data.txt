-- Applications during report month (AP) per case
ACTIONS_AP AS (
  SELECT T1.ICI, T2.OFC_CD, OFC.OFC_NM, MIN(T1.ACTN_TS) AS AP_TS
  FROM {?SCHEMA}.TWNFAM_ACTNS T1
  JOIN {?SCHEMA}.TWNFAM_CASELD_CASE T2 ON T1.ICI = T2.ICI
  JOIN OFFICE_DATA OFC ON T2.OFC_CD = OFC.OFC_CD
  JOIN RPT_DATES RPT ON 1=1
  WHERE T2.PRGM_OFC_TYPE = 'A'
    AND T1.PRGM_TYP = 'FS'
    AND T1.ACTN_TYP = 'AP'
    AND T1.ACTN_TS >= RPT.RPT_BEG_DT_TS
    AND T1.ACTN_TS <= RPT.RPT_END_DT_TS
  GROUP BY T1.ICI, T2.OFC_CD, OFC.OFC_NM
),

-- Most recent *previous* FA/RE/RI before AP per case (this is the S04 gate)
PREV_FARI AS (
  SELECT
    A.OFC_CD, A.OFC_NM, A.ICI,
    T1.ACTN_TS AS PREV_TS,
    T2.FS_SUFX,
    ROW_NUMBER() OVER (PARTITION BY A.ICI ORDER BY T1.ACTN_TS DESC) AS rn
  FROM ACTIONS_AP A
  JOIN {?SCHEMA}.TWNFAM_ACTNS T1
    ON T1.ICI = A.ICI AND T1.PRGM_TYP='FS' AND T1.ACTN_TS < A.AP_TS
    AND T1.ACTN_TYP IN ('FA','RE','RI')
  JOIN {?SCHEMA}.TWNFAM_CASE_HSTRY T2
    ON T2.ICI = T1.ICI
  JOIN RPT_DATES RPT ON 1=1
  WHERE T2.PRD_BEG_DT <= RPT.RPT_END_DT AND T2.PRD_END_DT >= RPT.RPT_END_DT
),

-- One row per case with valid FA/RE/RI + get recruit date to split NEW/SUBS
S04_APPROVALS AS (
  SELECT P.OFC_CD, P.OFC_NM, P.ICI, P.FS_SUFX, H.RCRT_APL_DT,
         RPT.RPT_BEG_DT, RPT.RPT_END_DT
  FROM PREV_FARI P
  JOIN RPT_DATES RPT ON 1=1
  JOIN {?SCHEMA}.TWNPRGM_CASE_HSTRY H
    ON H.ICI = P.ICI AND H.PRGM_CASE_TYPE='FS'
  WHERE P.rn = 1
),

-- >>> FULL BENEFIT exactly as EGL increments WS-PABNFT / WS-NABNFT <<<
MAIN2 AS (
  SELECT
    OFC_CD,
    OFC_NM,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PABNFT,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A')
              AND RCRT_APL_DT BETWEEN RPT_BEG_DT AND RPT_END_DT THEN 1 ELSE 0 END) AS PANEW,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A')
              AND (RCRT_APL_DT < RPT_BEG_DT OR RCRT_APL_DT > RPT_END_DT) THEN 1 ELSE 0 END) AS PASUBS,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NABNFT,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A')
              AND RCRT_APL_DT BETWEEN RPT_BEG_DT AND RPT_END_DT THEN 1 ELSE 0 END) AS NANEW,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A')
              AND (RCRT_APL_DT < RPT_BEG_DT OR RCRT_APL_DT > RPT_END_DT) THEN 1 ELSE 0 END) AS NASUBS
  FROM (
    SELECT OFC_CD, OFC_NM, ICI, FS_SUFX, RCRT_APL_DT, RPT_BEG_DT, RPT_END_DT,
           ROW_NUMBER() OVER (PARTITION BY ICI ORDER BY ICI) AS dedup
    FROM S04_APPROVALS
  ) X
  WHERE dedup = 1              -- one row per ICI (matches legacy)
  GROUP BY OFC_CD, OFC_NM
);
