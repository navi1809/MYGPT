WITH RPT_DT AS (SELECT DATE({?RPT_DT}) AS dt FROM SYSIBM.SYSDUMMY1)
, 
INPUT_DATES AS (
SELECT
	dt AS RPT_DT,
	DATE(ADD_MONTHS(dt, -1) - (DAY(ADD_MONTHS(DT, -1)) - 1) DAYS) AS EXPNG_BEG_DT, -- PREVIOUS MONTH START DATE
	LAST_DAY(dt - 1 MONTH) AS EXPNG_END_DT -- -- PREVIOUS MONTH END DATE
FROM
	RPT_DT
)
 
SELECT
    UPPER(TO_CHAR(IP_DT.EXPNG_END_DT, 'Month')) || '  ' || VARCHAR_FORMAT(IP_DT.EXPNG_END_DT, 'YYYY') AS RPT_MONTH,
    COALESCE(INSERT(INSERT(LPAD(CAST(T1.SSN AS VARCHAR(9)), 9, '0'), 4, 0, '-'), 7, 0, '-'), '000-00-0000') AS SSN, 
    T3.LST_NM,
	T3.FRST_NM,
	CASE WHEN T1.NEON_EXPNG > ' ' THEN 'N' ELSE 'Y' END AS TLMT_REDUCED,
	LPAD(CAST(T1.BNFT_MTH AS VARCHAR(2)), 2, '0') || '/' || CAST(T1.BNFT_YR AS VARCHAR(4)) AS BNFT_MTH,
	CASE WHEN T1.BNFT_AMT > 0 THEN T1.BNFT_AMT ELSE 0.00 END AS BNFT_AMT,
	CASE WHEN T2.BNFT_RDCTN_AMT > 0 THEN T2.BNFT_RDCTN_AMT ELSE 0.00 END AS BNFT_RDCTN_AMT,
	T1.ICI,
	T1.PRGM_CASE_TYPE,
	T1.VER_NMB, 
	T1.EXPNG_AMT,
	T1.WRNT_AMT,
	T1.WRNT_STS_CD,
	T1.WRNT_STS_EFF_DT,
	T1.OFC_CD,
	T1.NEON_EXPNG
FROM
	{?SCHEMA}.TWNAFDC_WRNT T1,
	{?SCHEMA}.TWNELIG_VERSION T2,
	{?SCHEMA}.TWNPERSON T3
JOIN 
    INPUT_DATES IP_DT ON 1=1
WHERE
	T1.SSN = T3.SSN
	AND T1.ICI = T2.ICI
	AND T1.BNFT_MTH = T2.BNFT_MTH
	AND T1.BNFT_YR = T2.BNFT_YR
	AND T1.PRGM_CASE_TYPE = T2.PRGM_CASE_TYPE
	AND T1.VER_NMB = T2.VER_NMB
	AND T2.BNFT_RDCTN_AMT > 0
	AND T1.WRNT_STS_CD = 'EE'
	AND T1.WRNT_STS_EFF_DT >= IP_DT.EXPNG_BEG_DT
	AND T1.WRNT_STS_EFF_DT <= IP_DT.EXPNG_END_DT
    AND T1.EXPNG_AMT = T1.WRNT_AMT
ORDER BY SSN ASC