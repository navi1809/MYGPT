-- AME37A: Full benefits counts (PA / NA) by office for Jan 2025
-- Mirrors EGL logic: SETINQ-S04 / READ-S02 / READ-S03

SELECT
    C.OFC_CD,
    COUNT(*) AS FULL_BENEFITS_TOTAL,
    SUM(CASE WHEN FCH.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PA_BENEFITS,
    SUM(CASE WHEN FCH.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NA_BENEFITS
FROM W026DTF1.TWNFAM_ACTNS     FAC   -- corresponds to H2-2-FAA-FAC
JOIN W026DTF1.TWNFAM_ACTNS     FCH   -- corresponds to H2-2-FAA-FCH
  ON FCH.ICI = FAC.ICI
 AND FCH.ACTN_TS = (
       SELECT MAX(F2.ACTN_TS)
         FROM W026DTF1.TWNFAM_ACTNS F2
        WHERE F2.ICI = FAC.ICI
          AND F2.PRGM_TYP = 'FS'
          AND F2.ACTN_TS <  FAC.ACTN_TS
     )
JOIN W026DTF1.TWNFAM_CASE_HSTRY HST  -- corresponds to H2-PRGM-CASE-HSTRY
  ON HST.ICI = FAC.ICI
JOIN W026DTF1.TWNFAM_CASELD_CASE C
  ON C.ICI = FAC.ICI
WHERE C.PRGM_OFC_TYPE = 'A'
  AND FAC.PRGM_TYP = 'FS'
  AND FAC.ACTN_TYP = 'AP'                          -- new approval actions (AME37 logic)
  AND FCH.ACTN_TYP IN ('FA','RE','RI')             -- previous full-benefit actions
  AND FAC.ACTN_TS >= TIMESTAMP('2025-01-01-00.00.00')
  AND FAC.ACTN_TS <= TIMESTAMP('2025-01-31-23.59.59')
  AND HST.RCRT_APL_DT BETWEEN DATE('2025-01-01') AND DATE('2025-01-31')
GROUP BY C.OFC_CD
ORDER BY C.OFC_CD;
