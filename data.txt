// *******************************************************************************
// Scriptable Batch Config
// Customer: DWSS Nevada

// Load Business Object - Business Object to use
var BOresourceId = xpath.numberValueOf("/CASE/JOB_DETAILS/BUSINESSOBJECT_ID");
var OPConfigID = 206800145;

// Creating Time and Date stamp for file name
var todayIs = new Date();

// Create a unique time stamp, milliseconds since January 1, 1970 00:00:00 UTC
var GUID = todayIs.getTime();
var barcodeMessage = GUID;

var jobDetailsNode = xpath.selectNodes("/CASE/JOB_DETAILS");
var boCopy = xpath.loadBO("/CASE", BOresourceId, 1, "CASE");

// ** START ** If the element - IS_BARCODE_PROVIDED is missing, Modify DOM for
// adding a new element (BARCODE_IDENTIFIER), Add millisecond GUID as the
// barcode message/identifier
if (IsMissing(boCopy.JOB_DETAILS.IS_BARCODE_PROVIDED)) {
	var dom = jobDetailsNode[0].getOwnerDocument();
	var newElement = dom.createElement("BARCODE_IDENTIFIER");
	newElement.setTextContent(barcodeMessage);
	jobDetailsNode[0].appendChild(newElement);
}
// **END** Modify DOM for adding a new element (BARCODE_IDENTIFIER)
var bo = xpath.loadBO("/CASE", BOresourceId, 1, "CASE");
var ARCHIVENAME = bo.ARCHIVENAME; // Set archive file name

var DOCTYPE = "PRIMARY"; // Set default recipient to primary
var recipientIndex = 0; // Recipient count indicates what index recipient
var channelCount = 0; 
// Used for setting thunderhead channel job properties

// Set language, this section sets the language for the primary recipient.
// var primaryLanguage = bo.JOB_DETAILS.PRIMARY_LANG_CD;
// Additional Code for NOD
var primaryLanguage = bo.JOB_DETAILS.PRIMARY_LANG_CD;
/*
 * if (BOresourceId == "983000907") { primaryLanguage =
 * bo.CONTACT.NOTICE_ADDRESSES.ADDRESS[0].ADDRESS_LANG; } else { primaryLanguage =
 * bo.JOB_DETAILS.PRIMARY_LANG_CD; }
 */
var language = 5; // 5 is for English (United States)
// Setting Language "02" indicates Spanish
if (primaryLanguage == "02") {
	language = 6;// 6 is for Spanish
}

// var PrintDestination=
// "/usr/IBM/WebSphere/Thunderhead/servers/thserver/data/output/"+GUID;
// var ArchiveDestination=
// "/usr/IBM/WebSphere/Thunderhead/servers/thserver/data/output/"+GUID;
// var ArchiveEnglishDestination=
// "/usr/IBM/WebSphere/Thunderhead/servers/thserver/data/output/"+GUID+"_English";
// var EmailDestination=
// "/usr/IBM/WebSphere/Thunderhead/servers/thserver/data/output/"+GUID+".html";

// Reset Job Setup to clear it before adding anything to the job
job.reset();

if (bo.JOB_DETAILS.isSTP == true) // If Straight Through Processing (STP)
{
	// PRIMARY
	// PS - Print
	if (bo.JOB_DETAILS.CHANNELS.PRINT == true) {

		if (IsNotMissing(bo.APPL_SUPPRESS_FLAG)) {
			// For RD and NOD and END
			if (bo.APPL_SUPPRESS_FLAG == "N")

			{
				setPrint();
			}
		} else {
			// for All others
			setPrint();
		}

	}

	// PDF - Archive
	if (bo.JOB_DETAILS.CHANNELS.ARCHIVE == true) {
		setArchive();
	}

	// HTML - Email
	// if(bo.JOB_DETAILS.CHANNELS.EMAIL == true)
	// {
	// setEmail();
	// }

	setArgs();
	job.submit();

	// ***** English Archive Channel ************
	// If the original is in any language besides English, create an English
	// Archive copy.
	if (language != 5) {
		language = 5; // Set the language for the English Archive and reset of
		// Auth Rep copies
		// Create a new (English) Archive copy, if original language was not
		// English (e.g. Spanish)
		if (bo.JOB_DETAILS.CHANNELS.ARCHIVE == true) {
			if (BOresourceId == "983000907") {
				DOCTYPE = "ENGLISHARCHIVE";
			}
			job.reset();
			channelCount = 0;
			setArchive();
			setArgs();
			job.submit();
		}
	}

	if (IsNotMissing(bo.AUTHORIZED_REPRESENTATIVES)) {
		// CC output
		DOCTYPE = "CC";

		// Create CC for each Authorized Representative
		for (recipientIndex = 0; recipientIndex < bo.AUTHORIZED_REPRESENTATIVES.length; recipientIndex++) {
			job.reset();
			channelCount = 0;

			// PS - Print
			if (bo.JOB_DETAILS.CHANNELS.PRINT == true) {
                    if (IsNotMissing(bo.AUTHORIZED_REPRESENTATIVES[recipientIndex].AUTH_REP_SUPPRESS_FLAG)) {
        if (bo.AUTHORIZED_REPRESENTATIVES[recipientIndex].AUTH_REP_SUPPRESS_FLAG == "N") {
            setPrint();
        }
    } else {
        setPrint();
    }					
			}

			// PDF - Archive
			if (bo.JOB_DETAILS.CHANNELS.ARCHIVE == true) {
				setArchive();
			}

			setArgs();
			job.submit();
		}
	}
} else { // Not STP - Using user interaction, RC Utility Review Cases, create
	// review case job
	DOCTYPE = "PRIMARY"; // Set default recipient to primary
	recipientIndex = 0; // Recipient count indicates what index recipient
	channelCount = 0; // Used for setting thunderhead channel job properties

	if (bo.JOB_DETAILS.isRCUtility == true) { // transaction from RC Utility
		// for RC execute preview will
		// have this set to false
		// (Schema/BO Default = false)
		// override defaults with values set by the RC Utility
		DOCTYPE = bo.JOB_DETAILS.recipientType; // could be 'PRIMARY' or 'CC'
		recipientIndex = bo.JOB_DETAILS.recipientIndex;
	}

	if (EqualsIgnoreCase(DOCTYPE, "PRIMARY")) {
		if (recipientIndex == 0) {
			// PS - Print
			if (bo.JOB_DETAILS.CHANNELS.PRINT == true) {
				if (IsNotMissing(bo.APPL_SUPPRESS_FLAG)) {
					// For RD and NOD and END
					if (bo.APPL_SUPPRESS_FLAG == "N")

					{
						setPrint();
					}
				} else {
					// for All others
					setPrint();
				}

			}

			// PDF - Archive
			if (bo.JOB_DETAILS.CHANNELS.ARCHIVE == true) {
				setArchive();
			}

			// HTML - Email
			// if(bo.JOB_DETAILS.CHANNELS.EMAIL == true)
			// {
			// setEmail();
			// }
			setArgs();
			job.submit();

		} else if (recipientIndex == -1) {
			// ***** English Archive Channel ************
			// If the original is in any language besides English, create an
			// English Archive copy.
			if (language != 5) {
				language = 5; // Set the language for the English Archive and
				// reset of Auth Rep copies
				// Create a new (English) Archive copy, if original language was
				// not English (e.g. Spanish)
				if (bo.JOB_DETAILS.CHANNELS.ARCHIVE == true) {
					job.reset();
					channelCount = 0;
					setArchive();
					setArgs();
					job.submit();
				}
			}
		}
	} else if (EqualsIgnoreCase(DOCTYPE, "CC")) {
		job.reset();
		channelCount = 0;
		if (language != 5) // CC's are English copies
		{
			language = 5;
		}

		// PS - Print
		if (bo.JOB_DETAILS.CHANNELS.PRINT == true) {
			if (IsNotMissing(bo.APPL_SUPPRESS_FLAG)) {
				// For RD and NOD and END
				if (bo.APPL_SUPPRESS_FLAG == "N")

				{
					setPrint();
				}
			} else {
				// for All others
				setPrint();
			}

		}

		// PDF - Archive
		if (bo.JOB_DETAILS.CHANNELS.ARCHIVE == true) {
			setArchive();
		}

		setArgs();
		job.submit();
	}
}

function setPrint() {
	job.addChannel(2, -6);
	// job.setChannelProperty(channelCount, "bin.outputpath", PrintDestination);
	job.setChannelProperty(channelCount, "print.config.resid", OPConfigID);
	if (BOresourceId == "983000907") {
		job.setChannelProperty(channelCount, "print.jobsetup", "Print NOD");
	} else {
		job.setChannelProperty(channelCount, "print.jobsetup", "Print");
	}
	job.setChannelProperty(channelCount, "Feed1", "false");
	job.setChannelProperty(channelCount, "Feed2", "false");
	job.setChannelProperty(channelCount, "Feed3", "false");
	job.setChannelProperty(channelCount, "recipient", DOCTYPE);
	job.setChannelProperty(channelCount, "recipientIndex", recipientIndex);
	job.setChannelProperty(channelCount, "language", language);
	channelCount += 1;
}

function setArchive() {
	job.addChannel(206800000, -5);
	// job.setChannelProperty(channelCount, "bin.outputpath",
	// ArchiveDestination);
	job.setChannelProperty(channelCount, "print.config.resid", OPConfigID);
	job.setChannelProperty(channelCount, "print.jobsetup", "Archive");
	/*
	 * if (BOresourceId == "983000060") { if(IsNotMissing(bo.ARCHIVENAME) &&
	 * !bo.ARCHIVENAME.equalsIgnoreCase("")) {
	 * job.setChannelProperty(channelCount, "bin.outputpath",
	 * "/usr/IBM/WebSphere/Thunderhead/servers/thserver/data/output/"+ARCHIVENAME); } }
	 */
	job.setChannelProperty(channelCount, "Feed1", "false");
	job.setChannelProperty(channelCount, "Feed2", "false");
	job.setChannelProperty(channelCount, "Feed3", "false");
	job.setChannelProperty(channelCount, "recipient", DOCTYPE);
	job.setChannelProperty(channelCount, "recipientIndex", recipientIndex);
	job.setChannelProperty(channelCount, "language", language);
	channelCount += 1;
}

function setEmail() {
	job.addChannel(1, 0);
	// job.setChannelProperty(channelCount, "disk.outputpath",
	// EmailDestination);
	job.setChannelProperty(channelCount, "print.config.resid", OPConfigID);
	job.setChannelProperty(channelCount, "print.jobsetup", "Email");
	job.setChannelProperty(channelCount, "recipient", DOCTYPE);
	job.setChannelProperty(channelCount, "recipientIndex", recipientIndex);
	job.setChannelProperty(channelCount, "language", language);
	channelCount += 1;
}

function setArgs() {
	job.setTemplate(bo.JOB_DETAILS.TEMPLATE_ID);
	job.setArg("CASE", bo);
	job.setArg("CC_REPRESENTATIVE", "");
	job.setArg("CC_INDEX", recipientIndex);
	job.setArg("DOC_TYPE", DOCTYPE);
	job.setLanguage(language);
}