@echo off


rem ************************************************************************************
rem Job Steps -
rem
rem STEP00 
rem       Delete all old files from the following locations:
rem         D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders\temp_to_Merg
rem         D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders\Merged
rem
rem STEP1 - STEP3
rem       Check to see if ALL Postscript files in the FTP '/temp_to_Print' folder,
rem       to prevent any un-printed files from being over writen.
rem    
rem       End SCRIPT!!!  If ANY Postscript are found in the '/temp_to_Print' folder.
rem
rem STEP4 - STEP6
rem       FTP Move Postscript files From '/' to '/x_To_Merg/x_Merg_0_Current'
rem       FTP GET  Postscript files From '/x_To_Merg/x_Merg_0_Current' and copy to local folder:
rem                D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders\temp_to_Merg
rem       Merg all Post files.
rem 
rem STEP6
rem       FTP PUT ALL Merged Post files to EITS sFTP Print server.
rem 
rem STEP7 - STEP10
rem       Create Archive folder
rem           D:\Batch_Jobs\SmartComm_NoticeBatch\Archive_PS_Files\20yymmdd
rem       Move Postscript files
rem         From Folder -
rem           D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders\temp_to_Merg\*.ps
rem         To Folder -
rem           D:\Batch_Jobs\SmartComm_NoticeBatch\Archive_PS_Files\20yymmdd
rem       Rename all Merged Postscript files to 'WNMPRT6###.ps'
rem
rem STEP11
rem       Compress all Postscript (*.ps) files in Archive folder.
rem 
rem ....
rem 
rem Obsolete - STEP12 On the Mainframe run Batch job to print the Post Script files:
rem            CDP.WN91.ZEKEJCL(WNFAMPRT)
rem
rem Notes:
rem   1) The FTP list (ls) command will only list 1998 files and/or sub-folders at
rem      one time in that FTP directory, it's an Operation System limitation/setting.
rem
rem   2) The FTP move (mv) will move 2000 files to a differant folder.
rem ************************************************************************************


rem ====================
rem  SET DATE Variables
rem ====================

setlocal

rem === Get Date Variables Year Month Day (CCYYMMDD)  ===
for /f "tokens=2-4 delims=/ " %%a in ('DATE/T') do set cdate=%%c%%a%%b

rem === Get Date Variables Year  (CCYY)               ===
for /f "tokens=2-4 delims=/ " %%a in ('DATE/T') do set cyydate=%%c%

rem === Get Date Variables Month (MM)                 ===
for /f "tokens=2-4 delims=/ " %%a in ('DATE/T') do set mmdate=%%a%

rem === Get Date Variables Day   (DD)                 ===
for /f "tokens=2-4 delims=/ " %%a in ('DATE/T') do set dddate=%%b%

rem === Get Current Time         (HH:MM)              ===
for /f "tokens=1-6 " %%t in ('TIME/T') do set ctime=%%t

rem === Get Current Time         (hh)                 ===
for /f "tokens=1 delims=: " %%h in ('time /T') do set hour=%%h

rem === Get Current Time         (mm)                 ===
for /f "tokens=2 delims=: " %%m in ('time /T') do set minutes=%%m

rem === 24hr/military format                          ===
for /f "tokens=1-3 delims=:." %%e in ("%TIME: =0%") do (set hhmmtime=%%e%%f)



rem ==========================
rem === Set Directory Paths ==
rem ==========================
set MERGPATH=D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders
set PostScript_Folder=%MERGPATH%\temp_to_Merg
set Merged_Folder=%MERGPATH%\Merged
set BINPATH=D:\Dell\DSET\bin
set INPUT=D:\Batch_Jobs\SmartComm_NoticeBatch\Archive_PS_Files
set LOGPATH=D:\Batch_Jobs\SmartComm_NoticeBatch\Logs
set BINPATH=D:\Dell\DSET\bin



rem STEP00
rem ===========================================================
rem === Delete temp work files if they already exist
rem ===========================================================
IF EXIST tempWork_gen_PSFileList.txt DEL tempWork_gen_PSFileList.txt
IF EXIST tempWork_gen_ParsedPSFileList.txt DEL tempWork_gen_ParsedPSFileList.txt
IF EXIST 0.tempGen_FtpWorkScript DEL 0.tempGen_FtpWorkScript
del /q d:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders\Merged\*


rem STEP1
rem ===========================================================
rem === FTP LIST (ls) PostScript files in SUB-Folder 
rem ===========================================================

rem === Sets sFTP Output Log Paths ===
set sFTPLogA=%LOGPATH%\FTPLog_Detail%cdate%_%hhmmtime%.txt
set sFTPLogB=%LOGPATH%\FTPLog_List_%cdate%_%hhmmtime%.txt
set sFTPLogC=%LOGPATH%\FTPLog_Move_GET_%cdate%_%hhmmtime%.txt

cd D:\Batch_Jobs\SmartComm_NoticeBatch\Batch_Scripts

rem === Dynamically Creates Script 0.sftp with Date Variables                            ===
rem === open [(sftp|ftp|scp)://][userID[:password]@]host[:port]                          ===
rem ===    1. Special characters like '@' in the password need to be coded               ===
rem ===          with the Hexadecimal ASCII code value so the                            ===
rem ===               pwd: $M@rtc0mm becomes: pwd                               ===

> 0.ftp1 echo option batch on
>> 0.ftp1 echo option confirm off
>> 0.ftp1 echo open sftp://welfare@10.128.224.3:22 -privatekey=DWSS_EITS_Printer_Private_Key_RSA_2048.ppk -timeout=120
>> 0.ftp1 echo cd prod
>> 0.ftp1 echo ls 
>> 0.ftp1 echo exit

rem == Run sFTP Script ===
echo .
echo *** STEP1 ***
echo *** ******************************************************************* ***
echo *** Get List of (.ps) files in the FTP sub-forder:  temp_to_Print/ ***
echo *** ******************************************************************* ***

>> %sFTPLogB% echo .
>> %sFTPLogB% echo *** STEP1 ***
>> %sFTPLogB% echo *** ******************************************************************* ***
>> %sFTPLogB% echo *** Get List of (.ps) files in the FTP sub-forder:  temp_to_Print/ ***
>> %sFTPLogB% echo *** ******************************************************************* ***

winscp.com /console /script=0.ftp1 > %sFTPLogB%
rem winscp.com /console /script=0.ftp1 /log=%sFTPLogA% > %sFTPLogB%

IF ERRORLEVEL 1 GOTO :ERROR_STEP1


rem STEP2
rem ==========================================================
rem === Checks to see if all PostScript files have been
rem === printed by the mainframe batch job(s).
rem === Exit script if their are un-proccessed print files.
rem ==========================================================

rem === FIND Lines with "WNMPRT6" from the ftp ls "list" output file ===
find /i "WNMPRT6" < %sFTPLogB%  > tempWork_gen_PSFileList.txt

rem === Does a file called WNMPRT6* already exist in the ftp SUB-Folder 'temp_to_Print/'? ===
rem === If a file exits then exit script!  If no file already exits the continue.                  ===
echo Check does a file called WNMPRT6* already exist in the ftp SUB-Folder 'temp_to_Print/? ***

for %%R in (tempWork_gen_PSFileList.txt) do if %%~zR equ 0 goto FILE_EMPTY
goto FILE_NOT_EMPTY

:FILE_NOT_EMPTY
echo .
echo *** STEP2 ***
echo *** ************************************************************************** *** 
echo ***   Error - Unprocessed PostScript files waiting to be printed. End script   ***
echo *** ************************************************************************** ***
>> %sFTPLogB% echo .
>> %sFTPLogB% echo *** STEP2 ***
>> %sFTPLogB% echo *** ************************************************************************** *** 
>> %sFTPLogB% echo ***   Error - Unprocessed PostScript files waiting to be printed. End script   ***
>> %sFTPLogB% echo *** ************************************************************************** ***
goto :ERROR_STEP2

:FILE_EMPTY
echo .                                                           
echo *** STEP2 ***
echo *** ******************************************************************* ***
echo ***          All Mainframe PostScript files have been printed.          ***
echo ***    FTP folder Empty - No PostScript file waiting to be printed.     ***
echo ***                        Good continue script!                        ***
echo *** ******************************************************************* ***



rem STEP3
rem ===============================================
rem === Delete temp files if they already exist ===
rem ===============================================
echo .                                                           
echo *** STEP3 - Delete temp files from work directory ***
IF EXIST %Merged_Folder%\WNMPRT6*                 DEL %Merged_Folder%\WNMPRT6*
IF EXIST %PostScript_Folder%\*.ps                 DEL %PostScript_Folder%\*.ps



rem STEP4
rem ===========================================================
rem === - FTP GET PostScript files in to temp_to_Merg folder
rem ===========================================================

rem === Sets sFTP Output Log Paths ===
set sFTPLogA=%LOGPATH%\FTPLog_Detail%cdate%_%hhmmtime%.txt
set sFTPLogC=%LOGPATH%\FTPLog_MERG_GET_%cdate%_%hhmmtime%.txt

rem === Dynamically Creates Script 0.sftp with Date Variables                            ===
rem === open [(sftp|ftp|scp)://][userID[:password]@]host[:port]                          ===
rem ===    1. Special characters like '@' in the password need to be coded               ===
rem ===          with the Hexadecimal ASCII code value so the                            ===
rem ===               pwd: $M@rtc0mm becomes: pwd                               ===

> 0.ftp1 echo option batch on
>> 0.ftp1 echo option confirm off
>> 0.ftp1 echo open ftp://smartcomm:pwd@10.147.11.100:21
>> 0.ftp1 echo rm x_To_Merg/x_Merg_4_Oldest/*.ps
>> 0.ftp1 echo mv x_To_Merg/x_Merg_3/*.ps  x_To_Merg/x_Merg_4_Oldest/
>> 0.ftp1 echo mv x_To_Merg/x_Merg_2/*.ps  x_To_Merg/x_Merg_3/
>> 0.ftp1 echo mv x_To_Merg/x_Merg_1/*.ps  x_To_Merg/x_Merg_2/
>> 0.ftp1 echo mv x_To_Merg/x_Merg_0_Current/*.ps  x_To_Merg/x_Merg_1/
>> 0.ftp1 echo mv *.ps  x_To_Merg/x_Merg_0_Current/
>> 0.ftp1 echo get  x_To_Merg/x_Merg_0_Current/*.ps %MERGPATH%\temp_to_Merg\*
>> 0.ftp1 echo exit

rem == Run sFTP Script ===
echo .
echo *** STEP4
echo *** ******************************************************************************** ***
echo *** Running ftp GET (.ps) files and store them in a LOCAL MERG Folder:               ***
echo ***   D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders\temp_to_Merg   ***
echo *** ******************************************************************************** ***

>> %sFTPLogC% echo .
>> %sFTPLogC% echo *** STEP4 ***
>> %sFTPLogC% echo *** ******************************************************************************** ***
>> %sFTPLogC% echo *** Running ftp GET (.ps) files and store them in a LOCAL MERG Folder:               ***
>> %sFTPLogC% echo ***   D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders\temp_to_Merg   ***
>> %sFTPLogC% echo *** ******************************************************************************** ***

winscp.com /console /script=0.ftp1 > %sFTPLogC%
rem winscp.com /console /script=0.ftp1 /log=%sFTPLogA% > %sFTPLogC%

rem GOTO :EOF


rem STEP5
rem =======================================================
rem Setting Min and Max Merg file sizes
rem Run MERG script
rem =======================================================
echo .                                                     
echo *** STEP5 - Running MERG Script                   ***

set file="s####bdefault.ps"

rem ********************************
rem *** Max. Merge File Size
rem *** 400MB = 419430400 bytes
rem *** 425MB = 445644800 bytes
rem ********************************
set maxbytesize=445644800


rem ********************************
rem *** Min. Merge File Size
rem *** 150MB = 157286400 bytes
rem ********************************
set minbytesize=157286400


cd D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders

rem ===============================================
rem === Delete temp files if they already exist ===
rem ===============================================
IF EXIST %Merged_Folder%\WNMPRT6*                 DEL %Merged_Folder%\WNMPRT6*
rem IF EXIST %PostScript_Folder%\Merged_List.txt          DEL %PostScript_Folder%\Merged_List.txt
IF EXIST %MERGPATH%\tempWork_DIR_List.txt             DEL %MERGPATH%\tempWork_DIR_List.txt
IF EXIST %MERGPATH%\tempWork_gen_PSFileList.txt       DEL %MERGPATH%\tempWork_gen_PSFileList.txt
IF EXIST %MERGPATH%\tempWork_gen_ParsedPSFileList.txt DEL %MERGPATH%\tempWork_gen_ParsedPSFileList.txt

rem === Change to folder with PostScript file to be Merged ===
cd %PostScript_Folder%

rem === Create list of Files to be Merged ===
dir > %MERGPATH%\tempWork_DIR_List.txt

rem === Return to Home Directory ===
cd %MERGPATH%

rem === Filter List; find only PostScript ".ps" files, may contain Merged ".ps' files ===
find /i ".ps" < tempWork_DIR_List.txt > tempWork_gen_PSFileList1.txt

rem *******************************************************************************
rem *** Delete this Block- Arno 2016-04-22
rem === Filter out any "Merg" PostScript files ===
rem find /i /v "Merg" < tempWork_gen_PSFileList1.txt > tempWork_gen_PSFileList2.txt
rem *******************************************************************************

rem === Parse file to only list just the File names ===
for /f "tokens=5" %%i in ('find " " "tempWork_gen_PSFileList1.txt"') do (
    echo %%i >> tempWork_gen_ParsedPSFileList.txt
)

rem === Count the Number of list in the Parsed File List ===
setlocal EnableDelayedExpansion
set "cmd=findstr /R /N "^^" tempWork_gen_ParsedPSFileList.txt | find /C ":""
for /f %%a in ('!cmd!') do set number=%%a
  echo Row_Count_Number=%number%

cd %MERGPATH%


rem ============================
rem === SET COUNTER VARIABLE ===
rem ============================
set /a COUNTER=1
rem set /a COUNTER=%COUNTER%+1
echo SET COUNTER = %COUNTER%

setlocal enableextensions enabledelayedexpansion

rem === Empty Variable 'FirstLine' to null ===
set FirstLine=
echo FirstLine_Empty=%FirstLine%
echo Number=%number%

for /l %%x in (1, 1, %number%) DO (
rem for /l %%x in (1, 1, 6) DO (
  rem === Get First line in Input file ===
  set /p FirstLine=< !%MERGPATH%\tempWork_gen_ParsedPSFileList.txt!
  echo FirstLine=!FirstLine!
  echo COUNTER_COUNT=%%x

  rem === Merge the First (one) file to a WNMPRT6##.ps file ===
  type !PostScript_Folder!\!FirstLine! >> !Merged_Folder!\WNMPRT6!COUNTER!.ps

  rem === Create a List of PostScript files concatenated to which Merged File ===
  echo !FirstLine! Merged to ---^>  WNMPRT6!COUNTER!.ps >> !PostScript_Folder!\Merged_List_!cdate!_!hhmmtime!.txt

  rem === These steps Deletes the First Line in the file, it has already been Merged. ===
  rem === Skips line 1 and copies output to a temp file and then copies the updated file back to the original file ===
  more +1 !%MERGPATH%\tempWork_gen_ParsedPSFileList.txt! > !%MERGPATH%\tempWork_gen_ParsedPSFileList_copy.txt!
  type !%MERGPATH%\tempWork_gen_ParsedPSFileList_copy.txt! > !%MERGPATH%\tempWork_gen_ParsedPSFileList.txt!

  rem === Change to folder with PostScript file to be Merged ===
  cd !Merged_Folder!

  rem === Without usebackq, the ' quote means command and not string ===
  rem === IF Merged_size is '(LSS) Less Then' max_size ===
  rem ===                     LSS - less than
  rem ===                     LEQ - less than or equal
  rem ===                     GTR - greater than
  rem ===                     GEQ - greater than or equal
  rem ===                     EQU - equal
  rem ===                     NEQ - not equal
  FOR /F "usebackq" %%A IN ('!Merged_Folder!\WNMPRT6!COUNTER!.ps') DO set Merged_size=%%~zA
  if !Merged_size! LSS %maxbytesize% (
      echo WNMPRT6!COUNTER!.ps is ^< %maxbytesize% bytes
      echo WNMPRT6!COUNTER!.ps Merged File SIZE = !Merged_size!
      echo COUNTER = !COUNTER!
  ) ELSE (
      echo WNMPRT6!COUNTER!.ps is ^>= %maxbytesize% bytes
      echo WNMPRT6!COUNTER!.ps Merged File SIZE = !Merged_size!
      echo COUNTER = !COUNTER!
      set /a COUNTER+=1
      rem set /a COUNTER=COUNTER+1
      echo ...
      echo Updated COUNTER = !COUNTER!
  )

  rem === Get Next line in Input file ===
  set /p FirstLine=< !%MERGPATH%\tempWork_gen_ParsedPSFileList.txt!
  echo FirstLine=!FirstLine!
  echo COUNTER_COUNT=%%x

  rem === Without usebackq, the ' quote means command and not string ===
  rem === IF Merged_size is '(LSS) Less Then' max_size ===
  rem ===                     LSS - less than
  rem ===                     LEQ - less than or equal
  rem ===                     GTR - greater than
  rem ===                     GEQ - greater than or equal
  rem ===                     EQU - equal
  rem ===                     NEQ - not equal
  FOR /F "usebackq" %%A IN ('!PostScript_Folder!\!FirstLine!') DO set Input_File_size=%%~zA
  if !Input_File_size! LSS %minbytesize% (
     if !Merged_size! LSS %maxbytesize% (
        echo !FirstLine! is ^< %minbytesize% bytes
        echo !FirstLine! Next Input file SIZE = !Input_File_size!
        echo COUNTER = !COUNTER!
     )
  ) ELSE (
      echo !FirstLine! is ^>= %minbytesize% bytes
      echo !FirstLine! Next Input file SIZE = !Input_File_size!
      echo COUNTER = !COUNTER!
      set /a COUNTER+=1
      rem set /a COUNTER=COUNTER+1
      echo ...
      echo Updated COUNTER = !COUNTER!
  )
)



rem STEP6
rem =============================================================
rem Copy (FTP PUT) all PostScript files to EITS sFTP Print server
rem =============================================================
echo .
echo *** STEP6 FTP PUT PostScript files to FTP server  ***

cd D:\Batch_Jobs\SmartComm_NoticeBatch\Batch_Scripts

rem === Build ftp script to Move PostScript (.ps) files to a SUB-Folder 'temp_to_Print/' ===
rem === Dynamically Creates Script 0.sftp with Date Variables.                           ===
rem === open [(sftp|ftp|scp)://][userID[:password]@]host[:port]                          ===
rem ===    1. Special characters like '@' in the password need to be coded               ===
rem ===          with the Hexadecimal ASCII code value so the                            ===
rem ===               pwd: $M@rtc0mm becomes: pwd                               ===

> 0.ftp1 echo option batch on
>> 0.ftp1 echo option confirm off
>> 0.ftp1 echo open sftp://welfare@10.128.224.3:22 -privatekey=DWSS_EITS_Printer_Private_Key_RSA_2048.ppk -timeout=120
>> 0.ftp1 echo cd prod
>> 0.ftp1 echo put -nopreservetime D:\Batch_Jobs\SmartComm_NoticeBatch\Merg_PS_work_temp_folders\Merged\*.ps *
>> 0.ftp1 echo exit

rem == Run sFTP Script ===
echo .
echo *** FTP PUT STEP ***
echo *** *****************************************************************************  ***
echo *** Running ftp PUT (.ps) files to the FTP sub-forder:  temp_to_Print/* Folder     ***
echo *** ****************************************************************************** ***

set LOGPATH=D:\Batch_Jobs\SmartComm_NoticeBatch\Logs
set sFTPLogD=%LOGPATH%\FTPLog_MERG_PUT_%cdate%__%hhmmtime%.txt

>> %sFTPLogD% echo .
>> %sFTPLogD% echo *** FTP PUT STEP ***
>> %sFTPLogD% echo *** *****************************************************************************  ***
>> %sFTPLogD% echo *** Running ftp PUT (.ps) files to the FTP sub-forder:  temp_to_Print/* Folder     ***
>> %sFTPLogD% echo *** *****************************************************************************  ***

winscp.com /console /script=0.ftp1 >> %sFTPLogD%
rem winscp.com /console /script=0.ftp1 /log=%sFTPLogA% > %sFTPLogD%



rem STEP7
rem ===========================================================
rem CREATE TODAYS ARCHIVE FOLDER
rem ===========================================================
echo .
echo *** STEP7 Create Archive Folder

cd %MERGPATH%

mkdir %INPUT%\PRT6_%cdate%_%hhmmtime%
move %MERGPATH%\temp_to_Merg\*.ps %INPUT%\PRT6_%cdate%_%hhmmtime%\
move %MERGPATH%\temp_to_Merg\Merged_List_%cdate%_%hhmmtime%.txt %INPUT%\PRT6_%cdate%_%hhmmtime%\



rem ===========================================================
rem STEP8 through STEP10 Deleted - 06-28/2016 by Arno
rem ===========================================================



rem ==========================
rem === FTP Error Checking ===
rem ==========================

cd %LOGPATH%

rem === Checking SMARTCOMM ftp log for errors ===

echo .    >> %sFTPLogC%
echo ***  >> %sFTPLogC%
FIND "Network error" %sFTPLogC%
echo *** *************************************************** *** >> %sFTPLogC%
echo ***               FIND 'Network_error'                  *** >> %sFTPLogC%
echo ***              (0 = True, 1 = False)                  *** >> %sFTPLogC%
echo ***                 ERRORLEVEL = %ERRORLEVEL%                      *** >> %sFTPLogC%
echo *** *************************************************** *** >> %sFTPLogC%
if %ERRORLEVEL% NEQ 0 goto DID_NOT_FIND_NETWORK_ERROR
echo ***          Network Connection FAILD !!!               *** >> %sFTPLogC%
echo *** *************************************************** *** >> %sFTPLogC%
echo ***          Network Connection FAILD !!!               ***
echo *** *************************************************** ***
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\SMARTCOMM_FTP_NETWORK_FAILURE.txt -subject "SmartComm PROD Error - FTP Network Failure***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
goto EOF

:DID_NOT_FIND_NETWORK_ERROR
:DID_NOT_FIND_CONNECTION_ERROR
echo ***        Network Connect Found - TCP/IP Good          *** >> %sFTPLogC%
echo *** *************************************************** *** >> %sFTPLogC%
echo ***        Network Connect Found - TCP/IP Good          ***
echo *** *************************************************** ***

echo .    >> %sFTPLogC%
FIND "Authentication failed" %sFTPLogC%
echo *** *************************************************** *** >> %sFTPLogC%
echo ***               FIND 'Access_denied'                  *** >> %sFTPLogC%
echo ***              (0 = True, 1 = False)                  *** >> %sFTPLogC%
echo ***                 ERRORLEVEL = %ERRORLEVEL%                      *** >> %sFTPLogC%
echo *** *************************************************** *** >> %sFTPLogC%
if %ERRORLEVEL% NEQ 0 goto DID_NOT_FIND_ACCESS_DENIED
echo ***           ACCESS DENIED!!!  CHECK PASSWORD!!!       *** >> %sFTPLogC%
echo *** *************************************************** *** >> %sFTPLogC%
echo ***           ACCESS DENIED!!!  CHECK PASSWORD!!!       ***
echo *** *************************************************** ***
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\SMARTCOMM_FTP_LOGON_FAILURE.txt -subject "SmartComm PROD Error - FTP LOGON Failure***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
goto EOF

:DID_NOT_FIND_ACCESS_DENIED
echo ***          Access Granted - Password Good             *** >> %sFTPLogC%
echo *** *************************************************** *** >> %sFTPLogC%
echo ***          Access Granted - Password Good             ***
echo *** *************************************************** ***


rem === Delay 5 seconds to make sure the ftp GET and then PUT output logs are listed in the correct order in the output folder ===
ping 127.0.0.1 -n 5 -w 1000> nul


rem === Checking EITS Printer sftp log for errors ===

echo .    >> %sFTPLogD%
FIND "Connection failed" %sFTPLogD%
echo *** *************************************************** *** >> %sFTPLogD%
echo ***               FIND 'Connection_failed'              *** >> %sFTPLogD%
echo ***              (0 = True, 1 = False)                  *** >> %sFTPLogD%
echo ***                 ERRORLEVEL = %ERRORLEVEL%                      *** >> %sFTPLogD%
echo *** *************************************************** *** >> %sFTPLogD%
if %ERRORLEVEL% NEQ 0 goto DID_NOT_FIND_CONNECTION_ERROR
echo ***          Network Connection FAILD !!!               *** >> %sFTPLogD%
echo *** *************************************************** *** >> %sFTPLogD%
echo ***          Network Connection FAILD !!!               ***
echo *** *************************************************** ***
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\EITS_FTP_NETWORK_FAILURE.txt -subject "SmartComm PROD Error - FTP Network Failure***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
goto EOF

:DID_NOT_FIND_NETWORK_ERROR
:DID_NOT_FIND_CONNECTION_ERROR
echo ***        Network Connect Found - TCP/IP Good          *** >> %sFTPLogD%
echo *** *************************************************** *** >> %sFTPLogD%
echo ***        Network Connect Found - TCP/IP Good          ***
echo *** *************************************************** ***

echo .    >> %sFTPLogD%
FIND "Authentication failed" %sFTPLogD%
echo *** *************************************************** *** >> %sFTPLogD%
echo ***               FIND 'Access_denied'                  *** >> %sFTPLogD%
echo ***              (0 = True, 1 = False)                  *** >> %sFTPLogD%
echo ***                 ERRORLEVEL = %ERRORLEVEL%                      *** >> %sFTPLogD%
echo *** *************************************************** *** >> %sFTPLogD%
if %ERRORLEVEL% NEQ 0 goto DID_NOT_FIND_ACCESS_DENIED
echo ***           ACCESS DENIED!!!  CHECK PASSWORD!!!       *** >> %sFTPLogD%
echo *** *************************************************** *** >> %sFTPLogD%
echo ***           ACCESS DENIED!!!  CHECK PASSWORD!!!       ***
echo *** *************************************************** ***
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\EITS_FTP_LOGON_FAILURE.txt -subject "SmartComm PROD Error - FTP LOGON Failure***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
goto EOF

:DID_NOT_FIND_ACCESS_DENIED
echo ***          Access Granted - Password Good             *** >> %sFTPLogD%
echo *** *************************************************** *** >> %sFTPLogD%
echo ***          Access Granted - Password Good             ***
echo *** *************************************************** ***



rem STEP11
rem ===========================================================
rem Compress all the procced PostScript files on the LOCAL 
rem server for Archiving and then DELETE all the 
rem Non-Compressed (.ps) files.
rem ===========================================================

echo .
echo *** STEP11 ***
echo *** *********************************************************************** ***
echo *** Starting Compression (ZIP) Local PostScript (.ps) files for Archiving.  ***
echo *** *********************************************************************** ***

cd D:\Batch_Jobs\SmartComm_NoticeBatch\Batch_Scripts

rem === Compress (ZIP) Local PostScript (.ps) files for Archive ===
rem Compress in ZIP format the PostScript files into a 'PostScript_WNMPRT6.zip' file
rem Requires the '7z.exe' executable to be in the same folder as this batch script to run
rem Example commands - http://www.dotnetperls.com/7-zip-examples
7z a -tzip %INPUT%\PRT6_%cdate%_%hhmmtime%\PostScript_WNMPRT6.zip %INPUT%\PRT6_%cdate%_%hhmmtime%\*.ps

IF ERRORLEVEL 1 GOTO :ERROR_STEP11



rem === Delete non-compress/orginal Local PostScript (.ps) files ===
del %INPUT%\PRT6_%cdate%_%hhmmtime%\*.ps

GOTO :EOF



rem ===========================================================
rem ERROR EXITING LABELS
rem ===========================================================

:ERROR_STEP1
echo ERROR_STEP1 - Listing the PostScript files in the ftp SUB-Folder "temp_to_Print/" failed.
echo               EXITING SCRIPTED!!!
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\SMARTCOMM_LIST_FILES.txt -subject "SmartComm PROD Error - Listing the PostScript files in the ftp SUB-Folder temp_to_Print/ failed ***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
GOTO :EOF

:ERROR_STEP2
echo ERROR_STEP2 - Unprocessed Mainframe PostScrip files waiting to be processed in SUB-Folder.
echo               EXITING SCRIPTED!!!
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\SMARTCOMM_UNPROCESSED_NOTICES.txt -subject "SmartComm PROD Error - Unprocessed PostScript files waiting to be printed***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
GOTO :EOF

:ERROR_STEP8
echo ERROR_STEP8 - Ftp Moving the (.ps) files to the ftp sites SUB-folder or doing the ftp GET of the PostScript files failed.
echo               EXITING SCRIPTED!!!
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\SMARTCOMM_MOVE_GET_FILES.txt -subject "SmartComm PROD Error - Ftp Moving the (.ps) files or ftp GET PostScript files failed***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
GOTO :EOF

:ERROR_STEP9
echo ERROR_STEP9 - Parse the file to list only the PostScript (.ps) failed.
echo               EXITING SCRIPTED!!!
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\SMARTCOMM_PARSE_FILES_LISTING.txt -subject "SmartComm PROD Error - Parse the file to list only the PostScript (.ps) failed***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
GOTO :EOF

:ERROR_STEP10
echo ERROR_STEP10 - RENAME PostScript (.ps) files in the SUB-Folder for the mainframe batch to process failed.
echo               EXITING SCRIPTED!!!
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\SMARTCOMM_RENAME_POSTSCRIPT_FILES.txt -subject "SmartComm PROD Error - RENAMING the PostScript (.ps) files in the ftp SUB-Folder temp_to_Print/ failed***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
GOTO :EOF

:ERROR_STEP11
echo ERROR_STEP11 - 7zip Compress failed
%BINPATH%\MAILTOOL D:\Batch_Jobs\email_scripts\SMARTCOMM_ZIP_POSTSCRIPT_FILES.txt -subject "SmartComm PROD Error - 7zip Compression of the PostScript (.ps) files failed***" -tf D:\Batch_Jobs\email_scripts\DBA_EMAIL_Arno.LST -f db2admin@dwss.nv.gov -org "Nevada State Welfare Division" -server smtp.dwss.nv.gov
echo               EXITING SCRIPTED!!!

:EOF

cd D:\Batch_Jobs\SmartComm_NoticeBatch\Batch_Scripts

:: DONE

rem --- END ---

