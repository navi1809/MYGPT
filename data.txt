
=========================

AME62A


WITH SQ1 AS (
    SELECT 
        TRIM(ALT_PYE_LST_NM) || ' ' || TRIM(ALT_PYE_FRST_NM) || ' ' || TRIM(ALT_PYE_MID_NM) || ' ' || TRIM(ALT_PYE_MODFR) AS CASE_NAME,
        ICI,
        ALT_PYE_TYP
    FROM 
        {?SCHEMA}.TWNFAM_ALT_PAYEE T1
    WHERE
        EFF_FR_DT <= LAST_DAY({?DATE}) AND 
        EFF_TO_DT >= LAST_DAY({?DATE})
),
SQ2 AS (
    SELECT 
        T1.HH_LEFT_RSN_CD,
        T1.ICI,
        T1.UPI,
        TRIM(T2.LST_NM) || ' ' || TRIM(T2.FRST_NM) || ' ' || TRIM(T2.MID_NM) || ' ' || TRIM(T2.MODFR) AS CASE_NAME
    FROM 
        {?SCHEMA}.TWNCASE_MEMBER_HST T1
    JOIN 
        {?SCHEMA}.TWNPERSON T2 ON T2.UPI = T1.UPI
    WHERE
        T1.HH_LEFT_RSN_CD = '' AND
        T1.PRD_BEG_DT <= LAST_DAY({?DATE}) AND
        T1.PRD_END_DT >= LAST_DAY({?DATE})
),
SQ3 AS (
    SELECT 
        DISTINCT 
        TRIM(T2.LST_NM) || ' ' || TRIM(T2.FRST_NM) || ' ' || TRIM(T2.MID_NM) || ' ' || TRIM(T2.MODFR) AS CASE_NAME,
        T1.APPL_UPI,
        T1.ICI
    FROM 
        {?SCHEMA}.TWNFAM_CASE_HSTRY T1
    JOIN 
        {?SCHEMA}.TWNPERSON T2 ON T1.APPL_UPI = T2.UPI
    JOIN 
        {?SCHEMA}.TWNCASE_MEMBER_HST T3 ON T3.UPI = T2.UPI
    WHERE
        T3.HH_LEFT_RSN_CD <> ''
),
SQ4 AS (
    SELECT 
        HOUSE_NMB || ' ' || STR_DIR || ' ' || STR_NM || ' ' || STR_TYPE || ' ' || APT_NMB || ' ' || OTH_ADDR AS CASE_MAIL1,
        CITY || ' ' || ST_CD || ' ' || ZIP_CD AS CASE_MAIL2,
        PRD_BEG_TS,
        CITY,
        UPI,
        ADR_TYPE
    FROM 
        {?SCHEMA}.TWNPERSON_ADRS_HST T1
    WHERE
        ADR_TYPE IN ('CM', 'MA')
    ORDER BY 
        PRD_BEG_TS DESC
),
SQ5 AS (
    SELECT 
        HOUSE_NMB || ' ' || STR_DIR || ' ' || STR_NM || ' ' || STR_TYPE || ' ' || APT_NMB || ' ' || OTH_ADDR AS CASE_RES1,
        CITY || ' ' || ST_CD || ' ' || ZIP_CD AS CASE_RES2,
        PRD_BEG_TS,
        UPI,
        ADR_TYPE
    FROM 
        {?SCHEMA}.TWNPERSON_ADRS_HST T1
    WHERE
        ADR_TYPE IN ('CR', 'RA')
    ORDER BY 
        PRD_BEG_TS DESC
),
SQ6 AS (
    SELECT
        CASE 
            WHEN PRGM_CASE_STS IS NOT NULL AND PRGM_CASE_TYPE IS NOT NULL THEN ' '
        END AS FS_ONLY,
        ICI
    FROM 
        {?SCHEMA}.TWNPRGM_CASE_HSTRY T1
    WHERE
        PRD_BEG_DT <= LAST_DAY({?DATE}) AND 
        PRD_END_DT >= LAST_DAY({?DATE}) AND 
        PRGM_CASE_STS = 'O' AND 
        PRGM_CASE_TYPE <> 'FS'
),
SQ7 AS(
    SELECT 
        T1.ICI,
        T1.HOH_UPI,
        T1.RVW_SQ_NMB,
        T1.PSEQ_NMB,
        T1.QC_PRGM_CD,
        T1.OFC_CD,
        T1.AID_CD,
        T2.CNTY_CD,
        T3.SSN,
        T1.SMPLE_MTH,
        T1.ACTN_TYP_CD, 
        T1.PRGM_EFF_DT, 
        T1.STS_EFF_DT
    FROM 
        {?SCHEMA}.TWNNGTV_QC_SMPLE T1
    JOIN 
        {?SCHEMA}.TWNOFFICE T2 ON T1.OFC_CD = T2.OFC_CD
    JOIN 
        {?SCHEMA}.TWNPERSON T3 ON T1.HOH_UPI = T3.UPI
    WHERE
        T1.SMPLE_MTH = MONTH({?DATE}) AND 
        T1.SMPLE_YR = YEAR({?DATE}) AND 
        T1.QC_PRGM_CD = '16'
    ORDER BY
        T1.RVW_SQ_NMB
),
SQ8 AS(
    SELECT 
        ACTN_TYP, 
        DATE(ACTN_TS) AS ACTN_DATE,
        ICI
    FROM 
        {?SCHEMA}.TWNFAM_ACTNS T1
    WHERE
        ACTN_TYP IN ('TR', 'DN') AND 
        PRGM_TYP = 'FS' AND
        DATE(ACTN_TS) = (
            SELECT
                MAX(DATE(ACTN_TS))
            FROM
                {?SCHEMA}.TWNFAM_ACTNS T2
            WHERE
            	T2.ICI=T1.ICI AND
                DATE(T2.ACTN_TS) >= (DATE({?DATE}) - (DAYS({?DATE}) - 1) DAY) AND
                DATE(T2.ACTN_TS) <= LAST_DAY({?DATE}) AND 
                T2.ACTN_TYP IN ('TR', 'DN') AND 
                T2.PRGM_TYP = 'FS'
        )
),
SQ9 AS(
    SELECT 
        ACTN_TYP, 
        DATE(ACTN_TS) AS ACTN_DATE,
        ICI
    FROM 
        {?SCHEMA}.TWNFAM_ACTNS T1
    WHERE
        ACTN_TYP = 'RA' AND 
        PRGM_TYP = 'FS' AND 
        AID_CD = 'FS' AND 
        ACTN_RSN_CD = ' ' AND 
        DATE(ACTN_TS) = (
            SELECT
                MAX(DATE(ACTN_TS))
            FROM
                {?SCHEMA}.TWNFAM_ACTNS T2
            WHERE
            	T2.ICI=T1.ICI AND
                DATE(T2.ACTN_TS) >= (DATE({?DATE}) - (DAYS({?DATE}) - 1) DAY) AND 
                DATE(T2.ACTN_TS) <= LAST_DAY({?DATE}) AND 
                T2.ACTN_TYP = 'RA' AND 
                T2.PRGM_TYP = 'FS' AND 
                T2.AID_CD = 'FS' AND 
                T2.ACTN_RSN_CD = ' '
        )
),
SQ10 AS(
    SELECT 
        OFC_CD,
        ADR_LN1, 
        ADR_LN2, 
        CITY, 
        ST_CD, 
        ZIP_CD,
        OFC_NM, 
        CNTY_CD, 
        PYMT_ADR_LN1, 
        PYMT_ADR_LN2,
        PYMT_CITY, 
        PYMT_ZIP_CD, 
        INTRL_SRVC_DPT_IND,
        FIPS_CD, 
        FIPS_CD_SUFX, 
        PYMT_ST_CD,
        NON_AFDC_AMT, 
        AFDC_AMT, 
        OFC_TYP, 
        DCFS_AMT,
        PRNTR_ID, 
        SDU_OFC_CD, 
        SENT_DISB_OFC_CD
    FROM 
        {?SCHEMA}.TWNOFFICE T1
    WHERE 
        (OFC_CD >= 'AA' AND OFC_CD <= 'ZZ')
),
SQ11 AS(
SELECT 
        DISTINCT 
        T1.APPL_UPI,
        T1.ICI
    FROM 
        {?SCHEMA}.TWNFAM_CASE_HSTRY T1
    JOIN 
        {?SCHEMA}.TWNPERSON T2 ON T1.APPL_UPI = T2.UPI
),
SQ12 AS(
SELECT 
	INTRV,
	RNDM_STRT_NMB
FROM 
	{?SCHEMA}.TWNSMPL_INTRV_DTLS T1
WHERE
	T1.QC_PRGM_TYPE = '6' AND 
	T1.SMPLE_TYPE = '1' AND 
	T1.SMPLE_YR = YEAR({?DATE}) AND 
	T1.SMPLE_MTH = MONTH({?DATE}) AND 
	T1.STRTM_NMB =(
					SELECT
						MAX(STRTM_NMB)
					FROM
						{?SCHEMA}.TWNSMPL_INTRV_DTLS T2
					WHERE
						T2.QC_PRGM_TYPE = '6' AND 
						T2.SMPLE_TYPE = '1' AND 
						T2.SMPLE_YR = YEAR({?DATE}) AND 
						T2.SMPLE_MTH = MONTH({?DATE}))
)
SELECT
	DISTINCT
	COALESCE(SQ12.INTRV,0) AS INTRV,
	COALESCE(SQ12.RNDM_STRT_NMB,0) AS START,
    SQ10.OFC_CD,
    SQ10.OFC_NM,
    SQ10.CITY,
    SQ7.PSEQ_NMB AS PSEQ,
    '4'||RIGHT('00'|| CAST(SQ7.SMPLE_MTH AS VARCHAR(2)),2)||RIGHT('000'|| CAST(MOD(SQ7.RVW_SQ_NMB,1000) AS VARCHAR(3)),3) AS REV,
    SQ7.SSN,
    SQ7.CNTY_CD,
    COALESCE(SQ1.CASE_NAME, SQ2.CASE_NAME, SQ3.CASE_NAME) AS CASE_NAME,
    SQ4.CASE_MAIL1,
    SQ4.CASE_MAIL2,
    SQ5.CASE_RES1,
    SQ5.CASE_RES2,
    COALESCE(SQ6.FS_ONLY,'X') AS FS_ONLY,
    CASE 
        WHEN SQ7.ACTN_TYP_CD IN (0,1,2) THEN SQ8.ACTN_TYP
        WHEN SQ7.ACTN_TYP_CD = 3 THEN 'RC'
        WHEN SQ7.ACTN_TYP_CD = 5 THEN 'SU'
    END AS ACTN,
    CASE 
        WHEN SQ7.ACTN_TYP_CD IN (0,1,2) THEN SQ8.ACTN_DATE
        WHEN SQ7.ACTN_TYP_CD = 3 THEN SQ9.ACTN_DATE
        WHEN SQ7.ACTN_TYP_CD = 5 THEN 
            CASE 
                WHEN SQ7.STS_EFF_DT IS NULL AND SQ7.PRGM_EFF_DT IS NULL THEN NULL
                WHEN SQ7.PRGM_EFF_DT IS NOT NULL AND SQ7.STS_EFF_DT IS NULL THEN SQ7.PRGM_EFF_DT
                WHEN SQ7.STS_EFF_DT IS NOT NULL AND SQ7.PRGM_EFF_DT IS NULL THEN SQ7.STS_EFF_DT
                ELSE SQ7.STS_EFF_DT
            END
    END AS ACTN_DATE
FROM SQ10
LEFT JOIN SQ12 ON 1=1
LEFT JOIN SQ7 ON SQ7.OFC_CD = SQ10.OFC_CD
LEFT JOIN SQ11 ON SQ11.ICI=SQ7.ICI
LEFT JOIN SQ6 ON SQ6.ICI = SQ7.ICI
LEFT JOIN SQ8 ON SQ8.ICI = SQ7.ICI
LEFT JOIN SQ9 ON SQ9.ICI = SQ7.ICI
LEFT JOIN SQ1 ON SQ1.ICI = SQ7.ICI
LEFT JOIN SQ2 ON SQ2.ICI = SQ7.ICI AND SQ2.UPI=SQ7.HOH_UPI
LEFT JOIN SQ3 ON SQ3.ICI = SQ7.ICI 
LEFT JOIN SQ4 ON SQ4.UPI = SQ11.APPL_UPI
LEFT JOIN SQ5 ON SQ5.UPI = SQ11.APPL_UPI
ORDER BY REV

============

AME46A
WITH SQ1 AS(
SELECT 
	T1.OFC_CD, 
	T1.OFC_NM
FROM 
	{?SCHEMA}.TWNOFFICE T1
WHERE
	T1.OFC_TYP = 'A'
ORDER BY 
	T1.OFC_NM
),
SQ2 AS(
SELECT 
	T1.OFC_CD,
	COUNT(*) AS AG_COUNT
FROM 
	{?SCHEMA}.TWNFAM_CASELD_CASE T1,
    {?SCHEMA}.TWNFAM_CASE_HSTRY T2,
    {?SCHEMA}.TWNPERSON T3,
    {?SCHEMA}.TWNPRGM_CASE_HSTRY T4
WHERE
	DAYS(LAST_DAY({?DATE}))-DAYS(T4.APPL_DT)>45 AND
	T3.UPI = T2.HOH_UPI AND
	T4.ICI = T1.ICI AND
	T2.ICI = T4.ICI AND
	T4.PRGM_CASE_TYPE = 'MA' AND
	T4.AID_CD LIKE ('%1') AND
	T4.PRGM_CASE_STS = 'P' AND
	T4.STS_EFF_DT <  DATE(LAST_DAY({?DATE}) - 45 DAYS) AND
	T4.PRD_BEG_DT <= LAST_DAY({?DATE}) AND
	T4.PRD_END_DT >= LAST_DAY({?DATE}) AND
	T2.PRD_BEG_DT <= LAST_DAY({?DATE}) AND
	T2.PRD_END_DT >= LAST_DAY({?DATE})
GROUP BY T1.OFC_CD
),
SQ3 AS (
SELECT
	T1.OFC_CD,
	COUNT(*) AS BL_COUNT
FROM 
	{?SCHEMA}.TWNFAM_CASELD_CASE T1,
    {?SCHEMA}.TWNFAM_CASE_HSTRY T2,
    {?SCHEMA}.TWNPERSON T3,
    {?SCHEMA}.TWNPRGM_CASE_HSTRY T4
WHERE
	DAYS(LAST_DAY({?DATE}))-DAYS(T4.APPL_DT)>90 AND
	T4.ICI = T1.ICI AND
	T2.ICI = T4.ICI AND
	T3.UPI = T2.HOH_UPI AND
	T4.PRGM_CASE_TYPE = 'MA' AND
	(T4.AID_CD LIKE ('%3') OR T4.AID_CD LIKE ('%9')) AND
	T4.PRGM_CASE_STS = 'P' AND
	T4.STS_EFF_DT <= DATE(LAST_DAY({?DATE}) - 90 DAYS) AND
	T4.PRD_BEG_DT <= LAST_DAY({?DATE}) AND
	T4.PRD_END_DT >= LAST_DAY({?DATE}) AND
	T2.PRD_BEG_DT <= LAST_DAY({?DATE}) AND
	T2.PRD_END_DT >= LAST_DAY({?DATE})
GROUP BY T1.OFC_CD	
),
SQ4 AS(
SELECT 
	T1.OFC_CD,
	COUNT(*) AS TA_COUNT
FROM 
	{?SCHEMA}.TWNFAM_CASELD_CASE T1,
	{?SCHEMA}.TWNFAM_CASE_HSTRY T2,
	{?SCHEMA}.TWNPERSON T3,
	{?SCHEMA}.TWNPRGM_CASE_HSTRY T4
WHERE
	DAYS(LAST_DAY({?DATE}))-DAYS(T4.APPL_DT)>45 AND
	T3.UPI = T2.HOH_UPI AND
	T4.ICI = T1.ICI AND
	T2.ICI = T4.ICI AND
	T4.PRGM_CASE_TYPE IN ('AF', 'TC', 'TL', 'TN', 'TP', 'SG') AND
	T4.PRGM_CASE_STS = 'P' AND
	T4.STS_EFF_DT <= DATE(LAST_DAY({?DATE}) - 45 DAYS) AND
	T4.PRD_BEG_DT <= LAST_DAY({?DATE}) AND
	T4.PRD_END_DT >= LAST_DAY({?DATE}) AND
	T2.PRD_BEG_DT <= LAST_DAY({?DATE}) AND
	T2.PRD_END_DT >= LAST_DAY({?DATE}) AND
	T4.AID_CD > ' '
GROUP BY T1.OFC_CD	
),
FQ AS(
SELECT 
DISTINCT 
SQ1.OFC_NM,
SQ1.OFC_CD
FROM 
SQ1,SQ2,SQ3,SQ4
WHERE SQ2.OFC_CD=SQ1.OFC_CD OR SQ3.OFC_CD=SQ1.OFC_CD OR SQ4.OFC_CD=SQ1.OFC_CD
ORDER BY OFC_NM
)
SELECT 
FQ.OFC_NM,
COALESCE (SQ2.AG_COUNT,0) AS AG_COUNT,
COALESCE (SQ3.BL_COUNT,0) AS BL_COUNT,
COALESCE (SQ4.TA_COUNT,0) AS TA_COUNT,
SUM(COALESCE (SQ2.AG_COUNT,0)+COALESCE (SQ3.BL_COUNT,0)+COALESCE (SQ4.TA_COUNT,0)) OVER() NO_DATA
FROM 
FQ 
LEFT JOIN SQ2 ON SQ2.OFC_CD=FQ.OFC_CD
LEFT JOIN SQ3 ON SQ3.OFC_CD=FQ.OFC_CD
LEFT JOIN SQ4 ON SQ4.OFC_CD=FQ.OFC_CD

================

AFR63A

WITH SQ1 AS(
SELECT WRNT_SEQ_NMB, OFC_CD,
	WRNT_STS_CD,
	WRNT_ISD_DT,
	WRNT_STS_EFF_DT,
	WRNT_AMT,
	ICI,
	WRNT_PRNT_DT,
	FUND_SRCE_TYPE,
	CASE WHEN FUND_SRCE_TYPE='RG' THEN 1 END AS RG,
	CASE WHEN FUND_SRCE_TYPE='SP' THEN 1 END AS SP,
	CASE WHEN FUND_SRCE_TYPE='FD' THEN 1 END AS FD,
	ISS_MTD
FROM 
	{?SCHEMA}.TWNAFDC_WRNT T1
WHERE
	WRNT_STS_CD IN ('IS') AND   
	ISS_MTD  = 'E' AND 
	WRNT_PRNT_DT <= (DATE({?DATE}) + 1 DAY) AND 
	WRNT_STS_EFF_DT >(DATE({?DATE}) + 1 DAY)
ORDER BY 
WRNT_PRNT_DT,ICI
),
SQ2 AS(
SELECT 
	TRIM(T1.FRST_NM)||' '||TRIM(T1.MID_NM)||' '||TRIM(T1.MODFR)||' '||TRIM(T1.LST_NM) AS CASE_NAME,
	T1.SSN,
	T2.HMLS_IND,
	T2.ICI
FROM 
	{?SCHEMA}.TWNPERSON T1,
	{?SCHEMA}.TWNFAM_CASE_HSTRY T2
WHERE
	T1.UPI = T2.HOH_UPI AND 
	T2.PRD_END_DT   = '9999-12-31'
),
SQ3 AS(
SELECT 
COUNT(SQ1.RG) AS RG,
COUNT(SQ1.SP) AS SP,
COUNT(SQ1.FD) AS FD,
COUNT(SQ1.WRNT_AMT) AS CASES,
SUM(SQ1.WRNT_AMT) AS TOTAL
FROM SQ1
)
SELECT
	RIGHT('000000000' ||SQ1.WRNT_SEQ_NMB, 9) AS ISSUANCE_NUMBER,
	SQ1.WRNT_PRNT_DT AS ISSUANCE_DATE,
	SQ2.SSN AS CASE,
	SQ2.ICI AS EBT_ICI,
	SQ2.CASE_NAME,
	SQ1.OFC_CD AS DIST,
	SQ1.WRNT_STS_EFF_DT AS AVAIL_DATE,
	SQ1.WRNT_AMT AS TOTAL_FUND,
	SQ3.CASES,
	SQ3.RG,
	SQ3.SP,
	SQ3.FD,
	SQ3.TOTAL
FROM SQ1,SQ2,SQ3
WHERE SQ2.ICI=SQ1.ICI
ORDER BY 
WRNT_PRNT_DT,SQ2.ICI

==============

AFR51A

WITH SQ1 AS (SELECT T2.ICI,
        T2.CYCLE_PRD_DT,
        T2.ISNCE_NMB,
        T2.FS_ISNCE_STS,
        T2.BNFT_AMT,
        T1.OFC_CD,
        T2.ISNCE_DT, 
        T2.ISNCE_MTHD
    FROM 
        {?SCHEMA}.TWNFAM_CASELD_CASE T1,
        {?SCHEMA}.TWNFS_ISNCE T2
    WHERE
        T2.ISNCE_MTHD = 'C'
        AND T2.FS_ISNCE_STS = 'RP'
        AND T1.ICI = T2.ICI
        AND T2.ISNCE_STS_EFF_DT >= (LAST_DAY({?DATE}) - 1 MONTH)
        AND T2.ISNCE_STS_EFF_DT <= {?DATE}
        AND T2.REISU_NMB = (
            SELECT 
                T3.ISNCE_NMB
            FROM
                {?SCHEMA}.TWNFS_ISNCE T3
            WHERE
                T3.ISNCE_MTHD = 'E' 
                AND T2.REISU_NMB = T3.ISNCE_NMB
        )
),
SQ2 AS (
    SELECT 
        TRIM(T1.FRST_NM) || ' ' || TRIM(T1.MID_NM) || ' ' || TRIM(T1.MODFR) || ' ' || TRIM(T1.LST_NM) AS CASE_NAME,
        T1.SSN,
        T2.HMLS_IND,
        T2.ICI,
        CASE WHEN T2.HMLS_IND = 'Y' THEN 1 END AS HMLS_CNT
    FROM 
        {?SCHEMA}.TWNPERSON T1,
        {?SCHEMA}.TWNFAM_CASE_HSTRY T2
    WHERE
        T1.UPI = T2.HOH_UPI 
        AND (YEAR(T2.PRD_BEG_DT) < YEAR({?DATE}) OR (YEAR(T2.PRD_BEG_DT) = YEAR({?DATE}) AND MONTH(T2.PRD_BEG_DT) <= MONTH({?DATE})))
        AND (YEAR(T2.PRD_END_DT) > YEAR({?DATE}) OR (YEAR(T2.PRD_END_DT) = YEAR({?DATE}) AND MONTH(T2.PRD_END_DT) >= MONTH({?DATE})))
)
SELECT 
    SQ2.CASE_NAME,
    RIGHT('000000000' || SQ2.SSN,9) AS CASE,
    RIGHT('000000000' || SQ2.ICI,9) AS EBT_ICI,
    SQ1.CYCLE_PRD_DT AS CYCLE_DATE,
    RIGHT('000000000' || SQ1.ISNCE_NMB,9) AS CCSI_ISS_NUMBER,
    SQ1.OFC_CD AS DIST,
    SQ1.ISNCE_DT AS ISSUANCE_DATE,
    SQ2.HMLS_IND AS HOME_LESS,
	SQ1.BNFT_AMT AS TOTAL,
    SUM(COUNT(SQ2.HMLS_CNT)) OVER() AS TOT_HMLS,
    COUNT(COUNT(SQ2.ICI)) OVER() AS TOT_CS,
    SUM(SUM(SQ1.BNFT_AMT)) OVER() AS TOT_AMT
FROM 
    SQ1, SQ2
WHERE 
    SQ2.ICI = SQ1.ICI
GROUP BY 
    SQ2.CASE_NAME,
    SQ2.SSN,
    SQ2.ICI,
    SQ1.CYCLE_PRD_DT,
    SQ1.ISNCE_NMB,
    SQ1.OFC_CD,
    SQ1.ISNCE_DT, SQ2.HMLS_IND, SQ1.BNFT_AMT, SQ2.HMLS_CNT