package IVA_Batch;
import egl.core.*;
import CommonMigratedParts.*;
import DataTables.*;
//*** PROGRAM=AIF34A ****
// COMPONENT NAME: AIF34A TOP COLLECTIONS
// ===============
// 
// DESCRIPTION:
// ============
// COLLECTIONS AND REVERSALS RECEIVED FROM FNS VIA DIRECT
// CONNECT.  CREATE TRANSACTIONS IN TWNRPM-AUDIT-TRAIL AND
// TWNDEBT-TOP-COLL, AND AN ACTIVITY REPORT.
// 
// 
// ***********************
Program AIF34A type basicProgram //VAGen Info - main batch program
  {
  includeReferencedFunctions = yes, allowUnqualifiedItemReferences = yes, 
  throwNrfEofExceptions = yes, handleHardIOErrors = no, V60ExceptionCompatibility = yes, 
  I4GLItemsNullable = no, textLiteralDefaultIsString = no, localSQLScope = yes
  }

  // Data Declarations
  AIF34W AIF34W; // record
  AIF34W-DET AIF34W-DET; // record
  AIF34W-HEAD AIF34W-HEAD; // record
  AIF34W-TOTAL AIF34W-TOTAL; // record
  AIF34W2 AIF34W2; // record
  CEP01W CEP01W; // record
  FORMATW FORMATW; // record
  GDW GDW; // record
  H2-3-DMQDRP-DEB H2-3-DMQDRP-DEB; // record
  H2-DBT-MTHLY-STATS H2-DBT-MTHLY-STATS; // record
  H2-DEBT H2-DEBT; // record
  H2-DEBT-MATCH-REQ H2-DEBT-MATCH-REQ; // record
  H2-DEBT-TOP-COLL H2-DEBT-TOP-COLL; // record
  H2-RPM-AUDIT-TRAIL H2-RPM-AUDIT-TRAIL; // record
  REP-COMMON REP-COMMON; // record
  REP-EOFNOF REP-EOFNOF; // record
  SR-132REP-RECOUT SR-132REP-RECOUT; // record
  SR-AIF34-CNTL SR-AIF34-CNTL; // record
  SR-AIF34-COLL SR-AIF34-COLL; // record
  SR-AIF34-INREC SR-AIF34-INREC; // record
  VDBCOMMON VDBCOMMON; // record
  VDBCONTROL VDBCONTROL; // record
  VMESSAGE VMESSAGE; // record
  VSTRREC4 VSTRREC4; // record

  // VAGen Info - items needed for migration
  VAGen_EZESYS char(8);
  VAGen_EZEREPLY num(1);
  VAGen_EZE_WAIT_TIME bin(9,2);
  VAGen_EZE_ITEMLEN int;

  // Use Declarations
  use VDB00T1 {deleteAfterUse = yes}; // table

  function main()
    // VAGen Info - initialization needed for migration
    VAGen_EZESYS = VGLib.getVAGSysType();
    AIF34P8-MAIN: AIF34P8-MAIN();
  end // end main
end // end AIF34A


// MAIN PROCESS
Function AIF34P8-MAIN()
  AIF34P9-INIT-PARA();

  AIF34Q1-READIP();

  if (SR-AIF34-INREC is endOfFile)
    sysVar.returnCode = 8;
    VMESSAGE.UMSGCODE-JCL-ERR = 0;
    AIF34W.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = AIF34W.WS-ERR-LAST-FOUR;
    WCM00P2-TO-CEP01A();
  end

  AIF34P9-PRN-HEAD();

  while (SR-AIF34-INREC not endOfFile)
    AIF34P9-APPLSPEC();
    AIF34Q1-READIP();
  end

  AIF34P9-PROC-TOTAL();

  AIF34W.WS-REM-LINES = REP-COMMON.WS-MAX-NO-LINES - REP-COMMON.WS-LINE-NO;
  if (AIF34W.WS-REM-LINES < 2)
    AIF34P9-PRN-HEAD();
  end

  /* print end of report*/
  REP132P9-EOR-PROC();

  AIF34Q8-CLOSE-RPT();
  AIF34Q8-CLOSE-SR();
  exit program;
end // end AIF34P8-MAIN


// application specific processin
Function AIF34P9-APPLSPEC()
  if (SR-AIF34-INREC.CNTL-ID == "CNTL")
    return;
  end
  move SR-AIF34-INREC to SR-AIF34-COLL withV60Compat;

  set H2-3-DMQDRP-DEB empty;
  H2-3-DMQDRP-DEB.DEBT-YR = SR-AIF34-COLL.DBT-YR;
  H2-3-DMQDRP-DEB.DEBT-SQ-NMB = SR-AIF34-COLL.DBT-SQ-NMB;
  H2-3-DMQDRP-DEB.SSN = SR-AIF34-COLL.SSN;
  AIF34Q1-DMQDRP-DEB();

  if (VDBCONTROL.URC != 0)
  	  AIF34W.WS-TOP-ERR = "Y";
  	  AIF34P9-PROC-REPT();  	  
      return;
  end
  
  AIF34W.WS-TOP-ERR = "N";

  AIF34W.WS-NET-OFFSET = SR-AIF34-COLL.COLL-AMT - SR-AIF34-COLL.TOTAL-FEE-AMT;

  AIF34P9-PROC-DEBT();

  AIF34P9-PROC-RPM();

  /* LL EZECOMIT;*/

  AIF34P9-PROC-COLL();

  if (H2-DEBT.DEBT-BAL-AMT == 0)
    set H2-DEBT-MATCH-REQ empty;
    H2-DEBT-MATCH-REQ.DEBT-YR = H2-3-DMQDRP-DEB.DEBT-YR;
    H2-DEBT-MATCH-REQ.DEBT-SQ-NMB = H2-3-DMQDRP-DEB.DEBT-SQ-NMB;
    H2-DEBT-MATCH-REQ.UPI = H2-3-DMQDRP-DEB.UPI;
    H2-DEBT-MATCH-REQ.TOPS-CHANGE-IND = "I";
    AIF34Q5-UPD-DMQ();
  end

  /* LL EZECOMIT;*/

  AIF34P9-PROC-REPT();
end // end AIF34P9-APPLSPEC


// PROCESS TO FORMAT AMOUNTS
Function AIF34P9-FMT-AMT()
  set FORMATW empty;
  if (AIF34W2.WS-AMOUNT < 0)
    AIF34W2.WS-AMOUNT = AIF34W2.WS-AMOUNT * (-1);
    FORMATW.DOLLAR-FLAG = "S";
  end
  FORMATW.INPUT-NUMBER = AIF34W2.WS-AMOUNT;

  if (FORMATW.INPUT-NUMBER != 0)
    FORMATW.LENGTH = 11;
    FORMATW.DEC-COUNT = 2;
    FORMATW.FORMAT-FLAG = "N";
    REPP9-FORMAT-PROC();
  else
    FORMATW.OUTPUT-CHAR = "       0.00";
  end
end // end AIF34P9-FMT-AMT


// PROCESS TO FORMAT NUMBERS
Function AIF34P9-FMT-CNT()
  set FORMATW empty;
  FORMATW.INPUT-NUMBER = AIF34W2.WS-COUNT;
  if (FORMATW.INPUT-NUMBER != 0)
    FORMATW.LENGTH = 5;
    FORMATW.DEC-COUNT = 0;
    FORMATW.FORMAT-FLAG = "N";
    REPP9-FORMAT-PROC();
  else
    FORMATW.OUTPUT-CHAR = "    0";
  end
end // end AIF34P9-FMT-CNT


// INTIALISE ALL VARIABLES
Function AIF34P9-INIT-PARA()
  /* set all report variables to initial values*/
  /* ws-page-no      - current printing page number*/
  /* ws-line-no      - current page line no*/
  /* ws-new-page     - a new page indicator*/
  /* ws-max-no-lines - lineage for a standard report frame*/

  VGVar.handleHardIOErrors = 1;
  REP-COMMON.WS-PAGE-NO = 0;
  REP-COMMON.WS-LINE-NO = 1;
  REP-COMMON.WS-NEW-PAGE = "Y";
  REP-COMMON.WS-MAX-NO-LINES = 56;

  /* set standard header variables*/

  AIF34P9-INITCON();

  call "DATEAPP" (GDW, VDBCONTROL, VMESSAGE) {isNoRefresh = yes};
  REP-COMMON.WS-DT = GDW.DTL; /* current date*/
  REP-COMMON.WS-YEAR = REP-COMMON.WS-YY;
  REP-COMMON.WS-MONTH = REP-COMMON.WS-MM;
  REP-COMMON.WS-DAY = REP-COMMON.WS-DD;
  REP-COMMON.WS-F1 = "/";
  REP-COMMON.WS-F2 = "/";
  AIF34W-HEAD.UDATE = REP-COMMON.WS-DATE;
  AIF34W-HEAD.UTIME = VGVar.currentFormattedTime; /* current time*/
  AIF34W-HEAD.UAPPL = "AIF34A"; /* report name*/
  VDBCOMMON.UAPPLNAM = "AIF34A";

  AIF34W.WS-DT = GDW.DTL; /* current date*/
  AIF34W.WS-CURR-CCYY = AIF34W.WS-CCYY;
  AIF34W.WS-DASH1 = "-";
  AIF34W.WS-CURR-MM = AIF34W.WS-MM;
  AIF34W.WS-DASH2 = "-";
  AIF34W.WS-CURR-DD = AIF34W.WS-DD;
end // end AIF34P9-INIT-PARA


// INITIALISE CONSTANTS
Function AIF34P9-INITCON()
  set AIF34W-HEAD empty;
  AIF34W-HEAD.LINE1-PAGE-TEXT = "PAGE-NBR";
  AIF34W-HEAD.FILLER1 = " ";
  AIF34W-HEAD.FILLER2 = " ";
  AIF34W-HEAD.LINE1-STATE-TEXT = "STATE OF NEVADA";
  AIF34W-HEAD.FILLER3 = " ";
  AIF34W-HEAD.LINE1-DATE-TEXT = "DATE";
  AIF34W-HEAD.FILLER4 = " ";

  AIF34W-HEAD.FILLER5 = " ";
  AIF34W-HEAD.LINE2-RPT-NAME = "TREASURY OFFSET WEEKLY COLLECTIONS";
  AIF34W-HEAD.FILLER6 = " ";
  AIF34W-HEAD.LINE2-TIME-TEXT = "TIME";
  AIF34W-HEAD.FILLER7 = " ";

  AIF34W-HEAD.LINE3-1 = "DEBT #   SSN";
  AIF34W-HEAD.LINE3-2 = "LAST NAME";
  AIF34W-HEAD.LINE3-3 = "FIRST NAME";
  AIF34W-HEAD.LINE3-4 = "AMOUNT    DEBT BAL";
  AIF34W-HEAD.LINE3-5 = "TRACE NMB   CYCLE   OF-YR  EFFECTIVE";
end // end AIF34P9-INITCON


// PRINTS REPORT HEADER
Function AIF34P9-PRN-HEAD()
  REP-COMMON.WS-PAGE-NO = REP-COMMON.WS-PAGE-NO + 1;
  AIF34W-HEAD.UPAGE = REP-COMMON.WS-PAGE-NO;

  /* set carriage control flag for form feed if flag is set*/
  if (REP-COMMON.WS-PAGE-NO > 1)
    SR-132REP-RECOUT.PRNT-CC = "1";
  end

  /* move each line of header to map and print*/
  SR-132REP-RECOUT.UFIELD = AIF34W-HEAD.LINE1;
  WR-132REP-OUT-FILE();

  SR-132REP-RECOUT.PRNT-CC = " ";
  SR-132REP-RECOUT.UFIELD = AIF34W-HEAD.LINE2;
  WR-132REP-OUT-FILE();

  SR-132REP-RECOUT.PRNT-CC = "0";
  SR-132REP-RECOUT.UFIELD = AIF34W-HEAD.LINE3;
  WR-132REP-OUT-FILE();

  REP-COMMON.WS-LINE-NO = 4;
end // end AIF34P9-PRN-HEAD


// application specific processin
Function AIF34P9-PROC-COLL()
  set H2-DEBT-TOP-COLL empty;
  /* VE H2-RPM-AUDIT-TRAIL.RPM-ADT-TRL-TS*/
  H2-DEBT-TOP-COLL.RPM-ADT-TRL-TS = GDW.TS;
  H2-DEBT-TOP-COLL.DEBT-YR = H2-3-DMQDRP-DEB.DEBT-YR;
  H2-DEBT-TOP-COLL.DEBT-SQ-NMB = H2-3-DMQDRP-DEB.DEBT-SQ-NMB;
  H2-DEBT-TOP-COLL.UPI = H2-3-DMQDRP-DEB.UPI;
  H2-DEBT-TOP-COLL.SSN = SR-AIF34-COLL.SSN;
  H2-DEBT-TOP-COLL.OFFSET-NET-AMT = AIF34W.WS-NET-OFFSET;
  H2-DEBT-TOP-COLL.OFFSET-FEE-AMT = SR-AIF34-COLL.TOTAL-FEE-AMT;
  H2-DEBT-TOP-COLL.OFFSET-TRACE-NMB = SR-AIF34-COLL.TOP-TRACE-NMB;
  H2-DEBT-TOP-COLL.OFFSET-CYCLE-NMB = SR-AIF34-COLL.OFFSET-CYCLE;
  H2-DEBT-TOP-COLL.OFFSET-CCYY = SR-AIF34-COLL.OFFSET-CCYY;
  AIF34W.WS-DATE-CCYY = SR-AIF34-COLL.EFFECTIVE-CCYY;
  AIF34W.WS-DATE-MM = SR-AIF34-COLL.EFFECTIVE-MM;
  AIF34W.WS-DATE-DD = SR-AIF34-COLL.EFFECTIVE-DD;
  AIF34W.WS-DATE-FLR1 = "-";
  AIF34W.WS-DATE-FLR2 = "-";
  H2-DEBT-TOP-COLL.EFFECTIVE-DT = AIF34W.WS-DATE;
  H2-DEBT-TOP-COLL.JOINT-PAYEE-STS = SR-AIF34-COLL.JOINT-PAYEE-STS;
  H2-DEBT-TOP-COLL.REVRSL-IND = SR-AIF34-COLL.REVERSAL-IND;
  H2-DEBT-TOP-COLL.REVRSL-OFFSET-CCYY = SR-AIF34-COLL.ORIG-OFFSET-YR;
  H2-DEBT-TOP-COLL.NAME-CTL = SR-AIF34-COLL.TOP-NAME-CTL;
  H2-DEBT-TOP-COLL.LAST-NAME = SR-AIF34-COLL.LAST-NAME;
  H2-DEBT-TOP-COLL.FIRST-NAME = SR-AIF34-COLL.FIRST-NAME;
  H2-DEBT-TOP-COLL.ADDR-LINE1 = SR-AIF34-COLL.ADDR-LINE1;
  H2-DEBT-TOP-COLL.ADDR-LINE2 = SR-AIF34-COLL.ADDR-LINE2;
  H2-DEBT-TOP-COLL.ZIPCODE-1 = SR-AIF34-COLL.ZIPCODE-1;
  H2-DEBT-TOP-COLL.ZIPCODE-2 = SR-AIF34-COLL.ZIPCODE-2;
  H2-DEBT-TOP-COLL.COUNTRY-CD = SR-AIF34-COLL.COUNTRY-CD;
  AIF34Q5-INS-COLL();
end // end AIF34P9-PROC-COLL


// application specific processin
Function AIF34P9-PROC-DEBT()
  set H2-DEBT empty;
  H2-DEBT.DEBT-YR = H2-3-DMQDRP-DEB.DEBT-YR;
  H2-DEBT.DEBT-SQ-NMB = H2-3-DMQDRP-DEB.DEBT-SQ-NMB;
  if (SR-AIF34-INREC.RECORD-TYPE == "1")
    H2-3-DMQDRP-DEB.DEBT-BAL-AMT = H2-3-DMQDRP-DEB.DEBT-BAL-AMT
                                   - AIF34W.WS-NET-OFFSET;
  else
    H2-3-DMQDRP-DEB.DEBT-BAL-AMT = H2-3-DMQDRP-DEB.DEBT-BAL-AMT 
                                   + AIF34W.WS-NET-OFFSET;
  end

  H2-DEBT.DEBT-BAL-AMT = H2-3-DMQDRP-DEB.DEBT-BAL-AMT;

  H2-DEBT.DEBT-STS = H2-3-DMQDRP-DEB.DEBT-STS;
  H2-DEBT.DEBT-STS-EFF-DT = H2-3-DMQDRP-DEB.DEBT-STS-EFF-DT;

  if (H2-3-DMQDRP-DEB.DEBT-STS == "C")
    set H2-DBT-MTHLY-STATS empty;
    AIF34W.WS-DATE = H2-3-DMQDRP-DEB.DEBT-STS-EFF-DT;
    AIF34W.WS-PRD-YR = AIF34W.WS-DATE-CCYY;
    AIF34W.WS-PRD-MTH = AIF34W.WS-DATE-MM;
    H2-DBT-MTHLY-STATS.PRD-YR-MTH = AIF34W.WS-PRD-YR-MTH;
    H2-DBT-MTHLY-STATS.DBT-CLSFN-CD = H2-3-DMQDRP-DEB.DEBT-CLSFN-CD;
    AIF34Q1-MNTH-STATS();
    if (VDBCONTROL.URC == 0)
      H2-DEBT.DEBT-STS = "R";
    else
      H2-DEBT.DEBT-STS = "A";
      H2-DEBT.DEBT-STS-EFF-DT = H2-3-DMQDRP-DEB.ESTBL-DT;
    end
  else
    if (H2-DEBT.DEBT-BAL-AMT == 0)
      H2-DEBT.DEBT-STS = "C";
      H2-DEBT.DEBT-STS-EFF-DT = AIF34W.WS-CURR-DT;
    end
  end

  AIF34Q5-UPD-DEBT();
end // end AIF34P9-PROC-DEBT


// application specific processin
Function AIF34P9-PROC-REPT()
  set AIF34W-DET empty;

  AIF34W-DET.S-DEBT-YR = SR-AIF34-COLL.DBT-YR;
  AIF34W-DET.S-DEBT-SQ-NMB = SR-AIF34-COLL.DBT-SQ-NMB;
  if (AIF34W.WS-TOP-ERR == "Y")
      AIF34W-DET.S-TOP-DBTR-TYPE = " ";
      AIF34W2.WS-AMOUNT = 0;
      AIF34P9-FMT-AMT();
      AIF34W-DET.S-DEBT-BAL = FORMATW.OUTPUT-CHAR;
      AIF34W-DET.S-REVERSAL = "TOP N/F";      
  else
  	  AIF34W-DET.S-TOP-DBTR-TYPE = H2-3-DMQDRP-DEB.TOP-DEBTOR;
      AIF34W2.WS-AMOUNT = H2-DEBT.DEBT-BAL-AMT;
      AIF34P9-FMT-AMT();
      AIF34W-DET.S-DEBT-BAL = FORMATW.OUTPUT-CHAR;
      if (SR-AIF34-COLL.RECORD-TYPE == "0")
          AIF34W-DET.S-REVERSAL = "REVERSAL";
          AIF34W.WS-REV-TOTAL = AIF34W.WS-REV-TOTAL + AIF34W.WS-NET-OFFSET;
          AIF34W.WS-REV-COUNT = AIF34W.WS-REV-COUNT + 1;
      else
          AIF34W-DET.S-REVERSAL = " ";
          AIF34W.WS-COLL-TOTAL = AIF34W.WS-COLL-TOTAL + AIF34W.WS-NET-OFFSET;
          AIF34W.WS-COLL-COUNT = AIF34W.WS-COLL-COUNT + 1;
      end          
  end	       
  AIF34W-DET.S-DEBT-SSN = SR-AIF34-COLL.SSN;
  AIF34W-DET.S-FIRST-NAME = SR-AIF34-COLL.FIRST-NAME;
  AIF34W-DET.S-LAST-NAME = SR-AIF34-COLL.LAST-NAME;
  AIF34W2.WS-AMOUNT = AIF34W.WS-NET-OFFSET;
  AIF34P9-FMT-AMT();
  AIF34W-DET.S-COLL-AMT = FORMATW.OUTPUT-CHAR;
  AIF34W-DET.S-TRACE-NMB = SR-AIF34-COLL.TOP-TRACE-NMB;
  AIF34W-DET.S-CYCLE-NMB = SR-AIF34-COLL.OFFSET-CYCLE;
  AIF34W-DET.S-OFFSET-YR = SR-AIF34-COLL.OFFSET-CCYY;
  AIF34W-DET.S-EFF-MM = SR-AIF34-COLL.EFFECTIVE-MM;
  AIF34W-DET.S-EFF-DD = SR-AIF34-COLL.EFFECTIVE-DD;
  AIF34W-DET.S-EFF-CCYY = SR-AIF34-COLL.EFFECTIVE-CCYY;
  AIF34W-DET.S-EFF-DASH1 = "-";
  AIF34W-DET.S-EFF-DASH2 = "-";

  if (REP-COMMON.WS-LINE-NO >= REP-COMMON.WS-MAX-NO-LINES)
    AIF34P9-PRN-HEAD();
  end

  SR-132REP-RECOUT.UFIELD = AIF34W-DET.LINE1;
  WR-132REP-OUT-FILE();
  SR-132REP-RECOUT.PRNT-CC = " ";
end // end AIF34P9-PROC-REPT


// application specific processin
Function AIF34P9-PROC-RPM()
  set H2-RPM-AUDIT-TRAIL empty;
  call "DATEAPP" (GDW, VDBCONTROL, VMESSAGE) {isNoRefresh = yes};
  H2-RPM-AUDIT-TRAIL.RPM-ADT-TRL-TS = GDW.TS;
  H2-RPM-AUDIT-TRAIL.DEBT-YR = H2-3-DMQDRP-DEB.DEBT-YR;
  H2-RPM-AUDIT-TRAIL.DEBT-SQ-NMB = H2-3-DMQDRP-DEB.DEBT-SQ-NMB;
  H2-RPM-AUDIT-TRAIL.UPI = H2-3-DMQDRP-DEB.UPI;
  H2-RPM-AUDIT-TRAIL.TRN-DT = AIF34W.WS-CURR-DT;
  H2-RPM-AUDIT-TRAIL.TRN-AMT = AIF34W.WS-NET-OFFSET;
  if (SR-AIF34-COLL.RECORD-TYPE == 1)
    H2-RPM-AUDIT-TRAIL.TRN-TYPE = "7";
  else
    H2-RPM-AUDIT-TRAIL.TRN-TYPE = "8";
  end
  H2-RPM-AUDIT-TRAIL.PRGM-CASE-TYPE = "FS";
  H2-RPM-AUDIT-TRAIL.TOP-UPDATE-IND = "N";
  H2-RPM-AUDIT-TRAIL.BNFT-RDCTN-EFF-MTH = 0;
  H2-RPM-AUDIT-TRAIL.PRTCP-ID = null;
  H2-RPM-AUDIT-TRAIL.ICI = null;
  H2-RPM-AUDIT-TRAIL.RCPT-ADJMT-NMB = null;
  H2-RPM-AUDIT-TRAIL.BNFT-YR = null;
  H2-RPM-AUDIT-TRAIL.BNFT-MTH = null;
  H2-RPM-AUDIT-TRAIL.VER-NMB = null;
  H2-RPM-AUDIT-TRAIL.ISNCE-REF-NMB = 0;
  AIF34Q5-INS-RPM();
end // end AIF34P9-PROC-RPM


// application specific processin
Function AIF34P9-PROC-TOTAL()
  set AIF34W-TOTAL empty;

  if (AIF34W.WS-COLL-COUNT == 1)
    AIF34W-TOTAL.S-TOTAL-NAME = "COLLECTION ";
  else
    AIF34W-TOTAL.S-TOTAL-NAME = "COLLECTIONS";
  end
  AIF34W2.WS-AMOUNT = AIF34W.WS-COLL-TOTAL;
  AIF34P9-FMT-AMT();
  AIF34W-TOTAL.S-TOTAL-AMOUNT = FORMATW.OUTPUT-CHAR;

  AIF34W2.WS-COUNT = AIF34W.WS-COLL-COUNT;
  AIF34P9-FMT-CNT();
  AIF34W-TOTAL.S-TOTAL-COUNT = FORMATW.OUTPUT-CHAR;

  SR-132REP-RECOUT.PRNT-CC = "0";
  SR-132REP-RECOUT.UFIELD = AIF34W-TOTAL.LINE1;
  WR-132REP-OUT-FILE();

  if (AIF34W.WS-REV-COUNT == 1)
    AIF34W-TOTAL.S-TOTAL-NAME = "REVERSAL   ";
  else
    AIF34W-TOTAL.S-TOTAL-NAME = "REVERSALS  ";
  end
  AIF34W2.WS-AMOUNT = AIF34W.WS-REV-TOTAL;
  AIF34P9-FMT-AMT();
  AIF34W-TOTAL.S-TOTAL-AMOUNT = FORMATW.OUTPUT-CHAR;

  AIF34W2.WS-COUNT = AIF34W.WS-REV-COUNT;
  AIF34P9-FMT-CNT();
  AIF34W-TOTAL.S-TOTAL-COUNT = FORMATW.OUTPUT-CHAR;

  SR-132REP-RECOUT.PRNT-CC = " ";
  SR-132REP-RECOUT.UFIELD = AIF34W-TOTAL.LINE1;
  WR-132REP-OUT-FILE();
end // end AIF34P9-PROC-TOTAL


// TWNDEBT/TWNDEBT-RESP-PRSN
Function AIF34Q1-DMQDRP-DEB()
  WDB00PI();
  VDBCONTROL.UPROC-NM = "AIF34Q1-DMQDRP-DEB";
  VDBCOMMON.USQLREC = "H2-3-DMQDRP-DEB";
  VDBCONTROL.UPROC-OBJ = "H2-3-DMQDRP-DEB";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  try
    get H2-3-DMQDRP-DEB
      with #sql{
        select T1.SSN, T1.UPI, T1.TOPS_LST_COLLECTN, T1.TOPS_CHANGE_IND,
          T1.TOP_DEBTOR,
         --
          T2.TOP_STS,
         --
          T3.DEBT_YR, T3.DEBT_SQ_NMB, T3.DEBT_STS,
          T3.DEBT_BAL_AMT, T3.ESTBL_DT, T3.DEBT_STS_EFF_DT,
          T3.DEBT_CLSFN_CD, T3.DEBT_PRGM_CD, T3.OFC_CD 
                   
        from TWNDEBT_MATCH_REQ T1,
             TWNDEBT_RESP_PRSN T2,
             TWNDEBT T3
        WHERE T1.DEBT_YR            = :DEBT-YR
          AND T1.DEBT_SQ_NMB        = :DEBT-SQ-NMB
          AND T1.SSN                = :SSN
          AND T1.DEBT_YR            = T2.DEBT_YR
          AND T1.DEBT_SQ_NMB        = T2.DEBT_SQ_NMB
          AND T1.UPI                = T2.UPI
          AND T2.DEBT_YR            = T3.DEBT_YR
          AND T2.DEBT_SQ_NMB        = T3.DEBT_SQ_NMB
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into SSN, UPI, TOPS-LST-COLLECTN, TOPS-CHANGE-IND,
           TOP-DEBTOR,           
           TOP-STS,           
           DEBT-YR, DEBT-SQ-NMB, DEBT-STS,
           DEBT-BAL-AMT, ESTBL-DT, DEBT-STS-EFF-DT,
           DEBT-CLSFN-CD, DEBT-PRGM-CD, OFC-CD;
  end
  AIF34Q9-SQLERR-RD();
end // end AIF34Q1-DMQDRP-DEB


// TWNDBT_MTHLY_STATS
Function AIF34Q1-MNTH-STATS()
  WDB00PI();
  VDBCONTROL.UPROC-NM = "AIF34Q1-MNTH-STATS";
  VDBCOMMON.USQLREC = "H2-DBT-MTHLY-STATS";
  VDBCONTROL.UPROC-OBJ = "H2-DBT-MTHLY-STATS";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  try
    get H2-DBT-MTHLY-STATS
      with #sql{
        select PRD_YR_MTH, DBT_CLSFN_CD
        from TWNDBT_MTHLY_STATS T1
        WHERE PRD_YR_MTH   = :PRD-YR-MTH
          AND DBT_CLSFN_CD = :DBT-CLSFN-CD
      }
      into PRD-YR-MTH, DBT-CLSFN-CD ;
  end
  AIF34Q9-SQLERR-RD();
end // end AIF34Q1-MNTH-STATS


// PROCESS TO READ INPUT FILE
Function AIF34Q1-READIP()
  VDBCONTROL.UPROC-NM = "AIF34P9-READIP";
  VDBCONTROL.UPROC-OPT = "SCAN";
  VDBCONTROL.UPROC-OBJ = "SR-AIF34-INREC";
  VMESSAGE.UMSGINS[2] = "AIF34A";
  try
    get next SR-AIF34-INREC ;
  end
  if (SR-AIF34-INREC is ioError && SR-AIF34-INREC not endOfFile)
    VMESSAGE.UMSGCODE-JCL-ERR = 0;
    AIF34W.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = AIF34W.WS-ERR-LAST-FOUR;
    WCM00P2-TO-CEP01A();
  end
end // end AIF34Q1-READIP


Function AIF34Q5-INS-COLL()
  WDB00PI();
  VDBCOMMON.USQLREC = "H2-DEBT-TOP-COLL";
  VDBCONTROL.UPROC-OBJ = "H2-DEBT-TOP-COLL";
  VDBCONTROL.UPROC-NM = "AIF34Q5-INS-COLL";
  VDBCONTROL.UPROC-OPT = "ADD";
  /*  */
  try
    add H2-DEBT-TOP-COLL ;
  end
  AIF34Q9-SQLERR-WR();
end // end AIF34Q5-INS-COLL


// add rpm-audit-TRAIL
Function AIF34Q5-INS-RPM()
  WDB00PI();
  VDBCOMMON.USQLREC = "H2-RPM-AUDIT-TRAIL";
  VDBCONTROL.UPROC-OBJ = "H2-RPM-AUDIT-TRAIL";
  VDBCONTROL.UPROC-NM = "AIF34Q5-INS-RPM";
  VDBCONTROL.UPROC-OPT = "ADD";
  /*  */
  try
    add H2-RPM-AUDIT-TRAIL
      with #sql{
        insert into TWNRPM_AUDIT_TRAIL
        (RPM_ADT_TRL_TS, BNFT_RDCTN_EFF_MTH,
           TRN_DT,
          TRN_AMT, TRN_TYPE, PRTCP_ID, ICI,
          PRGM_CASE_TYPE, BNFT_YR, BNFT_MTH, VER_NMB,
          DEBT_YR, DEBT_SQ_NMB, RCPT_ADJMT_NMB, UPI,
          ISNCE_REF_NMB, TOP_UPDATE_IND)
        values (:RPM-ADT-TRL-TS, :BNFT-RDCTN-EFF-MTH,
           CURRENT_DATE,
          :TRN-AMT, :TRN-TYPE, :PRTCP-ID, :ICI,
          :PRGM-CASE-TYPE, :BNFT-YR, :BNFT-MTH, :VER-NMB,
          :DEBT-YR, :DEBT-SQ-NMB, :RCPT-ADJMT-NMB, :UPI,
          :ISNCE-REF-NMB, :TOP-UPDATE-IND)
      } ;
  end
  AIF34Q9-SQLERR-WR();
end // end AIF34Q5-INS-RPM


// TWNDEBT
Function AIF34Q5-UPD-DEBT()
  WDB00PI();
  VDBCONTROL.UPROC-NM = "AIF34Q5-UPD-DEBT";
  VDBCOMMON.USQLREC = "H2-DEBT";
  VDBCONTROL.UPROC-OBJ = "H2-DEBT";
  VDBCONTROL.UPROC-OPT = "UPDATE";
  try
    execute 
      #sql{
        UPDATE TWNDEBT
        SET    DEBT_STS           = :DEBT-STS
              ,DEBT_STS_EFF_DT    = :DEBT-STS-EFF-DT
              ,DEBT_BAL_AMT       = :DEBT-BAL-AMT
        WHERE  DEBT_YR            = :DEBT-YR
          AND  DEBT_SQ_NMB        = :DEBT-SQ-NMB
      }
      for H2-DEBT ; // model = none
  end
  AIF34Q9-SQLERR-WR();
end // end AIF34Q5-UPD-DEBT


// TWNDEBT-MATCH-REQ
Function AIF34Q5-UPD-DMQ()
  WDB00PI();
  VDBCONTROL.UPROC-NM = "AIF34Q5-UPD-DMQ";
  VDBCOMMON.USQLREC = "H2-DEBT-MATCH-REQ";
  VDBCONTROL.UPROC-OBJ = "H2-DEBT-MATCH-REQ";
  VDBCONTROL.UPROC-OPT = "UPDATE";
  try
    execute 
      #sql{
        UPDATE TWNDEBT_MATCH_REQ
        SET    TOPS_CHANGE_IND  = :TOPS-CHANGE-IND
        WHERE  DEBT_YR          = :DEBT-YR
          AND  DEBT_SQ_NMB      = :DEBT-SQ-NMB
          AND  UPI              = :UPI
      }
      for H2-DEBT-MATCH-REQ ; // model = none
  end
  AIF34Q9-SQLERR-WR();
end // end AIF34Q5-UPD-DMQ


// CLOSE NOTICE FILE
Function AIF34Q8-CLOSE-RPT()
  VGVar.handleHardIOErrors = 1;
  try
    close SR-132REP-RECOUT ;
  end
  if (SR-132REP-RECOUT is ioError)
    VDBCONTROL.UPROC-NM = "AIF34Q8-CLOSE-RPT";
    VDBCONTROL.UPROC-OBJ = "SR-132REP-RECOUT";
    VDBCONTROL.UPROC-OPT = "CLOSE";
    AIF34W.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = AIF34W.WS-ERR-LAST-FOUR;
    VMESSAGE.UMSGINS[2] = "AIF34A";
    if (SR-132REP-RECOUT is fileNotAvailable)
      VDBCONTROL.UEZESQRRM = "FILE IS NOT AVAILABLE";
    else
      if (SR-132REP-RECOUT is fileNotFound)
        VDBCONTROL.UEZESQRRM = "FILE NOT FOUND";
      else
        if (SR-132REP-RECOUT is invalidFormat)
          VDBCONTROL.UEZESQRRM = "FILE FORMAT MISMATCH";
        end
      end
    end
    WCM00P2-TO-CEP01A();
  end
end // end AIF34Q8-CLOSE-RPT


// CLOSE THE SINP FILE
Function AIF34Q8-CLOSE-SR()
  VGVar.handleHardIOErrors = 1;
  try
    close SR-AIF34-INREC ;
  end
  if (SR-AIF34-INREC is ioError)
    VDBCONTROL.UPROC-NM = "AIF34Q8-CLOSE-SR";
    VDBCONTROL.UPROC-OBJ = "SR-AIF34-INREC";
    VDBCONTROL.UPROC-OPT = "CLOSE";
    AIF34W.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = AIF34W.WS-ERR-LAST-FOUR;
    VMESSAGE.UMSGINS[2] = "AIF34A";
    if (SR-AIF34-INREC is fileNotAvailable)
      VDBCONTROL.UEZESQRRM = "FILE IS NOT AVAILABLE";
    else
      if (SR-AIF34-INREC is fileNotFound)
        VDBCONTROL.UEZESQRRM = "FILE NOT FOUND";
      else
        if (SR-AIF34-INREC is invalidFormat)
          VDBCONTROL.UEZESQRRM = "FILE FORMAT MISMATCH";
        end
      end
    end
    WCM00P2-TO-CEP01A();
  end
end // end AIF34Q8-CLOSE-SR


// PROCESS SQL ERRORS
Function AIF34Q9-SQLERR-RD()
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "AIF34A";
  VDBCOMMON.UNRF = "Y";
  VDBCOMMON.UDUP = "N";
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC >= 104)
    WCM00P2-TO-CEP01A();
  end
end // end AIF34Q9-SQLERR-RD


// PROCESS SQL ERRORS
Function AIF34Q9-SQLERR-WR()
  VDBCONTROL.UACCTYP = "W";
  VDBCOMMON.UAPPLNAM = "AIF34A";
  VDBCOMMON.UNRF = "Y";
  VDBCOMMON.UDUP = "Y";
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 0)
    VDBCONTROL.UROLLBACK = "Y";
    WCM00P2-TO-CEP01A();
  end
end // end AIF34Q9-SQLERR-WR


Record AIF34W type basicRecord
  10 WS-TOP-ERR char(1) ;
  10 WS-EOF char(1) ; 
  10 WS-REM-LINES num(3) ; 
  10 WS-DATE char(10) ; 
    15 WS-DATE-CCYY char(4) ; 
    15 WS-DATE-FLR1 char(1) ; 
    15 WS-DATE-MM char(2) ; 
    15 WS-DATE-FLR2 char(1) ; 
    15 WS-DATE-DD char(2) ; 
  10 WS-DT char(8) ; 
    15 WS-CCYY char(4) ; 
    15 WS-MM char(2) ; 
    15 WS-DD num(2) ; 
  10 WS-CURR-DT char(10) ; 
    15 WS-CURR-CCYY char(4) ; 
    15 WS-DASH1 char(1) ; 
    15 WS-CURR-MM char(2) ; 
    15 WS-DASH2 char(1) ; 
    15 WS-CURR-DD char(2) ; 
  10 WS-PRD-YR-MTH char(6) ; 
    15 WS-PRD-YR char(4) ; 
    15 WS-PRD-MTH char(2) ; 
  10 WS-DATA-FLG char(1) ; 
  10 WS-FIRST-TIME char(1) ; 
  10 WS-SSN char(9) ; 
  10 WS-ERROR char(1) ; 
  10 WS-ERR-CD char(8) ; 
    15 WS-ERR-FIRST-FOUR char(4) ; 
    15 WS-ERR-LAST-FOUR char(4) ; 
  10 WS-UPI-CHA char(9) ; 
    15 WS-UPI num(9) ; 
  10 WS-COUNT int ; 
  10 WS-AMOUNT decimal(9,2) ; 
  10 WS-NET-OFFSET num(8,2) ; 
  10 WS-REV-TOTAL num(8,2) ; 
  10 WS-REV-COUNT int ; 
  10 WS-COLL-TOTAL num(8,2) ; 
  10 WS-COLL-COUNT int ; 
end // end AIF34W


Record AIF34W-DET type basicRecord
  5 LINE1 char(132) ; 
    10 S-DEBT-YR num(2) ; 
    10 S-DEBT-SQ-NMB num(5) ; 
    10 LINE1-FLR1 char(2) ;
    10 S-TOP-DBTR-TYPE char(1) ; 
    10 LINE1-FLR2 char(1) ;
    10 S-DEBT-SSN char(9) ; 
    10 LINE1-FLR4 char(2) ; 
    10 S-LAST-NAME char(20) ; 
    10 LINE1-FLR5 char(2) ; 
    10 S-FIRST-NAME char(15) ; 
    10 LINE1-FLR6 char(1) ; 
    10 S-COLL-AMT char(11) ; 
    10 LINE1-FLR7 char(1) ; 
    10 S-DEBT-BAL char(11) ; 
    10 LINE1-FLR8 char(2) ; 
    10 S-TRACE-NMB char(10) ; 
    10 LINE1-FLR9 char(2) ; 
    10 S-CYCLE-NMB num(6) ; 
    10 LINE1-FLR10 char(2) ; 
    10 S-OFFSET-YR num(4) ; 
    10 LINE1-FLR11 char(3) ; 
    10 S-EFFECTVE-DT char(10) ; 
      15 S-EFF-MM char(2) ; 
      15 S-EFF-DASH1 char(1) ; 
      15 S-EFF-DD char(2) ; 
      15 S-EFF-DASH2 char(1) ; 
      15 S-EFF-CCYY char(4) ; 
    10 LINE1-FLR12 char(2) ; 
    10 S-REVERSAL char(8) ; 
end // end AIF34W-DET


Record AIF34W-HEAD type basicRecord
  10 LINE1 char(132) ; 
    15 LINE1-PAGE-TEXT char(8) ; 
    15 FILLER1 char(1) ; 
    15 UPAGE char(4) ; 
    15 FILLER2 char(46) ; 
    15 LINE1-STATE-TEXT char(15) ; 
    15 FILLER3 char(43) ; 
    15 LINE1-DATE-TEXT char(4) ; 
    15 FILLER4 char(3) ; 
    15 UDATE char(8) ; 
  10 LINE2 char(132) ; 
    15 UAPPL char(8) ; 
    15 FILLER5 char(39) ; 
    15 LINE2-RPT-NAME char(39) ; 
    15 FILLER6 char(31) ; 
    15 LINE2-TIME-TEXT char(4) ; 
    15 FILLER7 char(3) ; 
    15 UTIME char(8) ; 
  10 LINE3 char(132) ; 
    15 LINE3-1 char(22) ; 
    15 LINE3-2 char(22) ; 
    15 LINE3-3 char(21) ; 
    15 LINE3-4 char(20) ; 
    15 LINE3-5 char(47) ; 
end // end AIF34W-HEAD


Record AIF34W-TOTAL type basicRecord
  5 LINE1 char(132) ; 
    10 LINE1-FLR1 char(41) ; 
    10 S-TOTAL-COUNT char(5) ; 
    10 LINE1-FLR2 char(1) ; 
    10 S-TOTAL-NAME char(12) ; 
    10 LINE1-FLR3 char(1) ; 
    10 S-TOTAL-AMOUNT char(11) ; 
    10 LINE1-FLR4 char(61) ; 
end // end AIF34W-TOTAL


Record AIF34W2 type basicRecord
  10 WS-DATE-TS char(26) ; 
    15 WS-DATE char(10) ; 
      20 WS-CCYY char(4) ; 
      20 WS-DASH1 char(1) ; 
      20 WS-MM char(2) ; 
      20 WS-DASH2 char(1) ; 
      20 WS-DD char(2) ; 
    15 WS-DASH3 char(1) ; 
    15 WS-TIME char(15) ; 
  10 WS-PRN-DATE char(10) ; 
    15 WS-PRN-MM char(2) ; 
    15 WS-PRN-DASH1 char(1) ; 
    15 WS-PRN-DD char(2) ; 
    15 WS-PRN-DASH2 char(1) ; 
    15 WS-PRN-CCYY char(4) ; 
  10 WS-AMOUNT decimal(9,2) ; 
  10 WS-COUNT int ; 
  10 WS-NUMB int ; 
  10 WS-OUTPUT1 char(13) ; 
    15 WS-OUTPUT1A char(2) ; 
    15 WS-FLR1 char(1) ; 
    15 WS-OUTPUT1B char(10) ; 
  10 WS-OUTPUT2 char(13) ; 
    15 WS-FLR2 char(1) ; 
    15 WS-OUTPUT2A char(2) ; 
    15 WS-OUTPUT2B char(10) ; 
end // end AIF34W2


