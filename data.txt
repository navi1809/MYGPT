WITH
params (beg_ts, end_ts, rpt_end_dt) AS (
  VALUES (
    CAST('2025-01-01 00:00:00' AS TIMESTAMP),
    CAST('2025-01-31 23:59:59' AS TIMESTAMP),
    DATE('2025-01-31')
  )
),

ap_per_ici AS (
  SELECT
    c.OFC_CD,
    a.ICI,
    MIN(a.ACTN_TS) AS ap_ts
  FROM W026DTF1.TWNFAM_ACTNS      a
  JOIN W026DTF1.TWNFAM_CASELD_CASE c
    ON c.ICI = a.ICI
  WHERE c.PRGM_OFC_TYPE = 'A'
    AND a.PRGM_TYP = 'FS'
    AND a.ACTN_TYP = 'AP'
    AND a.ACTN_TS BETWEEN (SELECT beg_ts FROM params) AND (SELECT end_ts FROM params)
  GROUP BY c.OFC_CD, a.ICI
),

prev_act AS (
  SELECT
    x.OFC_CD,
    x.ICI,
    MAX(a2.ACTN_TS) AS prev_ts
  FROM ap_per_ici x
  JOIN W026DTF1.TWNFAM_ACTNS a2
    ON a2.ICI = x.ICI
   AND a2.PRGM_TYP = 'FS'
   AND a2.ACTN_TS < x.ap_ts
  GROUP BY x.OFC_CD, x.ICI
),

prev_act_row AS (
  SELECT
    p.OFC_CD,
    p.ICI,
    a.ACTN_TYP AS prev_actn_typ
  FROM prev_act p
  JOIN W026DTF1.TWNFAM_ACTNS a
    ON a.ICI = p.ICI
   AND a.ACTN_TS = p.prev_ts
),

suffix_asof AS (
  SELECT
    h.ICI,
    h.FS_SUFX
  FROM W026DTF1.TWNFAM_CASE_HSTRY h
  WHERE h.PRD_BEG_DT <= (SELECT rpt_end_dt FROM params)
    AND COALESCE(h.PRD_END_DT, DATE('9999-12-31')) >= (SELECT rpt_end_dt FROM params)
)

SELECT
  b.OFC_CD,
  COUNT(*) AS full_benefits_total,
  SUM(CASE WHEN s.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS pa_benefits,
  SUM(CASE WHEN s.FS_SUFX IN ('P','S','G','A') THEN 0 ELSE 1 END) AS na_benefits
FROM ap_per_ici b
JOIN prev_act_row r
  ON r.OFC_CD = b.OFC_CD
 AND r.ICI    = b.ICI
JOIN suffix_asof s
  ON s.ICI = b.ICI
WHERE r.prev_actn_typ IN ('FA','RE','RI')
GROUP BY b.OFC_CD
ORDER BY b.OFC_CD;
