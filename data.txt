LEFT JOIN {?SCHEMA}.TWNFAM_CASE_HSTRY T2
  ON T1.ICI = T2.ICI
 AND T2.PRD_BEG_DT <= DATE(T1.ACTN_TS)              
 AND T2.PRD_END_DT >= DATE(T1.ACTN_TS)
 
 
 
 
 -- new layer to dedup once per case
S04_APPROVALS_DEDUP AS (
  SELECT OFC_CD, OFC_NM, ICI, FS_SUFX, RCRT_APL_DT, RPT_BEG_DT, RPT_END_DT
  FROM (
    SELECT PCH.*,
           ROW_NUMBER() OVER (PARTITION BY ICI ORDER BY ACTN_TS) AS rn
    FROM PRGM_CSH_HSTRY_FILTERED PCH
  ) d
  WHERE rn = 1
),

-- MAIN2 becomes:
MAIN2 AS (
  SELECT
    OFC_CD, OFC_NM,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END)                                                   AS PABNFT,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') AND RCRT_APL_DT BETWEEN RPT_BEG_DT AND RPT_END_DT THEN 1 ELSE 0 END) AS PANEW,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') AND (RCRT_APL_DT < RPT_BEG_DT OR RCRT_APL_DT > RPT_END_DT) THEN 1 END) AS PASUBS,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END)                                                AS NABNFT,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') AND RCRT_APL_DT BETWEEN RPT_BEG_DT AND RPT_END_DT THEN 1 ELSE 0 END) AS NANEW,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') AND (RCRT_APL_DT < RPT_BEG_DT OR RCRT_APL_DT > RPT_END_DT) THEN 1 END) AS NASUBS
  FROM S04_APPROVALS_DEDUP
  GROUP BY OFC_CD, OFC_NM
)
