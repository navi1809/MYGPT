/* AME37A — Combined report for January 2025 (schema: W026DTF1)
   Includes: Active caseload (MAIN), Last-month caseload (MAIN1),
             Full benefits (MAIN2) — NULL-safe per your spec,
             Withdrawn (MAIN3), Denied (MAIN4),
             Applications processed (MAIN5), Terminations (MAIN6)
*/

WITH RPT_DATES AS (
    SELECT
        DATE('2025-01-01')                                              AS RPT_BEG_DT,
        LAST_DAY(DATE('2025-01-01'))                                    AS RPT_END_DT,
        VARCHAR_FORMAT('2025-01-01', 'MM')                              AS RPT_MONTH_BIN,
        VARCHAR_FORMAT('2025-01-01', 'YYYY')                            AS RPT_YEAR_BIN,
        VARCHAR_FORMAT(DATE('2025-01-01') - 1 MONTH, 'MM')              AS PREV_RPT_MTH,
        VARCHAR_FORMAT(DATE('2025-01-01') - 1 MONTH, 'YYYY')            AS PREV_RPT_YR,
        VARCHAR_FORMAT(DATE('2025-01-01'), 'YYYY-MM-DD') || '-00.00.00.000000' AS RPT_BEG_DT_TS,
        VARCHAR_FORMAT(LAST_DAY(DATE('2025-01-01')), 'YYYY-MM-DD') || '-23.59.59.999999' AS RPT_END_DT_TS
    FROM SYSIBM.SYSDUMMY1
),

/* Office driver (admin only, exclude DC/DH/DL/DR) with names */
OFFICES AS (
    SELECT DISTINCT D.OFC_CD, O.OFC_NM
    FROM W026DTF1.TWNCASELD_DEBTLD D
    JOIN W026DTF1.TWNOFFICE O ON O.OFC_CD = D.OFC_CD
    WHERE D.PRGM_OFC_TYPE = 'A'
      AND D.OFC_CD NOT IN ('DC','DH','DL','DR')
),

/* ----------------- 1) ACTIVE CASELOAD & FLAGS ----------------- */
ACT_CASELD_INFO AS (
    SELECT C.OFC_CD, OFC.OFC_NM, H.FS_SUFX, H.MTHLY_RPTR_IND,
           I.EXPD_SRVC_IND, I.MTHD_OF_ISNCE, I.ISNCE_MTHD
    FROM W026DTF1.TWNFAM_CASELD_CASE C
    JOIN OFFICES OFC ON OFC.OFC_CD = C.OFC_CD
    JOIN W026DTF1.TWNFAM_CASE_HSTRY H ON H.ICI = C.ICI
    JOIN W026DTF1.TWNFS_ISNCE I ON I.ICI = C.ICI
    JOIN RPT_DATES RPT ON 1=1
    WHERE H.PRD_BEG_DT <= RPT.RPT_END_DT
      AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= RPT.RPT_END_DT
      AND I.ISNCE_DT <= RPT.RPT_END_DT
      AND I.BNFT_MTH = RPT.RPT_MONTH_BIN
      AND I.BNFT_YR  = RPT.RPT_YEAR_BIN
      AND I.BNFT_TYPE = 'RG'
      AND I.FS_ISNCE_STS IN ('IS','RD')
),
MAIN AS (
    SELECT
        ACI.OFC_CD, ACI.OFC_NM,
        SUM(CASE WHEN ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PACASES,
        SUM(CASE WHEN ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NACASES,
        SUM(CASE WHEN ACI.EXPD_SRVC_IND = 'Y' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAEXPCASE,
        SUM(CASE WHEN ACI.EXPD_SRVC_IND = 'Y' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAEXPCASE,
        SUM(CASE WHEN ACI.ISNCE_MTHD = 'E' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAEBTCASE,
        SUM(CASE WHEN ACI.ISNCE_MTHD = 'E' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAEBTCASE,
        SUM(CASE WHEN ACI.ISNCE_MTHD = 'E' THEN 1 ELSE 0 END) AS DMIEBT,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '3' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PADAMS,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '3' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NADAMS,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE <> '3' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PASPHNDL,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE <> '3' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NASPHNDL,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND (ACI.MTHD_OF_ISNCE IN ('0',' ')) THEN 1 ELSE 0 END) AS DMI0_COUNT,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '1' THEN 1 ELSE 0 END) AS DMI1_COUNT,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '2' THEN 1 ELSE 0 END) AS DMI2_COUNT,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '3' THEN 1 ELSE 0 END) AS DMI3_COUNT,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '4' THEN 1 ELSE 0 END) AS DMI4_COUNT,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '5' THEN 1 ELSE 0 END) AS DMI5_COUNT,
        SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '6' THEN 1 ELSE 0 END) AS DMI6_COUNT,
        SUM(CASE WHEN ACI.MTHLY_RPTR_IND = 'Y' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAMRC,
        SUM(CASE WHEN ACI.MTHLY_RPTR_IND = 'Y' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAMRC
    FROM ACT_CASELD_INFO ACI
    GROUP BY ACI.OFC_CD, ACI.OFC_NM
),

/* ----------------- 2) LAST-MONTH CASELOAD ----------------- */
LST_MTH_CSLD AS (
    SELECT C.OFC_CD, OFC.OFC_NM, H.FS_SUFX, I.ISNCE_DT,
           RPT.RPT_BEG_DT, RPT.RPT_END_DT
    FROM W026DTF1.TWNFAM_CASELD_CASE C
    JOIN OFFICES OFC ON OFC.OFC_CD = C.OFC_CD
    JOIN W026DTF1.TWNFAM_CASE_HSTRY H ON H.ICI = C.ICI
    JOIN W026DTF1.TWNFS_ISNCE I ON I.ICI = H.ICI
    JOIN RPT_DATES RPT ON 1=1
    WHERE H.PRD_BEG_DT <= RPT.RPT_END_DT
      AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= RPT.RPT_END_DT
      AND I.BNFT_MTH = RPT.PREV_RPT_MTH
      AND I.BNFT_YR  = RPT.PREV_RPT_YR
      AND I.BNFT_TYPE = 'RG'
      AND I.FS_ISNCE_STS IN ('IS','RD')
),
MAIN1 AS (
    SELECT
        L.OFC_CD, L.OFC_NM,
        SUM(CASE WHEN L.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAREVISED,
        SUM(CASE WHEN L.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAREVISED,
        SUM(CASE WHEN L.FS_SUFX IN ('P','S','G','A') AND L.ISNCE_DT BETWEEN L.RPT_BEG_DT AND L.RPT_END_DT THEN 1 ELSE 0 END) AS PALMISS,
        SUM(CASE WHEN L.FS_SUFX NOT IN ('P','S','G','A') AND L.ISNCE_DT BETWEEN L.RPT_BEG_DT AND L.RPT_END_DT THEN 1 ELSE 0 END) AS NALMISS
    FROM LST_MTH_CSLD L
    GROUP BY L.OFC_CD, L.OFC_NM
),

/* ----------------- 3) FULL BENEFITS — NULL-SAFE (your spec) ----------------- */
AP0 AS (  /* earliest AP per ICI in Jan 2025 for admin offices */
  SELECT
    C.OFC_CD,
    A.ICI,
    MIN(A.ACTN_TS) AS AP_TS
  FROM W026DTF1.TWNFAM_ACTNS A
  JOIN W026DTF1.TWNFAM_CASELD_CASE C
    ON C.ICI = A.ICI
   AND C.PRGM_OFC_TYPE = 'A'
  WHERE A.PRGM_TYP = 'FS'
    AND A.ACTN_TYP = 'AP'
    AND A.ACTN_TS >= TIMESTAMP('2025-01-01-00.00.00')
    AND A.ACTN_TS <= TIMESTAMP('2025-01-31-23.59.59')
  GROUP BY C.OFC_CD, A.ICI
),
AP_OFF AS (     /* restrict to reporting offices */
  SELECT A.*
  FROM AP0 A
  JOIN OFFICES O ON O.OFC_CD = A.OFC_CD
),
PREV AS (       /* previous FS action before that AP */
  SELECT
    F.OFC_CD,
    F.ICI,
    MAX(P.ACTN_TS) AS PREV_TS
  FROM AP_OFF F
  JOIN W026DTF1.TWNFAM_ACTNS P
    ON P.ICI = F.ICI
   AND P.PRGM_TYP = 'FS'
   AND P.ACTN_TS  < F.AP_TS
  GROUP BY F.OFC_CD, F.ICI
),
PREV_OK AS (    /* keep only FA/RE/RI */
  SELECT P.OFC_CD, P.ICI, P.PREV_TS
  FROM PREV P
  JOIN W026DTF1.TWNFAM_ACTNS R
    ON R.ICI = P.ICI
   AND R.PRGM_TYP = 'FS'
   AND R.ACTN_TS = P.PREV_TS
   AND R.ACTN_TYP IN ('FA','RE','RI')
),
CLASS AS (      /* FS suffix as of REPORT END DATE; pick exactly one row */
  SELECT
    K.OFC_CD,
    K.ICI,
    (
      SELECT H.FS_SUFX
      FROM W026DTF1.TWNFAM_CASE_HSTRY H
      WHERE H.ICI = K.ICI
        AND H.PRD_BEG_DT <= DATE('2025-01-31')
        AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= DATE('2025-01-31')
      ORDER BY H.PRD_BEG_DT DESC
      FETCH FIRST 1 ROW ONLY
    ) AS FS_SUFX
  FROM PREV_OK K
),
S04_RCRT AS (   /* optional recruit date for NEW/SUBS split; do not filter out NULLs */
  SELECT
    C.OFC_CD,
    C.ICI,
    C.FS_SUFX,
    (
      SELECT MIN(H.RCRT_APL_DT)
      FROM W026DTF1.TWNPRGM_CASE_HSTRY H
      WHERE H.ICI = C.ICI
        AND H.PRGM_CASE_TYPE = 'FS'
    ) AS RCRT_APL_DT
  FROM CLASS C
),
MAIN2 AS (      /* final full-benefit metrics per office; NULL-safe NA */
  SELECT
    R.OFC_CD,
    O.OFC_NM,
    SUM(CASE WHEN R.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PABNFT,
    SUM(CASE WHEN R.FS_SUFX IS NOT NULL AND R.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NABNFT,
    SUM(CASE WHEN R.FS_SUFX IN ('P','S','G','A')
               AND R.RCRT_APL_DT IS NOT NULL
               AND DATE(R.RCRT_APL_DT) BETWEEN DATE('2025-01-01') AND DATE('2025-01-31')
             THEN 1 ELSE 0 END) AS PABNFT_NEW,
    SUM(CASE WHEN R.FS_SUFX IN ('P','S','G','A')
               AND (R.RCRT_APL_DT IS NULL
                 OR DATE(R.RCRT_APL_DT) < DATE('2025-01-01')
                 OR DATE(R.RCRT_APL_DT) > DATE('2025-01-31'))
             THEN 1 ELSE 0 END) AS PABNFT_SUBS,
    SUM(CASE WHEN R.FS_SUFX IS NOT NULL AND R.FS_SUFX NOT IN ('P','S','G','A')
               AND R.RCRT_APL_DT IS NOT NULL
               AND DATE(R.RCRT_APL_DT) BETWEEN DATE('2025-01-01') AND DATE('2025-01-31')
             THEN 1 ELSE 0 END) AS NABNFT_NEW,
    SUM(CASE WHEN R.FS_SUFX IS NOT NULL AND R.FS_SUFX NOT IN ('P','S','G','A')
               AND (R.RCRT_APL_DT IS NULL
                 OR DATE(R.RCRT_APL_DT) < DATE('2025-01-01')
                 OR DATE(R.RCRT_APL_DT) > DATE('2025-01-31'))
             THEN 1 ELSE 0 END) AS NABNFT_SUBS
  FROM S04_RCRT R
  JOIN OFFICES O ON O.OFC_CD = R.OFC_CD
  GROUP BY R.OFC_CD, O.OFC_NM
),

/* ----------------- 4) WITHDRAWN DURING MONTH ----------------- */
WITH_DRAW_INFO AS (
    SELECT C.OFC_CD, OFC.OFC_NM, H.FS_SUFX,
           PC.RCRT_APL_DT, RPT.RPT_BEG_DT, RPT.RPT_END_DT
    FROM W026DTF1.TWNFAM_CASELD_CASE C
    JOIN OFFICES OFC ON OFC.OFC_CD = C.OFC_CD
    JOIN W026DTF1.TWNFAM_CASE_HSTRY H ON H.ICI = C.ICI
    JOIN W026DTF1.TWNPRGM_CASE_HSTRY PC
      ON PC.ICI = C.ICI AND PC.PRGM_CASE_TYPE = 'FS'
    JOIN RPT_DATES RPT ON 1=1
    WHERE H.PRD_BEG_DT <= RPT.RPT_END_DT
      AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= RPT.RPT_END_DT
      AND PC.STS_EFF_DT BETWEEN RPT.RPT_BEG_DT AND RPT.RPT_END_DT
      AND PC.CLSRE_RSN_CD = 'W'
),
MAIN3 AS (
    SELECT
        W.OFC_CD, W.OFC_NM,
        SUM(CASE WHEN W.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAWTDR,
        SUM(CASE WHEN W.FS_SUFX IN ('P','S','G','A') AND W.RCRT_APL_DT BETWEEN W.RPT_BEG_DT AND W.RPT_END_DT THEN 1 ELSE 0 END) AS PAWTDR_NEW,
        SUM(CASE WHEN W.FS_SUFX IN ('P','S','G','A') AND (W.RCRT_APL_DT IS NULL OR W.RCRT_APL_DT < W.RPT_BEG_DT OR W.RCRT_APL_DT > W.RPT_END_DT) THEN 1 ELSE 0 END) AS PAWTDR_SUBS,
        SUM(CASE WHEN W.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAWTDR,
        SUM(CASE WHEN W.FS_SUFX NOT IN ('P','S','G','A') AND W.RCRT_APL_DT BETWEEN W.RPT_BEG_DT AND W.RPT_END_DT THEN 1 ELSE 0 END) AS NAWTDR_NEW,
        SUM(CASE WHEN W.FS_SUFX NOT IN ('P','S','G','A') AND (W.RCRT_APL_DT IS NULL OR W.RCRT_APL_DT < W.RPT_BEG_DT OR W.RCRT_APL_DT > W.RPT_END_DT) THEN 1 ELSE 0 END) AS NAWTDR_SUBS
    FROM WITH_DRAW_INFO W
    GROUP BY W.OFC_CD, W.OFC_NM
),

/* ----------------- 5) DENIED DURING MONTH ----------------- */
DENIED_APPL_INFO AS (
    SELECT C.OFC_CD, OFC.OFC_NM, H.FS_SUFX, PC.SYS_CLSRE_DNL_RSN,
           PC.RCRT_APL_DT, RPT.RPT_BEG_DT, RPT.RPT_END_DT
    FROM W026DTF1.TWNFAM_CASELD_CASE C
    JOIN OFFICES OFC ON OFC.OFC_CD = C.OFC_CD
    JOIN W026DTF1.TWNFAM_CASE_HSTRY H ON H.ICI = C.ICI
    JOIN W026DTF1.TWNPRGM_CASE_HSTRY PC
      ON PC.ICI = C.ICI AND PC.PRGM_CASE_TYPE = 'FS'
    JOIN RPT_DATES RPT ON 1=1
    WHERE H.PRD_BEG_DT <= RPT.RPT_END_DT
      AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= RPT.RPT_END_DT
      AND PC.STS_EFF_DT BETWEEN RPT.RPT_BEG_DT AND RPT.RPT_END_DT
      AND PC.PRGM_CASE_STS = 'D'
      AND PC.CLSRE_RSN_CD <> 'W'
),
MAIN4 AS (
    SELECT
        D.OFC_CD, D.OFC_NM,
        SUM(CASE WHEN D.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PATOT,
        SUM(CASE WHEN D.FS_SUFX IN ('P','S','G','A') AND D.RCRT_APL_DT BETWEEN D.RPT_BEG_DT AND D.RPT_END_DT THEN 1 ELSE 0 END) AS PADENY_NEW,
        SUM(CASE WHEN D.FS_SUFX IN ('P','S','G','A') AND (D.RCRT_APL_DT IS NULL OR D.RCRT_APL_DT < D.RPT_BEG_DT OR D.RCRT_APL_DT > D.RPT_END_DT) THEN 1 ELSE 0 END) AS PADENY_SUBS,
        SUM(CASE WHEN D.FS_SUFX IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN = '11' THEN 1 ELSE 0 END) AS PADENY,
        SUM(CASE WHEN D.FS_SUFX IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN = '08' THEN 1 ELSE 0 END) AS PANCOOP,
        SUM(CASE WHEN D.FS_SUFX IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN = '10' THEN 1 ELSE 0 END) AS PAQUIT,
        SUM(CASE WHEN D.FS_SUFX IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN = '20' THEN 1 ELSE 0 END) AS PARSRC,
        SUM(CASE WHEN D.FS_SUFX IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN NOT IN ('11','08','10','20') THEN 1 ELSE 0 END) AS PAOTHR,
        SUM(CASE WHEN D.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NATOT,
        SUM(CASE WHEN D.FS_SUFX NOT IN ('P','S','G','A') AND D.RCRT_APL_DT BETWEEN D.RPT_BEG_DT AND D.RPT_END_DT THEN 1 ELSE 0 END) AS NADENY_NEW,
        SUM(CASE WHEN D.FS_SUFX NOT IN ('P','S','G','A') AND (D.RCRT_APL_DT IS NULL OR D.RCRT_APL_DT < D.RPT_BEG_DT OR D.RCRT_APL_DT > D.RPT_END_DT) THEN 1 ELSE 0 END) AS NADENY_SUBS,
        SUM(CASE WHEN D.FS_SUFX NOT IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN = '11' THEN 1 ELSE 0 END) AS NADENY,
        SUM(CASE WHEN D.FS_SUFX NOT IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN = '08' THEN 1 ELSE 0 END) AS NANCOOP,
        SUM(CASE WHEN D.FS_SUFX NOT IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN = '10' THEN 1 ELSE 0 END) AS NAQUIT,
        SUM(CASE WHEN D.FS_SUFX NOT IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN = '20' THEN 1 ELSE 0 END) AS NARSRC,
        SUM(CASE WHEN D.FS_SUFX NOT IN ('P','S','G','A') AND D.SYS_CLSRE_DNL_RSN NOT IN ('11','08','10','20') THEN 1 ELSE 0 END) AS NAOTHR
    FROM DENIED_APPL_INFO D
    GROUP BY D.OFC_CD, D.OFC_NM
),

/* ----------------- 6) APPLICATIONS PROCESSED DURING MONTH ----------------- */
APPL_PRC_INFO AS (
    SELECT C.OFC_CD, OFC.OFC_NM, H.FS_SUFX,
           PC.PRGM_CASE_STS, PC.RCRT_APL_DT, PC.PRD_BEG_DT, PC.PRD_END_DT
    FROM W026DTF1.TWNFAM_CASELD_CASE C
    JOIN OFFICES OFC ON OFC.OFC_CD = C.OFC_CD
    JOIN W026DTF1.TWNFAM_CASE_HSTRY H ON H.ICI = C.ICI
    JOIN W026DTF1.TWNPRGM_CASE_HSTRY PC
      ON PC.ICI = C.ICI AND PC.PRGM_CASE_TYPE = 'FS'
    JOIN RPT_DATES RPT ON 1=1
    WHERE H.PRD_BEG_DT <= RPT.RPT_END_DT
      AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= RPT.RPT_END_DT
      AND PC.RCRT_APL_DT BETWEEN RPT.RPT_BEG_DT AND RPT.RPT_END_DT
      AND PC.PRD_BEG_DT <= RPT.RPT_END_DT
      AND COALESCE(PC.PRD_END_DT, DATE('9999-12-31')) >= RPT.RPT_END_DT
),
MAIN5 AS (
    SELECT
        A.OFC_CD, A.OFC_NM,
        SUM(CASE WHEN A.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAAPPLMTH,
        SUM(CASE WHEN A.FS_SUFX IN ('P','S','G','A') AND A.PRGM_CASE_STS = 'P' THEN 1 ELSE 0 END) AS PAPNDMTH,
        SUM(CASE WHEN A.FS_SUFX IN ('P','S','G','A') AND A.PRGM_CASE_STS = 'O' THEN 1 ELSE 0 END) AS PAAPPRVMTH,
        SUM(CASE WHEN A.FS_SUFX IN ('P','S','G','A') AND A.PRGM_CASE_STS IN ('D','T') THEN 1 ELSE 0 END) AS PADNYWDMTH,
        SUM(CASE WHEN A.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAAPPLMTH,
        SUM(CASE WHEN A.FS_SUFX NOT IN ('P','S','G','A') AND A.PRGM_CASE_STS = 'P' THEN 1 ELSE 0 END) AS NAPNDMTH,
        SUM(CASE WHEN A.FS_SUFX NOT IN ('P','S','G','A') AND A.PRGM_CASE_STS = 'O' THEN 1 ELSE 0 END) AS NAAPPRVMTH,
        SUM(CASE WHEN A.FS_SUFX NOT IN ('P','S','G','A') AND A.PRGM_CASE_STS IN ('D','T') THEN 1 ELSE 0 END) AS NADNYWDMTH
    FROM APPL_PRC_INFO A
    GROUP BY A.OFC_CD, A.OFC_NM
),

/* ----------------- 7) TERMINATIONS DURING MONTH ----------------- */
TERMI_NATIONS_INFO AS (
    SELECT C.OFC_CD, OFC.OFC_NM, H.FS_SUFX
    FROM W026DTF1.TWNFAM_CASELD_CASE C
    JOIN OFFICES OFC ON OFC.OFC_CD = C.OFC_CD
    JOIN W026DTF1.TWNFAM_CASE_HSTRY H ON H.ICI = C.ICI
    JOIN W026DTF1.TWNPRGM_CASE_HSTRY PC
      ON PC.ICI = C.ICI AND PC.PRGM_CASE_TYPE = 'FS'
    JOIN RPT_DATES RPT ON 1=1
    WHERE H.PRD_BEG_DT <= RPT.RPT_END_DT
      AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= RPT.RPT_END_DT
      AND PC.PRD_BEG_DT <= RPT.RPT_END_DT
      AND COALESCE(PC.PRD_END_DT, DATE('9999-12-31')) >= RPT.RPT_END_DT
      AND PC.STS_EFF_DT BETWEEN RPT.RPT_BEG_DT AND RPT.RPT_END_DT
      AND PC.PRGM_CASE_STS = 'T'
),
MAIN6 AS (
    SELECT
        T.OFC_CD, T.OFC_NM,
        SUM(CASE WHEN T.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PATERM,
        SUM(CASE WHEN T.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NATERM
    FROM TERMI_NATIONS_INFO T
    GROUP BY T.OFC_CD, T.OFC_NM
),

/* Union of offices appearing anywhere to ensure all display */
ALL_OFFICES AS (
    SELECT OFC_CD, OFC_NM FROM OFFICES
    UNION SELECT OFC_CD, OFC_NM FROM MAIN
    UNION SELECT OFC_CD, OFC_NM FROM MAIN1
    UNION SELECT OFC_CD, OFC_NM FROM MAIN2
    UNION SELECT OFC_CD, OFC_NM FROM MAIN3
    UNION SELECT OFC_CD, OFC_NM FROM MAIN4
    UNION SELECT OFC_CD, OFC_NM FROM MAIN5
    UNION SELECT OFC_CD, OFC_NM FROM MAIN6
)

SELECT
    'JANUARY, 2025' AS RPT_MONTH,
    AO.OFC_NM,
    /* Active caseload */
    COALESCE(M.PACASES, 0) AS PACASES,
    COALESCE(M.NACASES, 0) AS NACASES,
    COALESCE(M.PAEXPCASE, 0) AS PAEXPCASE,
    COALESCE(M.NAEXPCASE, 0) AS NAEXPCASE,
    COALESCE(M.PAEBTCASE, 0) AS PAEBTCASE,
    COALESCE(M.NAEBTCASE, 0) AS NAEBTCASE,
    COALESCE(M.DMIEBT, 0) AS DMIEBT,
    COALESCE(M.PADAMS, 0) AS PADAMS,
    COALESCE(M.NADAMS, 0) AS NADAMS,
    COALESCE(M.PASPHNDL, 0) AS PASPHNDL,
    COALESCE(M.NASPHNDL, 0) AS NASPHNDL,
    COALESCE(M.DMI0_COUNT, 0) AS DMI0_COUNT,
    COALESCE(M.DMI1_COUNT, 0) AS DMI1_COUNT,
    COALESCE(M.DMI2_COUNT, 0) AS DMI2_COUNT,
    COALESCE(M.DMI3_COUNT, 0) AS DMI3_COUNT,
    COALESCE(M.DMI4_COUNT, 0) AS DMI4_COUNT,
    COALESCE(M.DMI5_COUNT, 0) AS DMI5_COUNT,
    COALESCE(M.DMI6_COUNT, 0) AS DMI6_COUNT,
    COALESCE(M.PAMRC, 0) AS PAMRC,
    COALESCE(M.NAMRC, 0) AS NAMRC,

    /* Last-month caseload */
    COALESCE(M1.PAREVISED, 0) AS PAREVISED,
    COALESCE(M1.NAREVISED, 0) AS NAREVISED,
    COALESCE(M1.PALMISS, 0) AS PALMISS,
    COALESCE(M1.NALMISS, 0) AS NALMISS,

    /* Full benefits — NULL-safe */
    COALESCE(M2.PABNFT, 0) AS PABNFT,
    COALESCE(M2.PABNFT_NEW, 0) AS PABNFT_NEW,
    COALESCE(M2.PABNFT_SUBS, 0) AS PABNFT_SUBS,
    COALESCE(M2.NABNFT, 0) AS NABNFT,
    COALESCE(M2.NABNFT_NEW, 0) AS NABNFT_NEW,
    COALESCE(M2.NABNFT_SUBS, 0) AS NABNFT_SUBS,

    /* Withdrawn / Denied / Applications / Terminations */
    COALESCE(M3.PAWTDR, 0) AS PAWTDR,
    COALESCE(M3.PAWTDR_NEW, 0) AS PAWTDR_NEW,
    COALESCE(M3.PAWTDR_SUBS, 0) AS PAWTDR_SUBS,
    COALESCE(M3.NAWTDR, 0) AS NAWTDR,
    COALESCE(M3.NAWTDR_NEW, 0) AS NAWTDR_NEW,
    COALESCE(M3.NAWTDR_SUBS, 0) AS NAWTDR_SUBS,

    COALESCE(M4.PATOT, 0) AS PATOT,
    COALESCE(M4.PADENY_NEW, 0) AS PADENY_NEW,
    COALESCE(M4.PADENY_SUBS, 0) AS PADENY_SUBS,
    COALESCE(M4.PADENY, 0) AS PADENY,
    COALESCE(M4.PANCOOP, 0) AS PANCOOP,
    COALESCE(M4.PAQUIT, 0) AS PAQUIT,
    COALESCE(M4.PARSRC, 0) AS PARSRC,
    COALESCE(M4.PAOTHR, 0) AS PAOTHR,
    COALESCE(M4.NATOT, 0) AS NATOT,
    COALESCE(M4.NADENY_NEW, 0) AS NADENY_NEW,
    COALESCE(M4.NADENY_SUBS, 0) AS NADENY_SUBS,
    COALESCE(M4.NADENY, 0) AS NADENY,
    COALESCE(M4.NANCOOP, 0) AS NANCOOP,
    COALESCE(M4.NAQUIT, 0) AS NAQUIT,
    COALESCE(M4.NARSRC, 0) AS NARSRC,
    COALESCE(M4.NAOTHR, 0) AS NAOTHR,

    COALESCE(M5.PAAPPLMTH, 0) AS PAAPPLMTH,
    COALESCE(M5.PAPNDMTH, 0) AS PAPNDMTH,
    COALESCE(M5.PAAPPRVMTH, 0) AS PAAPPRVMTH,
    COALESCE(M5.PADNYWDMTH, 0) AS PADNYWDMTH,
    COALESCE(M5.NAAPPLMTH, 0) AS NAAPPLMTH,
    COALESCE(M5.NAPNDMTH, 0) AS NAPNDMTH,
    COALESCE(M5.NAAPPRVMTH, 0) AS NAAPPRVMTH,
    COALESCE(M5.NADNYWDMTH, 0) AS NADNYWDMTH,

    COALESCE(M6.PATERM, 0) AS PATERM,
    COALESCE(M6.NATERM, 0) AS NATERM

FROM ALL_OFFICES AO
LEFT JOIN MAIN  M  ON AO.OFC_CD = M.OFC_CD
LEFT JOIN MAIN1 M1 ON AO.OFC_CD = M1.OFC_CD
LEFT JOIN MAIN2 M2 ON AO.OFC_CD = M2.OFC_CD
LEFT JOIN MAIN3 M3 ON AO.OFC_CD = M3.OFC_CD
LEFT JOIN MAIN4 M4 ON AO.OFC_CD = M4.OFC_CD
LEFT JOIN MAIN5 M5 ON AO.OFC_CD = M5.OFC_CD
LEFT JOIN MAIN6 M6 ON AO.OFC_CD = M6.OFC_CD
ORDER BY AO.OFC_NM;
