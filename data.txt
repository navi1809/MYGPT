-- Replace LST_MTH_CSLD with:
LST_MTH_ISSUANCE AS (
  SELECT
    T1.OFC_CD, OFC.OFC_NM, T2.ICI, T2.FS_SUFX,
    T3.ISNCE_DT, RPT.RPT_BEG_DT, RPT.RPT_END_DT,
    ROW_NUMBER() OVER (PARTITION BY T2.ICI ORDER BY T3.ISNCE_DT DESC) AS rn
  FROM {?SCHEMA}.TWNFAM_CASELD_CASE T1
  JOIN {?SCHEMA}.TWNFAM_CASE_HSTRY   T2 ON T1.ICI = T2.ICI
  JOIN {?SCHEMA}.TWNFS_ISNCE         T3 ON T2.ICI = T3.ICI
  JOIN OFFICE_DATA OFC ON T1.OFC_CD = OFC.OFC_CD
  JOIN RPT_DATES RPT ON 1=1
  WHERE
    T2.PRD_BEG_DT <= RPT.RPT_END_DT
    AND T2.PRD_END_DT >= RPT.RPT_END_DT
    AND T3.BNFT_MTH = RPT.PREV_RPT_MTH
    AND T3.BNFT_YR  = RPT.PREV_RPT_YR
    AND T3.BNFT_TYPE = 'RG'
    AND T3.FS_ISNCE_STS IN ('IS','RD')
),
LST_MTH_CSLD AS (
  SELECT OFC_CD, OFC_NM, ICI, FS_SUFX, ISNCE_DT, RPT_BEG_DT, RPT_END_DT
  FROM LST_MTH_ISSUANCE
  WHERE rn = 1  -- <-- one row per ICI for the month
),
MAIN1 AS (
  SELECT
    OFC_CD, OFC_NM,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAREVISED,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAREVISED,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') AND ISNCE_DT BETWEEN RPT_BEG_DT AND RPT_END_DT THEN 1 ELSE 0 END) AS PALMISS,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') AND ISNCE_DT BETWEEN RPT_BEG_DT AND RPT_END_DT THEN 1 ELSE 0 END) AS NALMISS
  FROM LST_MTH_CSLD
  GROUP BY OFC_CD, OFC_NM
)
