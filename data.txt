-- Full benefits by office (TOTAL, PA, NA) for Jan 2025
-- Logic mirrors AME37A S04/READ-S02 exactly:
-- 1) For each ICI, take the MIN ACTN_TS where ACTN_TYP='AP' within the report window
--    and the case belongs to an Admin office (PRGM_OFC_TYPE='A').  (AME37P9-SETINQ-S04)
-- 2) Look up the PREVIOUS action before that AP (same ICI, PRGM_TYP='FS',
--    MAX(ACTN_TS) < AP_TS) and keep only if it is in ('FA','RE','RI'). (AME37P9-READ-S02)
-- 3) Get FS_SUFX as of the report end date from CASE_HSTRY
--    (PRD_BEG_DT <= :END_DT AND PRD_END_DT >= :END_DT). (AME37P9-READ-S02)

WITH
params AS (
  SELECT
    TIMESTAMP('2025-01-01 00:00:00') AS beg_ts,
    TIMESTAMP('2025-01-31 23:59:59') AS end_ts,
    DATE('2025-01-31')               AS rpt_end_dt
),

-- (1) Earliest AP action in window per ICI, restricted to admin offices
ap_per_ici AS (
  SELECT
    c.OFC_CD,
    a.ICI,
    MIN(a.ACTN_TS) AS ap_ts
  FROM W026DTF1.TWNFAM_ACTNS      a
  JOIN W026DTF1.TWNFAM_CASELD_CASE c
    ON c.ICI = a.ICI
  WHERE c.PRGM_OFC_TYPE = 'A'
    AND a.PRGM_TYP = 'FS'
    AND a.ACTN_TYP = 'AP'
    AND a.ACTN_TS BETWEEN (SELECT beg_ts FROM params) AND (SELECT end_ts FROM params)
  GROUP BY c.OFC_CD, a.ICI
),

-- (2) Previous FS action before that AP per ICI
prev_act AS (
  SELECT
    x.OFC_CD,
    x.ICI,
    MAX(a2.ACTN_TS) AS prev_ts
  FROM ap_per_ici x
  JOIN W026DTF1.TWNFAM_ACTNS a2
    ON a2.ICI = x.ICI
   AND a2.PRGM_TYP = 'FS'
   AND a2.ACTN_TS < x.ap_ts
  GROUP BY x.OFC_CD, x.ICI
),

-- (2b) Bring the previous action row to check its ACTN_TYP
prev_act_row AS (
  SELECT
    p.OFC_CD,
    p.ICI,
    a.ACTN_TYP AS prev_actn_typ
  FROM prev_act p
  JOIN W026DTF1.TWNFAM_ACTNS a
    ON a.ICI = p.ICI
   AND a.ACTN_TS = p.prev_ts
),

-- (3) FS suffix as of report end date (point-in-time)
suffix_asof AS (
  SELECT
    h.ICI,
    h.FS_SUFX
  FROM W026DTF1.TWNFAM_CASE_HSTRY h
  WHERE h.PRD_BEG_DT <= (SELECT rpt_end_dt FROM params)
    AND h.PRD_END_DT >= (SELECT rpt_end_dt FROM params)
)

SELECT
  b.OFC_CD,
  COUNT(*) AS full_benefits_total,
  SUM(CASE WHEN s.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS pa_benefits,
  SUM(CASE WHEN s.FS_SUFX IN ('P','S','G','A') THEN 0 ELSE 1 END) AS na_benefits
FROM ap_per_ici b
JOIN prev_act_row r
  ON r.OFC_CD = b.OFC_CD
 AND r.ICI    = b.ICI
JOIN suffix_asof s
  ON s.ICI = b.ICI
WHERE r.prev_actn_typ IN ('FA','RE','RI')
GROUP BY b.OFC_CD
ORDER BY b.OFC_CD;
