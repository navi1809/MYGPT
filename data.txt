WITH INPUT_QUERY AS (
SELECT
	T2.BNFT_MTH,
	T2.BNFT_YR,
	T1.ICI,
	T1.PRGM_CASE_STS,
	T1.PRGM_CASE_TYPE,
	T1.AID_CD,
	T2.WTHDR_TST_RSLT_CD,
	T2.APL_DTH_TSTRSL_CD,
	T2.RSDN_TST_RSLT_CD,
	T2.AGDDIS_ST_TSTRS_CD,
	T2.VRF_TST_RSLT_CD,
	T2.SSN_TEST_RSLT_CD,
	T2.COOP_TEST_RSLT_CD,
	T2.MRF_COMP_TSTRSL_CD,
	T2.VER_NMB,
	(SELECT TCH.HOH_UPI FROM W026DT91.TWNFAM_CASE_HSTRY TCH WHERE TCH.ICI = T1.ICI AND TCH.PRD_BEG_DT <= '2024-07-01' AND TCH.PRD_END_DT >= '2024-07-01' FETCH FIRST 1 ROW ONLY) AS HOH_UPI,
	T6.OFC_NM,
	T5.OFC_CD,
	T5.CASLD_ID,
	T5.CASLD_EFF_DT
FROM
    W026DT91.TWNPRGM_CASE_HSTRY T1,
    W026DT91.TWNELIG_VERSION T2,
    W026DT91.TWNFAM_CASELD_CASE T5,
    W026DT91.TWNOFFICE T6
WHERE
	T1.PRGM_CASE_TYPE = 'MA'
	AND T1.PRGM_CASE_STS IN ('T', 'D')
	AND T1.PRD_BEG_DT <= '2024-07-01'
	AND T1.PRD_END_DT >= '2024-07-01'
	AND T2.PRGM_CASE_TYPE = 'MA'
	AND T2.LST_POSTD_VER_IND = 'Y'
	AND T2.BNFT_MTH = VARCHAR_FORMAT('2024-07-01', 'MM')
	AND T2.BNFT_YR = VARCHAR_FORMAT('2024-07-01', 'YYYY')
    AND T2.ICI = T1.ICI
    AND T5.ICI = T1.ICI AND T5.CASLD_EFF_DT = (SELECT MAX(CASLD_EFF_DT) FROM W026DT91.twnfam_caseld_case WHERE ICI = T1.ICI)
    AND T6.OFC_CD = T5.OFC_CD
)
,
BUDGET_UNIT AS (
SELECT
	T8.ICI, T8.GRS_INC_TST_RSLTCD, T8.RSRCS_TST_RSLT_CD
FROM W026DT91.TWNELG_BDGT_UNIT T8
JOIN INPUT_QUERY IQ ON T8.ICI = IQ.ICI
WHERE
	T8.BU_NMB = (
	SELECT
		LST_BU_CNSD
	FROM
		W026DT91.TWNELG_VER_MBR
	WHERE
		PRGM_CASE_TYPE = IQ.PRGM_CASE_TYPE
		AND BNFT_YR = IQ.BNFT_YR
		AND BNFT_MTH = IQ.BNFT_MTH
		AND VER_NMB = IQ.VER_NMB
		AND UPI = IQ.HOH_UPI
        )
	AND T8.BNFT_MTH = IQ.BNFT_MTH
	AND T8.VER_NMB = IQ.VER_NMB
	AND T8.PRGM_CASE_TYPE = IQ.PRGM_CASE_TYPE
)
 
 
SELECT
	UPPER(TO_CHAR('2024-07-01', 'Month')) || ', ' || VARCHAR_FORMAT('2024-07-01', 'YYYY') AS RPT_MONTH,
	IQ.BNFT_MTH,
	IQ.BNFT_YR,
	IQ.ICI,
	IQ.PRGM_CASE_STS,
	IQ.PRGM_CASE_TYPE,
	IQ.AID_CD,
	IQ.OFC_CD,
	IQ.OFC_NM,
	IQ.CASLD_ID,
	IQ.HOH_UPI,
	CASE
		WHEN WTHDR_TST_RSLT_CD = 'F' THEN 1
		WHEN APL_DTH_TSTRSL_CD = 'F' THEN 2
		WHEN RSDN_TST_RSLT_CD = 'F' THEN 3
		WHEN AGDDIS_ST_TSTRS_CD = 'F' THEN 4
		WHEN VRF_TST_RSLT_CD = 'F' OR SSN_TEST_RSLT_CD = 'F' OR COOP_TEST_RSLT_CD = 'F' OR MRF_COMP_TSTRSL_CD = 'F' THEN 5
		WHEN BUNIT.RSRCS_TST_RSLT_CD = 'F' THEN 7
		WHEN BUNIT.GRS_INC_TST_RSLTCD = 'F' THEN 8
		ELSE 6
	END AS RSN_CD,
	CASE
		WHEN WTHDR_TST_RSLT_CD = 'F' THEN 'CASE WITHDRAWL'
		WHEN APL_DTH_TSTRSL_CD = 'F' THEN 'DEATH'
		WHEN RSDN_TST_RSLT_CD = 'F' THEN 'NOT MEETING RESIDENCE REQ'
		WHEN AGDDIS_ST_TSTRS_CD = 'F' THEN 'FAILED AGED/DIS REQUIREMENTS'
		WHEN VRF_TST_RSLT_CD = 'F' OR SSN_TEST_RSLT_CD = 'F' OR COOP_TEST_RSLT_CD = 'F' OR MRF_COMP_TSTRSL_CD = 'F' THEN 'FAILED TO COOPERATE'
		WHEN BUNIT.RSRCS_TST_RSLT_CD = 'F' THEN 'FAILED RESOURCE TEST'
		WHEN BUNIT.GRS_INC_TST_RSLTCD = 'F' THEN 'FAILED GROSS INCOME TEST'
		ELSE 'FAILED ALL CATEGORIES'
	END AS RSN,
	IQ.WTHDR_TST_RSLT_CD,
	IQ.APL_DTH_TSTRSL_CD,
	IQ.RSDN_TST_RSLT_CD,
	IQ.AGDDIS_ST_TSTRS_CD,
	IQ.VRF_TST_RSLT_CD,
	IQ.SSN_TEST_RSLT_CD,
	IQ.COOP_TEST_RSLT_CD,
	IQ.MRF_COMP_TSTRSL_CD,
	IQ.VER_NMB,
	IQ.CASLD_EFF_DT
FROM
	INPUT_QUERY IQ
LEFT JOIN BUDGET_UNIT BUNIT ON
	BUNIT.ICI = IQ.ICI
ORDER BY
	IQ.PRGM_CASE_STS,
	IQ.OFC_NM;
