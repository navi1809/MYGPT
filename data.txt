-- Full benefits by office (TOTAL, PA, NA) for Jan 2025 — aligned to AME37A S04 logic
-- Key points:
--  • Take AP actions in the month (FAC = current action).
--  • Find the previous FS action before that AP (FCH); keep only if in ('FA','RE','RI').
--  • Classify PA/NA using FS_SUFX from CASE_HSTRY as-of the AP action date.
--  • Count by office (Admin offices only: PRGM_OFC_TYPE='A').

SELECT
  C.OFC_CD,
  COUNT(*) AS FULL_BENEFITS_TOTAL,
  SUM(CASE WHEN HS.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PA_BENEFITS,
  SUM(CASE WHEN HS.FS_SUFX IN ('P','S','G','A') THEN 0 ELSE 1 END) AS NA_BENEFITS
FROM W026DTF1.TWNFAM_ACTNS FAC                                   -- current AP action
JOIN W026DTF1.TWNFAM_CASELD_CASE C
  ON C.ICI = FAC.ICI
 AND C.PRGM_OFC_TYPE = 'A'
JOIN W026DTF1.TWNFAM_ACTNS FCH                                   -- previous FS action
  ON FCH.ICI = FAC.ICI
 AND FCH.ACTN_TS = (
       SELECT MAX(F2.ACTN_TS)
         FROM W026DTF1.TWNFAM_ACTNS F2
        WHERE F2.ICI = FAC.ICI
          AND F2.PRGM_TYP = 'FS'
          AND F2.ACTN_TS <  FAC.ACTN_TS
     )
JOIN W026DTF1.TWNFAM_CASE_HSTRY HS                                -- suffix as-of AP date
  ON HS.ICI = FAC.ICI
 AND HS.PRD_BEG_DT <= DATE(FAC.ACTN_TS)
 AND COALESCE(HS.PRD_END_DT, DATE('9999-12-31')) >= DATE(FAC.ACTN_TS)
WHERE FAC.PRGM_TYP = 'FS'
  AND FAC.ACTN_TYP = 'AP'                                         -- approval month actions
  AND FCH.ACTN_TYP IN ('FA','RE','RI')                            -- prior full-benefit action
  AND FAC.ACTN_TS >= TIMESTAMP('2025-01-01-00.00.00')
  AND FAC.ACTN_TS <= TIMESTAMP('2025-01-31-23.59.59')
GROUP BY C.OFC_CD
ORDER BY C.OFC_CD;
