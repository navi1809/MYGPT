package PGM_C_Batch;
import egl.core.*;
import CommonMigratedParts.*;
import DataItems.*;
import DataTables.*;

//*** PROGRAM=CAL11A ****
// COMPONENT NAME: CAL11A CALLED BATCH  CAL11A
// ===============
// 
// DESCRIPTION:
// ============
// THIS APPLICATION CREATES THE ALERTS TRIGGERED BY THE SYSTEM.
// IT IS CALLED BY VARIOUS APPLICATIONS, WHEN IT IS NECESSARY
// TO CREATE/UPDATE/DELETE AN ALERT.
// 
// RETURN CODES:
// 0 - Successful request
// 100 - No record found
// 104 - Duplicate key
// 108 - Deadlock/timeout
// 112 - Other SQL error
// 
// 
// ***********************
Program CAL11A type basicProgram //VAGen Info - called batch program
  (
   VDBCONTROL VDBCONTROL, // record
   VMESSAGE VMESSAGE, // record
   PCALINP PCALINP // record
  )
  {
  includeReferencedFunctions = yes, allowUnqualifiedItemReferences = yes, 
  throwNrfEofExceptions = yes, handleHardIOErrors = no, V60ExceptionCompatibility = yes, 
  I4GLItemsNullable = no, textLiteralDefaultIsString = no, localSQLScope = yes
  }

  // Data Declarations
  CAL11W CAL11W; // record
  CEP01W CEP01W; // record
  G-IV-D G-IV-D; // record
  GDW GDW; // record
  GNOMADS GNOMADS; // record
  H-TALCS1 H-TALCS1; // record
  H-TCMHC8 H-TCMHC8; // record
  H-TDCCS1 H-TDCCS1; // record
  H-TDCHC1 H-TDCHC1; // record
  H-TFACS1 H-TFACS1; // record
  H-TFCCS1 H-TFCCS1; // record
  H-TIAAD1 H-TIAAD1; // record
  H-TIAAI1 H-TIAAI1; // record
  H-TIDAD1 H-TIDAD1; // record
  H-TIDAI1 H-TIDAI1; // record
  H-TIDAU1 H-TIDAU1; // record
  H-TIDCC1 H-TIDCC1; // record
  H-TIDCC2 H-TIDCC2; // record
  H-TIFAD1 H-TIFAD1; // record
  H-TIFAI1 H-TIFAI1; // record
  H-TIRAD2 H-TIRAD2; // record
  H-TIRAI1 H-TIRAI1; // record
  H-TPERS5 H-TPERS5; // record
  H-TRPDSA H-TRPDSA; // record
  H2-IVD-CASE H2-IVD-CASE; // record
  H2-IVD-CASELD-CASE H2-IVD-CASELD-CASE; // record
  P-DATE-REC1 P-DATE-REC1; // record
  VDBCOMMON VDBCOMMON; // record

  // VAGen Info - items needed for migration
  VAGen_EZESYS char(8);
  VAGen_EZEREPLY num(1);
  VAGen_EZE_WAIT_TIME bin(9,2);
  VAGen_EZE_ITEMLEN int;

  // Use Declarations
  use VDB00T1 {deleteAfterUse = yes}; // table

  function main()
    // VAGen Info - initialization needed for migration
    VAGen_EZESYS = VGLib.getVAGSysType();
    CAL11P9-MAINPROC: CAL11P9-MAINPROC();
  end // end main
end // end CAL11A


// Control Retrieve of Data
Function CAL11P9-CASES()
  /*  */
  CAL11W.WS-NCP-UPI-N = PCALINP.PAL-UPI;
  CAL11W.WS-CST-UPI = PCALINP.PAL-UPI;
  CAL11W.WS-CHD-UPI = PCALINP.PAL-UPI;

  WDB00PI();
  CAL11P9-GET-CASES();
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end

  CAL11P9-CASES-SCAN();
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end

  while (sysVar.sqlData.sqlcode == 0)

    CAL11W.WS-NCP-UPI = H2-IVD-CASE.NCP-UPI;
    CAL11W.WS-CASE-SUFX = H2-IVD-CASE.CASE-SUFX;

    if (PCALINP.PAL-ALERT-ACTION == "C") /* CREATE*/

      CAL11P9-CRT-IVDALT();

    else
      if (PCALINP.PAL-ALERT-ACTION == "U") /* (UPDATE)*/
        CAL11P9-UPD-IVDALT();
      else
        if (PCALINP.PAL-ALERT-ACTION == "D") /* (DELETE)*/
          CAL11P9-DEL-IVDALT();
        end
      end
    end

    CAL11P9-CASES-SCAN();

    WDB00PE-SQLERR();
    if (VDBCONTROL.URC > 104)
      exit program;
    end
  end
end // end CAL11P9-CASES


// SELECT DATA FROM DATABASE
Function CAL11P9-CASES-SCAN()
  /*  */
  VDBCONTROL.UPROC-OBJ = "H2-IVD-CASE";
  VDBCONTROL.UPROC-OPT = "SCAN";
  VDBCONTROL.UPROC-NM = "CAL11P9-CASES-SCAN";
  VDBCOMMON.USQLREC = "H2-IVD-CASE";
  /*  */
  try
    get next H2-IVD-CASE ;
  end
end // end CAL11P9-CASES-SCAN


// SELECT DATA FROM DATABASE
Function CAL11P9-CASLD-SCAN()
  /*  */
  VDBCONTROL.UPROC-OBJ = "H2-IVD-CASELD-CASE";
  VDBCONTROL.UPROC-OPT = "SCAN";
  VDBCONTROL.UPROC-NM = "CAL11P9-CASLD-SCAN";
  VDBCOMMON.USQLREC = "H2-IVD-CASELD-CASE";
  /*  */
  try
    get next H2-IVD-CASELD-CASE ;
  end
end // end CAL11P9-CASLD-SCAN


// CREATES RECORD IN IVA ALERT
Function CAL11P9-CRE-IVAALT()
  /* THIS PROCESS GETS THE CASELOAD ASSOCIATED WITH THE CASE ID AND*/
  /* CREATES A RECORD IN IVA ALERT TABLE*/

  /* GET THE CASELOAD ASSOCIATED WITH THE CASE ID*/
  /* **----------------PHASE2 REWORK START-------------------------***/
  if (PCALINP.PAL-SUFFIX == "U" || 
  PCALINP.PAL-SUFFIX == " ")
  /* **----------------PHASE2 REWORK END  -------------------------***/
    H-TFACS1.ICI = CAL11W.WS-ICI;

    call "TFACS1A" (VDBCONTROL, VMESSAGE, H-TFACS1) {isNoRefresh = yes};
    if (VDBCONTROL.URC > 104)
      exit program;
    end

    if (VDBCONTROL.URC == 0)

  /* MOVE H-TFACS1.SPRVS-UNIT TO WS-SPRVS-UNIT;*/
  /* MOVE H-TFACS1.FUNC-AREA-CD TO WS-FUNC-AREA-CD;*/
  /* MOVE H-TFACS1.WRKR-TYPE TO WS-WRKR-TYPE;*/
  /* MOVE H-TFACS1.PSN-NMB TO WS-PSN-NMB;*/
  /*  */
  /* MOVE WS-CASELOAD TO H-TIAAI1.CASLD-ID;*/
  /* MOVE H-TFACS1.OFC-CD            TO H-TIAAI1.OFC-CD;*/
      H-TIAAI1.CASLD-ID = H-TFACS1.CASLD-ID;
      H-TIAAI1.OFC-CD = H-TFACS1.OFC-CD;
      H-TIAAI1.ICI = CAL11W.WS-ICI;
      H-TIAAI1.ALERT-CD = PCALINP.PAL-ALERT-CD;
      H-TIAAI1.DISPL-DT = CAL11W.WS-DISPL-DT;
      H-TIAAI1.DUE-DT = CAL11W.WS-DUE-DT;
      H-TIAAI1.OVRDU-DT = CAL11W.WS-OVRDU-DT;
      H-TIAAI1.DLT-ALERT-DT = CAL11W.WS-DLT-ALERT-DT;

      call "TIAAI1A" (VDBCONTROL, VMESSAGE, H-TIAAI1) {isNoRefresh = yes};
      if (VDBCONTROL.URC > 104)
        exit program;
      end
    end
  /* **-----------------PHASE2 REWORK START------------------***/
  else
    if (PCALINP.PAL-SUFFIX == "I")
     /* For I&R Alerts, PAL-PERS-CASE-ID must contain DEBTOR-SSN*/
      H-TRPDSA.DBTR-SSN = PCALINP.PAL-UPI;
      call "TRPDSAA" (VDBCONTROL, VMESSAGE, H-TRPDSA) {isNoRefresh = yes};
      if (VDBCONTROL.URC > 104)
        exit program;
      end
      if (VDBCONTROL.URC == 0)
        H-TIRAI1.OFC-CD = H-TRPDSA.OFC-CD;
        CAL11W.WS-SPRVS-UNIT = H-TRPDSA.SPRVS-UNIT;
        CAL11W.WS-FUNC-AREA-CD = H-TRPDSA.FUNC-AREA-CD;
        CAL11W.WS-WRKR-TYPE = H-TRPDSA.WRKR-TYPE;
        CAL11W.WS-PSN-NMB = H-TRPDSA.PSN-NMB;
        H-TIRAI1.DEBTLD-ID = CAL11W.WS-CASELOAD;
  /* **-----------PHASE1 RELEASE1 CHANGE START----------------***/
        H-TIRAI1.UPI = H-TRPDSA.UPI;
  /* **-----------PHASE1 RELEASE1 CHANGE END  ----------------***/
        H-TIRAI1.ALERT-CD = PAL-ALERT-CD;
        H-TIRAI1.DISPL-DT = CAL11W.WS-DISPL-DT;
        H-TIRAI1.DUE-DT = CAL11W.WS-DUE-DT;
        H-TIRAI1.OVRDU-DT = CAL11W.WS-OVRDU-DT;
        H-TIRAI1.DLT-ALERT-DT = CAL11W.WS-DLT-ALERT-DT;
        call "TIRAI1A" (VDBCONTROL, VMESSAGE, H-TIRAI1) {isNoRefresh = yes};
        if (VDBCONTROL.URC == 104)
          VMESSAGE.UMSGCODE = " ";
        end
        if (VDBCONTROL.URC > 104)
          exit program;
        end
      end
    end
  end
  /* **-----------------PHASE2 REWORK END  -----------------***/
end // end CAL11P9-CRE-IVAALT


// CREATE ALERT IN IVD_ALERT
Function CAL11P9-CRT-IVDALT()
  /* GET THE LATEST CASELOAD FOR THE CASE*/
  H2-IVD-CASELD-CASE.UPI = CAL11W.WS-NCP-UPI;
  H2-IVD-CASELD-CASE.CASE-SUFX = CAL11W.WS-CASE-SUFX;

  /* If alert already exists, delete it, perform case tracking, and create*/
  /* the new version of the alert*/

  CAL11P9-DEL-IVDALT();

  WDB00PI();
  CAL11P9-GET-CASELD();
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end
  CAL11P9-CASLD-SCAN();
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end

  while (sysVar.sqlData.sqlcode == 0)

    if (H2-IVD-CASELD-CASE.CASELD-IND == "N")
      CAL11W.WS-CASELD-ID-N = H2-IVD-CASELD-CASE.CASLD-ID;
      CAL11W.WS-OFC-CD-N = H2-IVD-CASELD-CASE.OFC-CD;
    else
      CAL11W.WS-CASELD-ID-C = H2-IVD-CASELD-CASE.CASLD-ID;
      CAL11W.WS-OFC-CD-C = H2-IVD-CASELD-CASE.OFC-CD;
    end

    CAL11P9-CASLD-SCAN();
    WDB00PE-SQLERR();
    if (VDBCONTROL.URC > 104)
      exit program;
    end

  end

  H-TIDAI1.CASLD-ID = CAL11W.WS-CASELD-ID-N;
  H-TIDAI1.OFC-CD = CAL11W.WS-OFC-CD-N;
  H-TIDAI1.C-CASLD-ID = CAL11W.WS-CASELD-ID-C;
  H-TIDAI1.C-OFC-CD = CAL11W.WS-OFC-CD-C;
  H-TIDAI1.UPI = CAL11W.WS-NCP-UPI;
  H-TIDAI1.CASE-SUFX = CAL11W.WS-CASE-SUFX;
  H-TIDAI1.ALERT-CD = PCALINP.PAL-ALERT-CD;
  H-TIDAI1.DISPL-DT = CAL11W.WS-DISPL-DT;
  H-TIDAI1.DUE-DT = CAL11W.WS-DUE-DT;
  CAL11W.WS-HYP-OVRDU-DT = CAL11W.WS-OVRDU-DT;
  CAL11W.WS-HYP1 = "-";
  CAL11W.WS-HYP2 = "-";
  H-TIDAI1.OVRDU-DT = CAL11W.WS-HYP-OVRDU-DT;
  H-TIDAI1.DLT-ALERT-DT = CAL11W.WS-DLT-ALERT-DT;


  call "TIDAI1A" (VDBCONTROL, VMESSAGE, H-TIDAI1) {isNoRefresh = yes};
  if (VDBCONTROL.URC == 104)
    VMESSAGE.UMSGCODE = " ";
  end
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end CAL11P9-CRT-IVDALT


// CREATE ALERT IN IVF_ALERT
Function CAL11P9-CRT-IVFALT()
  /* THIS PROCESS GETS THE CASELOAD ASSOCIATED WITH THE PARTICIPANT ID*/
  /* AND CREATES A RECORD IN IVF ALERT.*/

  /* GET THE CASELOAD ASSOCIATED WITH THE PARTICIPANT ID*/

  /* IT IS ASSUMED THAT PRTCP-ID IS GOING TO BE THE ONLY KEY IN*/
  /* ET_PARTICIPANT TABLE*/

  H-TFCCS1.PRTCP-ID = PCALINP.PAL-UPI;

  call "TFCCS1A" (VDBCONTROL, VMESSAGE, H-TFCCS1) {isNoRefresh = yes};
  if (VDBCONTROL.URC > 104)
    exit program;
  end

  if (VDBCONTROL.URC == 0)

  /* MOVE H-TFCCS1.SPRVS-UNIT TO CAL11W.WS-SPRVS-UNIT;*/
  /* MOVE H-TFCCS1.FUNC-AREA-CD TO CAL11W.WS-FUNC-AREA-CD;*/
  /* MOVE H-TFCCS1.WRKR-TYPE TO CAL11W.WS-WRKR-TYPE;*/
  /* MOVE H-TFCCS1.PSN-NMB TO CAL11W.WS-PSN-NMB;*/

  /* MOVE CAL11W.WS-CASELOAD TO H-TIFAI1.CASLD-ID;*/
    H-TIFAI1.CASLD-ID = H-TFCCS1.CASLD-ID;

   /* CASE-TYPE AND STS-EFF-DATE WILL NOT BE THERE IN IVF_ALERT TABLE*/
   /* IF PRTCP-ID IS GOING TO BE THE ONLY KEY IN ET_PARTICIPANT*/

    H-TIFAI1.PRTCP-ID = PCALINP.PAL-UPI;
    H-TIFAI1.ALERT-CD = PCALINP.PAL-ALERT-CD;
    H-TIFAI1.DISPL-DT = CAL11W.WS-DISPL-DT;
    H-TIFAI1.DUE-DT = CAL11W.WS-DUE-DT;
    H-TIFAI1.OVRDU-DT = CAL11W.WS-OVRDU-DT;
    H-TIFAI1.DLT-ALERT-DT = CAL11W.WS-DLT-ALERT-DT;
    H-TIFAI1.STS-EFF-DT = H-TFCCS1.STS-EFF-DT;

    H-TIFAI1.OFC-CD = H-TFCCS1.OFC-CD;

    call "TIFAI1A" (VDBCONTROL, VMESSAGE, H-TIFAI1) {isNoRefresh = yes};
    if (VDBCONTROL.URC == 104)
      VMESSAGE.UMSGCODE = " ";
    end
    if (VDBCONTROL.URC > 104)
      exit program;
    end
  end
end // end CAL11P9-CRT-IVFALT


// DATE CALCULATIONS
Function CAL11P9-DATE-CALC()
  /* IF DUE DATE/DISPLAY DATE IS ALREADY PASSED BY THE CALLING PROGRAM,*/
  /* BYPASS THE COMPUTATION OF THAT DATE*/

  /* CHANGING THE MM-DD-YYYY FORMAT TO YYYY-MM-DD*/

  /* CALL DATEAPP GDW,VDBCONTROL,VMESSAGE (NOMAPS;*/
  CAL11W.WS-N-IP-DT = GDW.DTLC;
  CAL11W.WS-N-OP-MM = CAL11W.WS-N-IP-MM;
  CAL11W.WS-N-OP-DD = CAL11W.WS-N-IP-DD;
  CAL11W.WS-N-OP-YYYY = CAL11W.WS-N-IP-YYYY;

  /* ----------------------PTR 4517 BEGIN---------------------------*/

  if (PCALINP.PAL-DISPL-DT == " "
   || PCALINP.PAL-DISPL-DT == "0001-01-01") /* PTR 7146*/
     /* CALLING A DATE COMPUTATION ROUTINE  TO ADD DAYS TO DATE*/

    P-DATE-REC1.C-INPUT-DATE = PCALINP.PAL-PROCESS-DT;
    P-DATE-REC1.N-ADD-DAYS = H-TALCS1.DISPL-DAYS;
    call "DATEA1A" (VDBCONTROL, VMESSAGE, P-DATE-REC1) {isNoRefresh = yes};
    if (VDBCONTROL.URC > 104)
      exit program;
    end
    CAL11W.WS-HYP-OVRDU-DT = P-DATE-REC1.C-OUTPUT-DATE;
    CAL11W.WS-HYP1 = "-";
    CAL11W.WS-HYP2 = "-";
    CAL11W.WS-DISPL-DT = CAL11W.WS-HYP-OVRDU-DT;

  else
    CAL11W.WS-DISPL-DT = PCALINP.PAL-DISPL-DT;
  end

  if (PCALINP.PAL-DUE-DT == " "
   || PCALINP.PAL-DUE-DT == "0001-01-01") /* PTR 7146*/


    P-DATE-REC1.C-INPUT-DATE = PCALINP.PAL-PROCESS-DT;
    P-DATE-REC1.N-ADD-DAYS = H-TALCS1.DUE-DAYS;
    call "DATEA1A" (VDBCONTROL, VMESSAGE, P-DATE-REC1) {isNoRefresh = yes};
    if (VDBCONTROL.URC > 104)
      exit program;
    end
    CAL11W.WS-HYP-OVRDU-DT = P-DATE-REC1.C-OUTPUT-DATE;
    CAL11W.WS-HYP1 = "-";
    CAL11W.WS-HYP2 = "-";
    CAL11W.WS-DUE-DT = CAL11W.WS-HYP-OVRDU-DT;
  else
    CAL11W.WS-DUE-DT = PCALINP.PAL-DUE-DT;
  end
  /* CALCULATE THE OVER DUE DATE FOR THE ALERT*/

  P-DATE-REC1.C-INPUT-DATE = PCALINP.PAL-PROCESS-DT;
  P-DATE-REC1.N-ADD-DAYS = H-TALCS1.OVRDU-DAYS;
  call "DATEA1A" (VDBCONTROL, VMESSAGE, P-DATE-REC1) {isNoRefresh = yes};
  if (VDBCONTROL.URC > 104)
    exit program;
  end
  CAL11W.WS-HYP-OVRDU-DT = P-DATE-REC1.C-OUTPUT-DATE;
  CAL11W.WS-HYP1 = "-";
  CAL11W.WS-HYP2 = "-";
  CAL11W.WS-OVRDU-DT = CAL11W.WS-HYP-OVRDU-DT;

  /* MOVE CAL11W.WS-N-OP-DT            TO CAL11W.WS-OVRDU-DT;*/

  /* CALCULATE THE ALERT DELETE DATE FOR THE ALERT*/

  if (H-TALCS1.AUTO-DLT-FG == "Y")

      /* IF AN ALERT CAN BE DELETED AUTOMATICALLY*/

    P-DATE-REC1.C-INPUT-DATE = PCALINP.PAL-PROCESS-DT;
    P-DATE-REC1.N-ADD-DAYS = H-TALCS1.AUTO-DLT-DAYS;
    call "DATEA1A" (VDBCONTROL, VMESSAGE, P-DATE-REC1) {isNoRefresh = yes};
    if (VDBCONTROL.URC > 104)
      exit program;
    end
    CAL11W.WS-HYP-OVRDU-DT = P-DATE-REC1.C-OUTPUT-DATE;
    CAL11W.WS-HYP1 = "-";
    CAL11W.WS-HYP2 = "-";
    CAL11W.WS-DLT-ALERT-DT = CAL11W.WS-HYP-OVRDU-DT;

  else
    CAL11W.WS-DLT-ALERT-DT = "9999-12-31";

  end
end // end CAL11P9-DATE-CALC


// DELETE RECORD IN IVA_ALERT
Function CAL11P9-DEL-IVAALT()
  /* **-------------------PHASE2 REWORK START--------------------***/
  if (PCALINP.PAL-SUFFIX == "U" || 
  PCALINP.PAL-SUFFIX == " ")
  /* **-------------------PHASE2 REWORK END  --------------------***/
    H-TIAAD1.ICI = CAL11W.WS-ICI;
    H-TIAAD1.ALERT-CD = PCALINP.PAL-ALERT-CD;

    call "TIAAD1A" (VDBCONTROL, VMESSAGE, H-TIAAD1) {isNoRefresh = yes};
    if (VDBCONTROL.URC > 104)
      exit program;
    end
  /* **-------------------PHASE2 REWORK START-------------------***/
  else
    if (PCALINP.PAL-SUFFIX == "I")
      H-TRPDSA.DBTR-SSN = PCALINP.PAL-UPI;
      call "TRPDSAA" (VDBCONTROL, VMESSAGE, H-TRPDSA) {isNoRefresh = yes};
      if (VDBCONTROL.URC > 104)
        exit program;
      end
      H-TIRAD2.UPI = H-TRPDSA.UPI;
      H-TIRAD2.ALERT-CD = PCALINP.PAL-ALERT-CD;
      call "TIRAD2A" (VDBCONTROL, VMESSAGE, H-TIRAD2) {isNoRefresh = yes};
      if (VDBCONTROL.URC > 104)
        exit program;
      end
    end
  end
  /* **-------------------PHASE2 REWORK END  -------------------***/
end // end CAL11P9-DEL-IVAALT


// DELETE ALERT FROM IVD_ALERT
Function CAL11P9-DEL-IVDALT()
  /*  */
  call "TIDAS2A" (VDBCONTROL, VMESSAGE, CAL11W, PCALINP) {isNoRefresh = yes};
  /*  */
  if (VDBCONTROL.URC > 104)
    exit program;
  end

  if (VDBCONTROL.URC == 0)

    H-TIDAD1.UPI = CAL11W.WS-NCP-UPI;
    H-TIDAD1.CASE-SUFX = CAL11W.WS-CASE-SUFX;
    H-TIDAD1.ALERT-CD = PCALINP.PAL-ALERT-CD;

    call "TIDAD1A" (VDBCONTROL, VMESSAGE, H-TIDAD1) {isNoRefresh = yes};
    if (VDBCONTROL.URC > 104)
      exit program;
    end
  end
end // end CAL11P9-DEL-IVDALT


// DELETE A RECORD IN IVA_ALERT
Function CAL11P9-DEL-IVFALT()
  H-TIFAD1.PRTCP-ID = PCALINP.PAL-UPI;
  H-TIFAD1.ALERT-CD = PCALINP.PAL-ALERT-CD;

  call "TIFAD1A" (VDBCONTROL, VMESSAGE, H-TIFAD1) {isNoRefresh = yes};
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end CAL11P9-DEL-IVFALT


// GETS ALERT DETAILS FOR ALERTID
Function CAL11P9-GET-ALTDET()
  /* Get alert status whether is active or inactive.*/

  H-TALCS1.ALERT-CD = PCALINP.PAL-ALERT-CD;

  call "TALCS1A" (VDBCONTROL, VMESSAGE, H-TALCS1) {isNoRefresh = yes};

  if (VDBCONTROL.URC == 100)
    VMESSAGE.UMSGCODE = " ";
    VMESSAGE.UMSGINS = "RECORD";
  end
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end CAL11P9-GET-ALTDET


// SELECT DATA FROM DATABASE
Function CAL11P9-GET-CASELD()
  /*  */
  VDBCONTROL.UPROC-OBJ = "H2-IVD-CASELD-CASE";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  VDBCONTROL.UPROC-NM = "CAL11P9-GET-CASELD";
  VDBCOMMON.USQLREC = "H2-IVD-CASELD-CASE";
  /*  */
  try
    open CAL11P9-GET-CASELD_RSI01
      with #sql{
        select OFC_CD, CASLD_ID, PRGM_OFC_TYPE, SPRVS_UNIT, PSN_NMB,
            FUNC_AREA_CD, WRKR_TYPE, CASLD_EFF_DT, CASELD_IND
        from twnivd_caseld_case T1
        WHERE
                     UPI    =  :UPI
            AND CASE_SUFX   = :CASE-SUFX
          FOR FETCH ONLY
         --** INSERT ORDER BY CLAUSE HERE **
      }      
      into OFC-CD, CASLD-ID, PRGM-OFC-TYPE, SPRVS-UNIT, PSN-NMB,
           FUNC-AREA-CD, WRKR-TYPE, CASLD-EFF-DT, CASELD-IND
      for H2-IVD-CASELD-CASE ;
  end
end // end CAL11P9-GET-CASELD


// SELECT DATA FROM DATABASE
Function CAL11P9-GET-CASES()
  /*  */
  VDBCONTROL.UPROC-OBJ = "H2-IVD-CASE";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  VDBCONTROL.UPROC-NM = "CAL11P9-GET-CASES";
  VDBCOMMON.USQLREC = "H2-IVD-CASE";
  /*  */
  try
    open CAL11P9-GET-CASES_RSI01
      with #sql{
        select T1.NCP_UPI, T1.CASE_SUFX
        from TWNIVD_CASE T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE T1.NCP_UPI = :CAL11W.WS-NCP-UPI-N
        AND   T1.CASE_STS <> 'C'
        UNION
        SELECT T2.NCP_UPI, T2.CASE_SUFX
         FROM TWNIVD_CASE T2
        WHERE T2.CST_UPI = :CAL11W.WS-CST-UPI
        AND   T2.CASE_STS <> 'C'
        UNION
        SELECT T3.NCP_UPI, T3.CASE_SUFX
          FROM TWNIVD_CASE T3, TWNIVD_CASE_CHILD T4
         WHERE T3.NCP_UPI = T4.NCP_UPI
         AND   T3.CASE_SUFX = T4.CASE_SUFX
         AND   T4.CHD_UPI = :CAL11W.WS-CHD-UPI
         AND   T4.CHILD_RMVD_RSN = ' '
         AND   T3.CASE_STS <> 'C'
        FOR FETCH ONLY
         --** INSERT ORDER BY CLAUSE HERE **
      }      
      into NCP-UPI, CASE-SUFX
      for H2-IVD-CASE ;
  end
end // end CAL11P9-GET-CASES


// SELECT DATA FROM DATABASE
Function CAL11P9-GET-NCP-CS()
  /*  */
  VDBCONTROL.UPROC-OBJ = "H2-IVD-CASE";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  VDBCONTROL.UPROC-NM = "CAL11P9-GET-NCP-CS";
  VDBCOMMON.USQLREC = "H2-IVD-CASE";
  /*  */
  try
    open CAL11P9-GET-NCP-CS_RSI01
      with #sql{
        select T1.NCP_UPI, T1.CASE_SUFX
        from TWNIVD_CASE T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE T1.NCP_UPI = :CAL11W.WS-NCP-UPI-N
        AND   T1.CASE_STS <> 'C'
        FOR FETCH ONLY
         --** INSERT ORDER BY CLAUSE HERE **
      }      
      into NCP-UPI, CASE-SUFX
      for H2-IVD-CASE ;
  end
end // end CAL11P9-GET-NCP-CS


// INITIALIZE RECORDS
Function CAL11P9-INITPROC()
  /* INITIALIZATION OF THE WORKING STORAGE VARIABLES*/

  CAL11W.WS-DISPL-DT = "9999-12-31";
  CAL11W.WS-DUE-DT = "9999-12-31";
  CAL11W.WS-OVRDU-DT = "9999-12-31";
  CAL11W.WS-DLT-ALERT-DT = "9999-12-31";
  CAL11W.WS-SUB-SYSTEM-CD = " ";
  CAL11W.WS-SPRVS-UNIT = " ";
  CAL11W.WS-FUNC-AREA-CD = " ";
  CAL11W.WS-WRKR-TYPE = " ";
  CAL11W.WS-PSN-NMB = 0;

  CAL11W.WS-NCP-UPI = 0;
  CAL11W.WS-CASE-SUFX = "A";
  /*  */
end // end CAL11P9-INITPROC


// LUW FOR DATABASE SELECT
Function CAL11P9-L2()
  /* Perform standard database application initialization*/
  WDB00PI();
  /*  */
  /* Initialize:*/
  /* UACCTYP - Access type (R=read, W=write)*/
  /* UAPPLNAM - Application name*/
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "CAL11A";
  /* Initialize SQL row record*/
  set H2-IVD-CASE empty;
  /*  */
  /* Perform setinq process only for the first record*/

  CAL11P9-P1();
  /*  */
  /* Set error control flags*/
  /* UNRF - No record found flag (Y,N,1)*/
  /* UDUP - Duplicate key flag (Y,N)*/
  VDBCOMMON.UNRF = "1";
  VDBCOMMON.UDUP = "N";
  /*  */
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
end // end CAL11P9-L2


// MAIN PROCESS
Function CAL11P9-MAINPROC()
  /* INITIALIZE CAL11W VARIABLES*/


  CAL11P9-INITPROC();

  call "DATEAPP" (GDW, VDBCONTROL, VMESSAGE) {isNoRefresh = yes};
  CAL11W.WS-CURRENT-DATE = GDW.DTCD;
  CAL11W.WS-N-IP-DT = GDW.DTLC;
  /* --------------------------PTR 4517 BEGIN------------------------*/
  if (PCALINP.PAL-PROCESS-DT == " "
   || PCALINP.PAL-PROCESS-DT == "0001-01-01"
   || PCALINP.PAL-PROCESS-DT-FL1 != "-"
   || PCALINP.PAL-PROCESS-DT-FL2 != "-")
    PCALINP.PAL-PROCESS-DT = GDW.DTCD;
  end
  /* --------------------------PTR 4517 END--------------------------*/
  if (PCALINP.PAL-ALERT-ACTION != "D") /* DELETE*/
     /* USING THE ALERT ID PASSED, GET THE ALERT DETAILS*/
    CAL11P9-GET-ALTDET();
     /* COMPUTE DISPLAY,DUE,OVERDUE AND AUTO DELETE DATES*/
    CAL11P9-DATE-CALC();
  end

  /* THE FOLLOWING MOVE IS DONE TO FIND THE TARGET SUBSYSTEM CODE,*/
  /* WHICH IS REPRESENTED BY THE FIRST BYTE OF THE ALERT CD WHICH*/
  /* ARE AS FOLLOWS*/
  /* 100000 - 199999 IVA*/
  /* 200000 - 299999 IVF*/
  /* 300000 - 399999 IVD*/

  CAL11W.WS-ALERT-CD = PCALINP.PAL-ALERT-CD;

  if (CAL11W.WS-SUB-SYSTEM-CD == "1") /* IVA CASE*/
    CAL11P9-MNT-IVAALT();
  end

  if (CAL11W.WS-SUB-SYSTEM-CD == "2") /* IVF CASE*/
    if (PCALINP.PAL-ALERT-ACTION == "C") /* CREATE*/
      CAL11P9-CRT-IVFALT();
    else
        /* UPDATE MODE IS NOT VALID FOR IVA AND IVF. SO IT IS ASSUMED*/
        /* THAT ALERT ACTION CAN ONLY BE EITHER 'C' OR 'D'*/
      CAL11P9-DEL-IVFALT();
    end
  end

  if (CAL11W.WS-SUB-SYSTEM-CD == "3") /* IVD CASE*/
    H2-IVD-CASE.NCP-UPI = PCALINP.PAL-UPI;
    H2-IVD-CASE.CASE-SUFX = PCALINP.PAL-SUFFIX;
    CAL11P9-Q2();
    if (H2-IVD-CASE.CASE-TYPE != "D")
      CAL11P9-MTN-IVDALT();
    end
  end

  exit program;
end // end CAL11P9-MAINPROC


// MAINTAIN IV-A ALERTS
Function CAL11P9-MNT-IVAALT()
  /* ******************** WI 24595:WNMLS:2003-01-22 START ******************/

  /* Get the Alert Status code from twnalert_codes table*/
  CAL11P9-GET-ALTDET();

  /* Note : If action is create and alert sts is 'I' do not create alert.*/
  if (PCALINP.PAL-ALERT-ACTION == "C" &&  /* (CREATE)*/
  H-TALCS1.ALERT-STS == "I")             

    return;

  end

  /* ******************** WI 24595:WNMLS:2003-01-22 END ********************/

  if (PCALINP.PAL-SUFFIX == " ")
    /* * PAL-UPI WILL HAVE CASE ID (ICI) OF A IVA CASE*/

    CAL11W.WS-ICI = PCALINP.PAL-UPI;

    if (PCALINP.PAL-ALERT-ACTION == "C") /* (CREATE)*/

      CAL11P9-CRE-IVAALT();

    else
       /* UPDATE MODE IS NOT VALID FOR IVA AND IVF. SO IT IS ASSUMED*/
       /* THAT ALERT ACTION CAN ONLY BE EITHER 'C' OR 'D'*/

      CAL11P9-DEL-IVAALT();

    end

  else

      /* IF PAL-SUFFIX = 'U', PAL-UPI WILL HAVE THE UPI OF A CASE MEMBER.*/
      /* IT IS REQUIRED TO CREATE/DELETE ALERT FOR ALL THE IVA CASES IN*/
      /* WHICH THIS PERSON IS INVOLVED*/

      /* THIS LOGIC IS REQUIRED BECAUSE WHEN IVD WANTS TO CREATE/DELETE*/
      /* AN ALERT FOR IVA, THEY MAY NOT KNOW THE CASE ID OF THE PERSON*/
      /* FOR WHOM THEY WANT TO CREATE/DELETE THE ALERT*/
  /* ---------------CHANGES DUE TO PHASE2 REWORK START------------------*/
    if (PCALINP.PAL-SUFFIX == "U")
  /* ---------------CHANGES DUE TO PHASE2 REWORK END  ------------------*/
      H-TCMHC8.UPI = PCALINP.PAL-UPI;
      H-TCMHC8.HW-PAL-ALERT-CD = PCALINP.PAL-ALERT-CD;
      H-TCMHC8.HW-PAL-ALERT-ACTION = PCALINP.PAL-ALERT-ACTION;

      try
        call "TCMHC8A" (VDBCONTROL, VMESSAGE, H-TCMHC8, CAL11W) {isNoRefresh = yes};
      end
      if (VDBCONTROL.URC > 104)
        exit program;
      end
  /* **--------------------CHANGES DUE TO PHASE2 REWORK START------------*/
    else
      if (PCALINP.PAL-SUFFIX == "I")
        if (PCALINP.PAL-ALERT-ACTION == "C")
          CAL11P9-CRE-IVAALT();
        else
          CAL11P9-DEL-IVAALT();
        end
      end
    end
  /* **--------------------CHANGES DUE TO PHASE2 REWORK END   -----------*/

  end
end // end CAL11P9-MNT-IVAALT


// MAINTAIN IV-D ALERTS
Function CAL11P9-MTN-IVDALT()

  /* Get the Alert Status code from twnalert_codes table*/
  CAL11P9-GET-ALTDET();

  /* Note : If action is create and alert sts is 'I' do not create alert.*/
  if (PCALINP.PAL-ALERT-ACTION == "C" &&  /* (CREATE)*/
  H-TALCS1.ALERT-STS == "I")             

    return;

  end

  if (PCALINP.PAL-SUFFIX == " ")
     /* - CHECK WHETHER THE UPI IS NCP OR CP OR CHILD FROM PERSON.*/
     /* - FOR NCP, READ IV D CASE  AND GET ALL THE CASES HE/SHE IS*/
     /* ASSOCIAED WITH. NCP'S UPI IS A PART OF THE KEY.*/
     /* - FOR CUSTODIAN, READ IVD CASE AND GE ALL THE CASES HE/SHE IS*/
     /* ASSOCIATED WITH. CP'S UPI IS A FIELD IN THE TABLE.*/
     /* - FOR CHILD, READ IVD CASE CHILD AND GET ALL THE CASES*/
     /* ASSOCIATED WITH THE CHILD.*/

    CAL11P9-CASES();

  else

  /* WI 19624 begin*/
    if (PCALINP.PAL-SUFFIX == "9")
      CAL11P9-NCP-CASES();
    else
  /* WI 19624 end*/
      CAL11W.WS-NCP-UPI = PCALINP.PAL-UPI;
      CAL11W.WS-CASE-SUFX = PCALINP.PAL-SUFFIX;

      CAL11P9-L2();

      if (sysVar.sqlData.sqlcode == 0) /* create/update only for Active/Pending*/
                                   /* Cases*/

        if (PCALINP.PAL-ALERT-ACTION == "C") /* (CREATE)*/
          CAL11P9-CRT-IVDALT();
        else
          if (PCALINP.PAL-ALERT-ACTION == "U") /* (UPDATE)*/
            CAL11P9-UPD-IVDALT();
          end
        end
      end
      if (PCALINP.PAL-ALERT-ACTION == "D") /* (DELETE)*/
        CAL11P9-DEL-IVDALT();
      end
    end
  end
  /*  */
end // end CAL11P9-MTN-IVDALT


// Control Retrieve of Data
Function CAL11P9-NCP-CASES()
  /*  */
  CAL11W.WS-NCP-UPI-N = PCALINP.PAL-UPI;

  WDB00PI();
  CAL11P9-GET-NCP-CS();
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end

  CAL11P9-NCP-SCAN();
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    exit program;
  end

  while (sysVar.sqlData.sqlcode == 0)

    CAL11W.WS-NCP-UPI = H2-IVD-CASE.NCP-UPI;
    CAL11W.WS-CASE-SUFX = H2-IVD-CASE.CASE-SUFX;

    if (PCALINP.PAL-ALERT-ACTION == "C") /* CREATE*/

      CAL11P9-CRT-IVDALT();

    else
      if (PCALINP.PAL-ALERT-ACTION == "U") /* (UPDATE)*/
        CAL11P9-UPD-IVDALT();
      else
        if (PCALINP.PAL-ALERT-ACTION == "D") /* (DELETE)*/
          CAL11P9-DEL-IVDALT();
        end
      end
    end

    CAL11P9-NCP-SCAN();

    WDB00PE-SQLERR();
    if (VDBCONTROL.URC > 104)
      exit program;
    end
  end
end // end CAL11P9-NCP-CASES


// SELECT DATA FROM DATABASE
Function CAL11P9-NCP-SCAN()
  /*  */
  VDBCONTROL.UPROC-OBJ = "H2-IVD-CASE";
  VDBCONTROL.UPROC-OPT = "SCAN";
  VDBCONTROL.UPROC-NM = "CAL11P9-NCP-SCAN";
  VDBCOMMON.USQLREC = "H2-IVD-CASE";
  /*  */
  try
    get next H2-IVD-CASE ;
  end
end // end CAL11P9-NCP-SCAN


// Control Retrieve of Data
Function CAL11P9-P1()
  /*  */
  H2-IVD-CASE.NCP-UPI = CAL11W.WS-NCP-UPI;
  H2-IVD-CASE.CASE-SUFX = CAL11W.WS-CASE-SUFX;

  CAL11P9-Q1();
  /*  */
end // end CAL11P9-P1


// SETCURSOR FOR DATA RETRIEVAL
Function CAL11P9-Q1()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-IVD-CASE";
  /*  */
  VDBCONTROL.UPROC-OBJ = "H2-IVD-CASE";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  VDBCONTROL.UPROC-NM = "CAL11P9-Q1";
  VDBCOMMON.USQLREC = "H2-IVD-CASE";
  /*  */
  try
    get H2-IVD-CASE singleRow
      with #sql{
        select NCP_UPI, CASE_SUFX
        from TWNIVD_CASE T1
        WHERE NCP_UPI  = :NCP-UPI
          AND  CASE_SUFX = :CASE-SUFX
          AND CASE_STS IN ('A' , 'P')
          AND CASE_TYPE <> 'D'
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into NCP-UPI, CASE-SUFX ;
  end
  /*  */
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    VDBCONTROL.UROWR = VDBCONTROL.UROWR + 1;
  end
end // end CAL11P9-Q1


// get case type
Function CAL11P9-Q2()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-IVD-CASE";
  VDBCONTROL.UPROC-OBJ = "H2-IVD-CASE";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  VDBCONTROL.UPROC-NM = "CAL11P9-Q2";
  VDBCOMMON.USQLREC = "H2-IVD-CASE";
  /*  */
  try
    get H2-IVD-CASE singleRow
      with #sql{
        select CASE_type
        from TWNIVD_CASE T1
        WHERE NCP_UPI  = :NCP-UPI
          AND  CASE_SUFX = :CASE-SUFX
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into CASE-TYPE ;
  end
  /*  */
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    VDBCONTROL.UROWR = VDBCONTROL.UROWR + 1;
  end
end // end CAL11P9-Q2


// UPDATE IVD ALERTS
Function CAL11P9-UPD-IVDALT()
  H-TIDAU1.UPI = CAL11W.WS-NCP-UPI;
  H-TIDAU1.CASE-SUFX = CAL11W.WS-CASE-SUFX;
  H-TIDAU1.DUE-DT = PCALINP.PAL-DUE-DT;
  /*  */
  H-TIDAU1.ALERT-CD = PCALINP.PAL-ALERT-CD;
  /*  */
  call "TIDAU1A" (VDBCONTROL, VMESSAGE, H-TIDAU1) {isNoRefresh = yes};
  if (VDBCONTROL.URC > 104)
    exit program;
  end
end // end CAL11P9-UPD-IVDALT


