/* AME37A — Full benefits by office (TOTAL, PA, NA) for Jan 2025)
   Exact S04 logic + READ-S02 timing:
   • Drive offices from TWNCASELD_DEBTLD (admin, exclude DC/DH/DL/DR)  :contentReference[oaicite:0]{index=0}
   • For each office, take the EARLIEST AP per ICI within the month (<= end ts)  :contentReference[oaicite:1]{index=1}
   • Previous FS action is MAX(ACTN_TS) < AP_TS and must be in ('FA','RE','RI')  :contentReference[oaicite:2]{index=2}
   • Classify PA/NA using FS_SUFX from CASE_HSTRY as of REPORT END DATE
     (PRD_BEG_DT <= :END_DT AND PRD_END_DT >= :END_DT), per READ-S02  :contentReference[oaicite:3]{index=3}
*/

WITH
OFFICES AS (  -- admin reporting offices, legacy driver
  SELECT DISTINCT D.OFC_CD
  FROM W026DTF1.TWNCASELD_DEBTLD D
  WHERE D.PRGM_OFC_TYPE = 'A'
    AND D.OFC_CD NOT IN ('DC','DH','DL','DR')
),
AP0 AS (       -- earliest AP per ICI in Jan 2025 for the office
  SELECT
    C.OFC_CD,
    A.ICI,
    MIN(A.ACTN_TS) AS AP_TS
  FROM W026DTF1.TWNFAM_ACTNS A
  JOIN W026DTF1.TWNFAM_CASELD_CASE C
    ON C.ICI = A.ICI
   AND C.PRGM_OFC_TYPE = 'A'
  WHERE A.PRGM_TYP = 'FS'
    AND A.ACTN_TYP = 'AP'
    AND A.ACTN_TS >= TIMESTAMP('2025-01-01-00.00.00')
    AND A.ACTN_TS <= TIMESTAMP('2025-01-31-23.59.59')   -- inclusive, matches legacy
  GROUP BY C.OFC_CD, A.ICI
),
AP_OFF AS (     -- only offices in the reporting list
  SELECT A.*
  FROM AP0 A
  JOIN OFFICES O ON O.OFC_CD = A.OFC_CD
),
PREV AS (       -- previous FS action before that AP (any type for now)
  SELECT
    F.OFC_CD,
    F.ICI,
    MAX(P.ACTN_TS) AS PREV_TS
  FROM AP_OFF F
  JOIN W026DTF1.TWNFAM_ACTNS P
    ON P.ICI = F.ICI
   AND P.PRGM_TYP = 'FS'
   AND P.ACTN_TS  < F.AP_TS
  GROUP BY F.OFC_CD, F.ICI
),
PREV_OK AS (    -- keep only if previous action type is FA/RE/RI (full benefit)
  SELECT P.OFC_CD, P.ICI, P.PREV_TS
  FROM PREV P
  JOIN W026DTF1.TWNFAM_ACTNS R
    ON R.ICI = P.ICI
   AND R.PRGM_TYP = 'FS'
   AND R.ACTN_TS = P.PREV_TS
   AND R.ACTN_TYP IN ('FA','RE','RI')
),
CLASS AS (      -- FS suffix as of REPORT END DATE (not AP/prev time) per READ-S02
  SELECT
    K.OFC_CD,
    K.ICI,
    (
      SELECT H.FS_SUFX
      FROM W026DTF1.TWNFAM_CASE_HSTRY H
      WHERE H.ICI = K.ICI
        AND H.PRD_BEG_DT <= DATE('2025-01-31')
        AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= DATE('2025-01-31')
      ORDER BY H.PRD_BEG_DT DESC
      FETCH FIRST 1 ROW ONLY
    ) AS FS_SUFX
  FROM PREV_OK K
)

SELECT
  O.OFC_CD,
  COALESCE(COUNT(CX.ICI), 0) AS FULL_BENEFITS_TOTAL,
  COALESCE(SUM(CASE WHEN CX.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END), 0) AS PA_BENEFITS,
  COALESCE(SUM(CASE WHEN CX.FS_SUFX IN ('P','S','G','A') THEN 0 ELSE 1 END), 0) AS NA_BENEFITS
FROM OFFICES O
LEFT JOIN CLASS CX
  ON CX.OFC_CD = O.OFC_CD
GROUP BY O.OFC_CD
ORDER BY O.OFC_CD;
