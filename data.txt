public void processEthnicity(H2Person person, int index, EthnicityContext context) {
    String ethCode = person.getEthnicityCode();
    String sexCode = person.getSexCode();
    String ethnicity = (index >= 0 && index < context.getEthnicityList().size())
            ? context.getEthnicityList().get(index)
            : "UNKNOWN";

    boolean validEthCode = ethCode != null && !ethCode.isBlank()
            && !"U".equalsIgnoreCase(ethCode)
            && !"?".equals(ethCode);

    if (validEthCode && context.getValidEthnicityCodes().contains(ethCode)) {
        increment(context.getTotalMap(), ethnicity);
        if ("F".equalsIgnoreCase(sexCode)) {
            increment(context.getFemaleMap(), ethnicity);
        } else if ("M".equalsIgnoreCase(sexCode)) {
            increment(context.getMaleMap(), ethnicity);
        }

    } else if (context.getEthnicityDescriptions().contains("UNKNOWN")) {
        ethnicity = "UNKNOWN";
        increment(context.getTotalMap(), ethnicity);
        if ("F".equalsIgnoreCase(sexCode)) {
            increment(context.getFemaleMap(), ethnicity);
        } else if ("M".equalsIgnoreCase(sexCode)) {
            increment(context.getMaleMap(), ethnicity);
        }
    }
}

private void increment(Map<String, Integer> map, String key) {
    map.put(key, map.getOrDefault(key, 0) + 1);
}
