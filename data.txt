package IVA_Batch;
import egl.core.*;
import CommonMigratedParts.*;
import DataTables.*;
Program AMA44A type basicProgram //VAGen Info - main batch program
  {
  includeReferencedFunctions = yes, allowUnqualifiedItemReferences = yes, 
  throwNrfEofExceptions = yes, handleHardIOErrors = no, V60ExceptionCompatibility = yes, 
  I4GLItemsNullable = no, textLiteralDefaultIsString = no, localSQLScope = yes
  }

  // Data Declarations
  AMA44W1 AMA44W1; // record
  CEP01W CEP01W; // record
  GNOMADS GNOMADS; // record
  H2-2-EVR-PCH H2-2-EVR-PCH; // record
  H2-2-FCC-FCH H2-2-FCC-FCH; // record
  H2-ELG-BDGT-UNIT H2-ELG-BDGT-UNIT; // record
  H2-ELG-VER-MBR H2-ELG-VER-MBR; // record
  H2-FAM-CASELD-CASE H2-FAM-CASELD-CASE; // record
  H2-OFFICE H2-OFFICE; // record
  SR-AMA44-DATEIN SR-AMA44-DATEIN; // record
  SR-AMA44-RECIN SR-AMA44-RECIN; // record
  VCOMMON VCOMMON; // record
  VCONTROL VCONTROL; // record
  VDBCOMMON VDBCOMMON; // record
  VDBCONTROL VDBCONTROL; // record
  VDTSREC VDTSREC; // record
  VMESSAGE VMESSAGE; // record

  // VAGen Info - items needed for migration
  VAGen_EZESYS char(8);
  VAGen_EZEREPLY num(1);
  VAGen_EZE_WAIT_TIME bin(9,2);
  VAGen_EZE_ITEMLEN int;

  // Use Declarations
  use VDB00T1 {deleteAfterUse = yes}; // table

  function main()
    // VAGen Info - initialization needed for migration
    VAGen_EZESYS = VGLib.getVAGSysType();
    AMA44P9-MAIN: AMA44P9-MAIN();
  end // end main
end // end AMA44A


// Build PCE file
Function AMA44P9-BLD-PCE()
  /* Build PCE-File record based on retreived data.*/
  /*  */
  SR-AMA44-RECIN.PCE-ICI = H2-2-EVR-PCH.ICI;
  SR-AMA44-RECIN.PCE-AID-CD = H2-2-EVR-PCH.AID-CD;
  SR-AMA44-RECIN.PCE-PRGM-CASE-STS = H2-2-EVR-PCH.PRGM-CASE-STS;
  /*  */
  /*  */
  AMA44P9-DET-RSN();
  /*  */
  AMA44P9-WRIT-PCE();
end // end AMA44P9-BLD-PCE


// Close the output file
Function AMA44P9-CLOS-PARA()
end // end AMA44P9-CLOS-PARA


// Read caseload to det eff date
Function AMA44P9-CS-EFFDT()
  /*  */
  VMESSAGE.UMSGINS[2] = "AMA44A";
  VDBCONTROL.UPROC-NM = "AMA44P9-CS-EFFDT";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  VDBCONTROL.UPROC-OBJ = "H2-FAM-CASELD-CASE";
  VDBCOMMON.USQLREC = "H2-FAM-CASELD-CASE";
  /*  */
  try
    get H2-FAM-CASELD-CASE
      with #sql{
        select CASLD_EFF_DT
        from twnfam_caseld_case T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
         --** INSERT ORDER BY CLAUSE HERE **
        WHERE ICI = :ICI
      }
      into CASLD-EFF-DT ;
  end
  /*  */
  if (sysVar.sqlData.sqlcode != 0)
    WDB00PE-SQLERR();
    if (VDBCONTROL.URC > 104)
      WCM00P2-TO-CEP01A();
    end
  end /* sql error processing*/
end // end AMA44P9-CS-EFFDT


// Determine caseload id
Function AMA44P9-DET-CASLD()

  H2-FAM-CASELD-CASE.ICI = H2-2-EVR-PCH.ICI;
  AMA44P9-CS-EFFDT();

  if (sysVar.sqlData.sqlcode == 0)

    H2-2-FCC-FCH.ICI = H2-2-EVR-PCH.ICI;
    H2-2-FCC-FCH.PRD-BEG-DT = AMA44W1.WS-INPUT-DATE;
    H2-2-FCC-FCH.PRD-END-DT = AMA44W1.WS-INPUT-DATE;
    H2-2-FCC-FCH.CASLD-EFF-DT = H2-FAM-CASELD-CASE.CASLD-EFF-DT;

    AMA44P9-FCC-FCH();

    if (sysVar.sqlData.sqlcode == 0)

      SR-AMA44-RECIN.PCE-OFC-CD = H2-2-FCC-FCH.OFC-CD;
      SR-AMA44-RECIN.PCE-CASLD-ID = H2-2-FCC-FCH.CASLD-ID;

      H2-OFFICE.OFC-CD = H2-2-FCC-FCH.OFC-CD;
      AMA44P9-G-OFNM();

      if (sysVar.sqlData.sqlcode == 0)
        SR-AMA44-RECIN.PCE-OFC-NM = H2-OFFICE.OFC-NM;
      end

    end
  end
end // end AMA44P9-DET-CASLD


// Determine den/ter reasons
Function AMA44P9-DET-RSN()

  if (H2-2-EVR-PCH.WTHDR-TST-RSLT-CD == "F")
    SR-AMA44-RECIN.PCE-RSN-CD = 1;
    SR-AMA44-RECIN.PCE-RSN = "CASE WITHDRAWL";
    AMA44P9-DET-CASLD();
    return;
  end

  /*  */
  if (H2-2-EVR-PCH.APL-DTH-TSTRSL-CD == "F")
    SR-AMA44-RECIN.PCE-RSN-CD = 2;
    SR-AMA44-RECIN.PCE-RSN = "DEATH";
    AMA44P9-DET-CASLD();
    return;
  end

  /*  */
  if (H2-2-EVR-PCH.RSDN-TST-RSLT-CD == "F")
    SR-AMA44-RECIN.PCE-RSN-CD = 3;
    SR-AMA44-RECIN.PCE-RSN = "NOT MEETING RESIDENCE REQ";
    AMA44P9-DET-CASLD();
    return;
  end

  /*  */
  if (H2-2-EVR-PCH.AGDDIS-ST-TSTRS-CD == "F")
    SR-AMA44-RECIN.PCE-RSN-CD = 4;
    SR-AMA44-RECIN.PCE-RSN = "FAILED AGED/DIS REQUIREMENTS";
    AMA44P9-DET-CASLD();
    return;
  end

  /*  */
  if (H2-2-EVR-PCH.VRF-TST-RSLT-CD == "F" || 
  H2-2-EVR-PCH.SSN-TEST-RSLT-CD == "F" || 
  H2-2-EVR-PCH.COOP-TEST-RSLT-CD == "F" || 
  H2-2-EVR-PCH.MRF-COMP-TSTRSL-CD == "F")

    SR-AMA44-RECIN.PCE-RSN-CD = 5;
    SR-AMA44-RECIN.PCE-RSN = "FAILED TO COOPERATE";
    AMA44P9-DET-CASLD();
    return;
  end

  AMA44P9-INC-RES();

  if (AMA44W1.WS-INC-RES-FAIL == "N")
    SR-AMA44-RECIN.PCE-RSN-CD = 6;
    SR-AMA44-RECIN.PCE-RSN = "FAILED ALL CATEGORIES"; /* wi 16615*/
    AMA44P9-DET-CASLD();
  end
end // end AMA44P9-DET-RSN


// Calls other process for extr
Function AMA44P9-EXTR-PARA()
  /*  */
  /* Select all program case records for the month*/
  /* Read twnprgm_case_hstry / elig version to extract den/ter data*/

  AMA44W1.WS-INPUT-CCYY = SR-AMA44-DATEIN.RPT-DT-CCYY;
  H2-2-EVR-PCH.BNFT-YR = SR-AMA44-DATEIN.RPT-DT-CCYY;
  AMA44W1.WS-INPUT-CCYYH = "-";
  AMA44W1.WS-INPUT-MM = SR-AMA44-DATEIN.RPT-DT-MM;
  H2-2-EVR-PCH.BNFT-MTH = SR-AMA44-DATEIN.RPT-DT-MM;
  AMA44W1.WS-INPUT-MMH = "-";
  AMA44W1.WS-INPUT-DD = SR-AMA44-DATEIN.RPT-DT-DD;
  H2-2-EVR-PCH.PRD-BEG-DT = AMA44W1.WS-INPUT-DATE;
  H2-2-EVR-PCH.PRD-END-DT = AMA44W1.WS-INPUT-DATE;

  AMA44P9-I-DT-DATA();
  /*  */
  while (sysVar.sqlData.sqlcode == 0)
    /* Fetch first record*/
    AMA44P9-S-DT-DATA();
    /*  */
    while (sysVar.sqlData.sqlcode == 0)
      /* Build PCE-file*/
      AMA44P9-BLD-PCE();
      /*  */
      /* Fetch next record.*/
      AMA44P9-S-DT-DATA();
      /*  */
    end
  /*  */
  end
  /*  */
  /* Move the row count of fam_case scan to db control variable, since*/
  /* sqlerror common routine set's message occordingly.*/
  VDBCOMMON.UNRF = "1";
  VDBCOMMON.UDUP = "N";
  /*  */
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
  /*  */
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
end // end AMA44P9-EXTR-PARA


// Join FCC / FCC
Function AMA44P9-FCC-FCH()
  /*  */
  VMESSAGE.UMSGINS[2] = "AMA44A";
  VDBCONTROL.UPROC-NM = "AMA44P9-FCC-FCH";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  VDBCONTROL.UPROC-OBJ = "H2-2-FCC-FCH";
  VDBCOMMON.USQLREC = "H2-2-FCC-FCH";
  /*  */
  try
    get H2-2-FCC-FCH
      with #sql{
        select T1.HOH_UPI,
          T2.OFC_CD,
          T2.CASLD_ID
        from TWNFAM_CASE_HSTRY T1,
             TWNFAM_CASELD_CASE T2
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
         --** INSERT ORDER BY CLAUSE HERE **
        WHERE
            T1.ICI = :ICI
        AND T1.PRD_BEG_DT <= :PRD-BEG-DT
        AND T1.PRD_END_DT >= :PRD-END-DT
        AND T1.ICI = T2.ICI
        AND T2.CASLD_EFF_DT = :CASLD-EFF-DT 
      }
      into HOH-UPI,
           OFC-CD,
           CASLD-ID ;
  end
  if (sysVar.sqlData.sqlcode != 0)
    WDB00PE-SQLERR();
    if (VDBCONTROL.URC > 104)
      WCM00P2-TO-CEP01A();
    end
  end /* sql error processing*/
end // end AMA44P9-FCC-FCH


// Get office name
Function AMA44P9-G-OFNM()
  /*  */
  VMESSAGE.UMSGINS[2] = "AMA44A";
  VDBCONTROL.UPROC-NM = "AMA44P9-G-OFNM";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  VDBCONTROL.UPROC-OBJ = "H2-OFFICE";
  VDBCOMMON.USQLREC = "H2-OFFICE";
  /*  */
  try
    get H2-OFFICE
      with #sql{
        select OFC_NM
        from TWNOFFICE T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
         --** INSERT ORDER BY CLAUSE HERE **
        WHERE OFC_CD = :OFC-CD
      }
      into OFC-NM ;
  end
  if (sysVar.sqlData.sqlcode != 0)
    WDB00PE-SQLERR();
    if (VDBCONTROL.URC > 104)
      WCM00P2-TO-CEP01A();
    end
  end /* sql error processing*/
end // end AMA44P9-G-OFNM


// Setinq to ext den/ter data
Function AMA44P9-I-DT-DATA()
  /* Perform database application initialization*/
  WDB00PI();
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "AMA44A";
  /*  */
  /* Move name of SQL row record used to common record*/
  VMESSAGE.UMSGINS[2] = "AMA44A";
  VDBCOMMON.USQLREC = "H2-2-EVR-PCH";
  VDBCONTROL.UPROC-OBJ = "H2-2-EVR-PCH";
  VDBCONTROL.UPROC-NM = "AMA44P9-I-DT-DATA";
  /*  */
  try
    open AMA44P9-I-DT-DATA_RSI01
      with #sql{
        select T1.ICI,
          T1.PRGM_CASE_STS,
          T1.PRGM_CASE_TYPE ,
          T1.AID_CD ,
          T2.WTHDR_TST_RSLT_CD ,
          T2.APL_DTH_TSTRSL_CD ,
          T2.RSDN_TST_RSLT_CD ,
          T2.AGDDIS_ST_TSTRS_CD ,
          T2.VRF_TST_RSLT_CD ,
          T2.SSN_TEST_RSLT_CD ,
          T2.COOP_TEST_RSLT_CD ,
          T2.MRF_COMP_TSTRSL_CD ,
          T2.BNFT_YR ,
          T2.BNFT_MTH,
          T2.VER_NMB
        from TWNPRGM_CASE_HSTRY T1,
             TWNELIG_VERSION T2
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
         --** INSERT ORDER BY CLAUSE HERE **
        WHERE T1.PRGM_CASE_TYPE = 'MA'
          AND T1.PRGM_CASE_STS IN ('T' , 'D' )
          AND T1.PRD_BEG_DT <= :PRD-BEG-DT
          AND T1.PRD_END_DT >= :PRD-END-DT
          AND T2.BNFT_MTH = :BNFT-MTH
          AND T2.BNFT_YR = :BNFT-YR
          AND T2.PRGM_CASE_TYPE = 'MA'
          AND T2.LST_POSTD_VER_IND = 'Y'
          AND T1.ICI = T2.ICI
         --** INSERT ORDER BY CLAUSE HERE **
      }      
      into ICI,
           PRGM-CASE-STS,
           PRGM-CASE-TYPE,
           AID-CD,
           WTHDR-TST-RSLT-CD,
           APL-DTH-TSTRSL-CD,
           RSDN-TST-RSLT-CD,
           AGDDIS-ST-TSTRS-CD,
           VRF-TST-RSLT-CD,
           SSN-TEST-RSLT-CD,
           COOP-TEST-RSLT-CD,
           MRF-COMP-TSTRSL-CD,
           BNFT-YR,
           BNFT-MTH,
           VER-NMB
      for H2-2-EVR-PCH ;
  end
end // end AMA44P9-I-DT-DATA


// Determine Inc / Res Failure
Function AMA44P9-INC-RES()

  AMA44W1.WS-INC-RES-FAIL = "N";

  AMA44P9-DET-CASLD();

  /* Setting keys to retrieve budget unit from elig version member.*/

  H2-ELG-VER-MBR.ICI = H2-2-EVR-PCH.ICI;
  H2-ELG-VER-MBR.PRGM-CASE-TYPE = H2-2-EVR-PCH.PRGM-CASE-TYPE;
  H2-ELG-VER-MBR.BNFT-YR = H2-2-EVR-PCH.BNFT-YR;
  H2-ELG-VER-MBR.BNFT-MTH = H2-2-EVR-PCH.BNFT-MTH;
  H2-ELG-VER-MBR.VER-NMB = H2-2-EVR-PCH.VER-NMB;
  H2-ELG-VER-MBR.UPI = H2-2-FCC-FCH.HOH-UPI;

  AMA44P9-INQ-EVM();

  if (sysVar.sqlData.sqlcode == 0)

    H2-ELG-BDGT-UNIT.ICI = H2-2-EVR-PCH.ICI;
    H2-ELG-BDGT-UNIT.PRGM-CASE-TYPE = H2-2-EVR-PCH.PRGM-CASE-TYPE;
    H2-ELG-BDGT-UNIT.BNFT-YR = H2-2-EVR-PCH.BNFT-YR;
    H2-ELG-BDGT-UNIT.BNFT-MTH = H2-2-EVR-PCH.BNFT-MTH;
    H2-ELG-BDGT-UNIT.VER-NMB = H2-2-EVR-PCH.VER-NMB;
    H2-ELG-BDGT-UNIT.BU-NMB = H2-ELG-VER-MBR.LST-BU-CNSD;

    AMA44P9-R-EBU();

    if (sysVar.sqlData.sqlcode == 0)

      if (H2-ELG-BDGT-UNIT.RSRCS-TST-RSLT-CD == "F")
        AMA44W1.WS-INC-RES-FAIL = "Y";
        SR-AMA44-RECIN.PCE-RSN-CD = 7;
        SR-AMA44-RECIN.PCE-RSN = "FAILED RESOURCE TEST ";
      end

      if (H2-ELG-BDGT-UNIT.GRS-INC-TST-RSLTCD == "F")
        AMA44W1.WS-INC-RES-FAIL = "Y";
        SR-AMA44-RECIN.PCE-RSN-CD = 8;
        SR-AMA44-RECIN.PCE-RSN = "FAILED GROSS INCOME TEST ";
      end

    end
  end
end // end AMA44P9-INC-RES


// Read input data and initialise
Function AMA44P9-INIT-PARA()
  /* cbsi start*/
  /* perform process to read input parameter file*/
  /* validate date parameters, mandatory fields for*/
  /* input records*/
  VGVar.handleHardIOErrors = 1;
  AMA44W1.WS-DATA-EXISTS = "N";

  AMA44P9-READIP();

  /* perform  process for validation of input parameters*/
  AMA44P9-VALIDATE();

  AMA44P9-INIT-VAR();
  /* cbsi end*/
end // end AMA44P9-INIT-PARA


// Iinitialise WS variables
Function AMA44P9-INIT-VAR()
  set AMA44W1 empty;
  AMA44W1.WS-DATA-EXISTS = "N";
end // end AMA44P9-INIT-VAR


// Det Inc/Res failure
Function AMA44P9-INQ-EVM()
  /*  */
  VMESSAGE.UMSGINS[2] = "AMA44A";
  VDBCONTROL.UPROC-NM = "AMA44P9-INQ-EVM";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  VDBCONTROL.UPROC-OBJ = "H2-ELG-VER-MBR";
  VDBCOMMON.USQLREC = "H2-ELG-VER-MBR";
  /*  */
  try
    get H2-ELG-VER-MBR
      with #sql{
        select LST_BU_CNSD
        from twnelg_ver_mbr T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
         --** INSERT ORDER BY CLAUSE HERE **
        WHERE
            ICI = :ICI
        AND PRGM_CASE_TYPE = :PRGM-CASE-TYPE
        AND BNFT_YR = :BNFT-YR
        AND BNFT_MTH = :BNFT-MTH
        AND VER_NMB = :VER-NMB
        AND UPI = :UPI
      }
      into LST-BU-CNSD ;
  end
  if (sysVar.sqlData.sqlcode != 0)
    WDB00PE-SQLERR();
    if (VDBCONTROL.URC > 104)
      WCM00P2-TO-CEP01A();
    end
  end /* sql error processing*/
end // end AMA44P9-INQ-EVM


// Init data , extract and close
Function AMA44P9-MAIN()
  /* GET AMA44P9-MAIN*/
  /* cbsi start*/

  /* perform process to initialize variables*/
  AMA44P9-INIT-PARA();

  /* perform process to extract the data into the report*/
  AMA44P9-EXTR-PARA();

  /* perform process to close the application*/
  AMA44P9-CLOS-PARA();

  if (AMA44W1.WS-DATA-EXISTS == "N")

    VMESSAGE.UMSGCODE = "ARX0103E";
    VMESSAGE.UMSGINS[2] = "AMA44A";
    VDBCONTROL.UPROC-NM = "AMA44P9-MAIN";
    VDBCONTROL.UPROC-OPT = "EXECUTE";
    VDBCONTROL.UPROC-OBJ = "SR-AMA44-RECIN";
    VMESSAGE.UMSGCODE-JCL-ERR = 8;
    VMESSAGE.UMSGINS[1] = " ";
    VDBCONTROL.UMSQLCODE = 0;

    WCM00P2-TO-CEP01A();
  end
  /* cbsi end*/
end // end AMA44P9-MAIN


// Read elig budget unit (BU NMB)
Function AMA44P9-R-EBU()

  /*  */
  VMESSAGE.UMSGINS[2] = "AMA44A";
  VDBCONTROL.UPROC-NM = "AMA44P9-R-EBU";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  VDBCONTROL.UPROC-OBJ = "H2-ELG-BDGT-UNIT";
  VDBCOMMON.USQLREC = "H2-ELG-BDGT-UNIT";
  /*  */
  try
    get H2-ELG-BDGT-UNIT
      with #sql{
        select GRS_INC_TST_RSLTCD,
          RSRCS_TST_RSLT_CD
        from TWNELG_BDGT_UNIT T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
         --** INSERT ORDER BY CLAUSE HERE **
        WHERE
             ICI = :ICI
        AND PRGM_CASE_TYPE = :PRGM-CASE-TYPE
        AND BNFT_YR = :BNFT-YR
        AND BNFT_MTH = :BNFT-MTH
        AND VER_NMB = :VER-NMB
        AND BU_NMB = :BU-NMB
      }
      into GRS-INC-TST-RSLTCD,
           RSRCS-TST-RSLT-CD ;
  end
  /*  */
end // end AMA44P9-R-EBU


// Read for getting input date
Function AMA44P9-READIP()
  try
    get next SR-AMA44-DATEIN ;
  end

  /* check if any i/o error has occured*/
  if (SR-AMA44-DATEIN is ioError && SR-AMA44-DATEIN not endOfFile)

  /* CHANGES DUE TO PTR - 11841 - BEGIN*/

    VDBCONTROL.UPROC-NM = "AMA44P9-READIP";
    VDBCONTROL.UPROC-OPT = "SCAN";
    VDBCONTROL.UPROC-OBJ = "SR-AMA44-DATEIN";
    AMA44W1.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = AMA44W1.WS-ERR-LAST-FOUR;
    VMESSAGE.UMSGINS[2] = "AMA44A";

  /* CHANGES DUE TO PTR - 11841 - END*/

    WCM00P2-TO-CEP01A();

  end

  if (SR-AMA44-DATEIN is endOfFile)

  /* CHANGES DUE TO PTR - 11841 - BEGIN*/

    VDBCONTROL.UPROC-NM = "AMA2449-READIP";
    VDBCONTROL.UPROC-OPT = "SCAN";
    VDBCONTROL.UPROC-OBJ = "SR-AMA44-DATEIN";

    VMESSAGE.UMSGCODE = "ARX0402E";
    AMA44W1.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = AMA44W1.WS-ERR-LAST-FOUR;
    VMESSAGE.UMSGINS[2] = "AMA44A";

  /* CHANGES DUE TO PTR - 11841 - END*/

    WCM00P2-TO-CEP01A();
  end
  /* cbsi end*/
end // end AMA44P9-READIP


// Scan denial / terminated data
Function AMA44P9-S-DT-DATA()
  /* Move name of SQL row record used to common record*/
  VMESSAGE.UMSGINS[2] = "AMA44A";
  VDBCOMMON.USQLREC = "H2-2-EVR-PCH";
  VDBCONTROL.UPROC-OBJ = "H2-2-EVR-PCH";
  VDBCONTROL.UPROC-NM = "AMA44P9-S-DT-DATA";
  VDBCONTROL.UPROC-OPT = "SCAN";
  /*  */
  try
    get next H2-2-EVR-PCH ;
  end

  /* Increment count of rows retrieved*/
end // end AMA44P9-S-DT-DATA


// Validate input date
Function AMA44P9-VALIDATE()
  /* ************************************************************************/
  /* Validate input parameter.*/
  /* ************************************************************************/
  /* Move serial record values to working storage*/
  /*  */
  VDTSREC.UDATMM = SR-AMA44-DATEIN.RPT-DT-MM;
  VDTSREC.UDATDD = SR-AMA44-DATEIN.RPT-DT-DD;
  VDTSREC.UDATYY = SR-AMA44-DATEIN.RPT-DT-CCYY;
  /*  */
  /* Call date validation routine*/
  call "WDT10A" (VCONTROL, VDTSREC) {isNoRefresh = yes};
  /*  */
  /* On date error exit application*/
  if (VCONTROL.URC != 0)

  /* CHANGES DUE TO PTR - 11841 - BEGIN*/

    VDBCONTROL.UPROC-NM = "AMA44P9-READIP";
    VDBCONTROL.UPROC-OPT = "CALL";
    VDBCONTROL.UPROC-OBJ = "SR-AMA44-DATEIN";
    VMESSAGE.UMSGCODE = "ARX0402E";
    VMESSAGE.UMSGINS[2] = "AMA44A";

  /* CHANGES DUE TO PTR - 11841 - END*/

    WCM00P2-TO-CEP01A();
  end
  /*  */
end // end AMA44P9-VALIDATE


// Write PCE file
Function AMA44P9-WRIT-PCE()
  /*  */
  try
    add SR-AMA44-RECIN ;
  end
  /*  */
  if (SR-AMA44-RECIN is ioError)
    VDBCONTROL.UPROC-NM = "AMA44P9-WRIT-PCE";
    VDBCONTROL.UPROC-OBJ = "SR-AMA44-PCE";
    VDBCONTROL.UPROC-OPT = "ADD";
    AMA44W1.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = AMA44W1.WS-ERR-LAST-FOUR;
    VMESSAGE.UMSGINS[2] = "AMA44A";

    WCM00P2-TO-CEP01A();
  end
  AMA44W1.WS-DATA-EXISTS = "Y";
end // end AMA44P9-WRIT-PCE


Record AMA44W1 type basicRecord
  10 WS-INPUT-DATE char(10) ; 
    15 WS-INPUT-CCYY num(4) ; 
    15 WS-INPUT-CCYYH char(1) ; 
    15 WS-INPUT-MM num(2) ; 
    15 WS-INPUT-MMH char(1) ; 
    15 WS-INPUT-DD num(2) ; 
  10 WS-INC-RES-FAIL char(1) ; 
  10 WS-ERR-CD char(8) ; 
    15 WS-ERR-FIRST-FOUR char(4) ; 
    15 WS-ERR-LAST-FOUR char(4) ; 
  10 WS-DATA-EXISTS char(1) ; 
end // end AMA44W1


