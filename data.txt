package gov.nv.dwss.crystalreports.statistics.common.dao;

import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

import javax.sql.DataSource;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.datasource.DataSourceUtils;
import org.springframework.stereotype.Component;

import gov.nv.dwss.base.Dao;
import gov.nv.dwss.domain.dao.sor.ReportMonthlyCaseHistorySorDao;
import gov.nv.dwss.domain.dao.sor.extended.ExtendedSorDao;
import gov.nv.dwss.domain.record.SorRecord;
import gov.nv.dwss.domain.record.sor.ReportMonthlyCaseHistorySorRecord;

@Component
public class MonthlyCaseHistoryExtendedDao extends ExtendedSorDao {

    private static final String GET_ALL_PCE_RECORDS_MONTHLY = "SELECT * FROM ##db-schema-name##.TWNRPT_MTH_CASEHST WHERE RUN_DATE = ?";
    private static final String GET_ALL_PCE_RECORDS_DATE_COUNT = "SELECT COUNT(*) FROM ##db-schema-name##.TWNRPT_MTH_CASEHST WHERE RUN_DATE = ?";
    private static final String GET_ALL_PCE_RECORDS_OFC = "SELECT * FROM ##db-schema-name##.TWNRPT_MTH_CASEHST WHERE OFC_CD IN (##OFC-CD##)";
    private static final String GET_ALL_PCE_RECORDS = "SELECT * FROM ##db-schema-name##.TWNRPT_MTH_CASEHST";
    private static final String GET_ALL_PCE_RECORDS_OFC_COUNT = "SELECT COUNT(*) FROM ##db-schema-name##.TWNRPT_MTH_CASEHST WHERE OFC_CD IN (##OFC-CD##)";
    private static final String GET_ALL_PCE_RECORDS_COUNT = "SELECT COUNT(*) FROM ##db-schema-name##.TWNRPT_MTH_CASEHST";

    private static final String GET_ALL_OFFICE_CODES = "SELECT DISTINCT OFC_CD FROM ##db-schema-name##.TWNRPT_MTH_CASEHST" +
            " WHERE PRGM_CASE_STS='O' AND LST_REC_FR_MTH='Y' " +
            " AND PRGM_CASE_TYPE IN ('FS', 'AF')" +
            " AND STS_EFF_DT BETWEEN ? AND ?";

    private static final String GET_PCE_RECORDS_OFFICE_CODE_COUNT = "SELECT count(*) FROM ##db-schema-name##.TWNRPT_MTH_CASEHST WHERE OFC_CD = ?" +
            " AND PRGM_CASE_STS='O' AND LST_REC_FR_MTH='Y'" +
            " AND PRGM_CASE_TYPE IN ('FS', 'AF')" +
            " AND STS_EFF_DT BETWEEN ? AND ?";

    private static final String GET_PCE_RECORDS = "SELECT * FROM (" +
            "  SELECT t.*, ROW_NUMBER() OVER (ORDER BY t.RPT_SEQ_NMB) AS rn " +
            "  FROM ##db-schema-name##.TWNRPT_MTH_CASEHST t " +
            "  WHERE t.OFC_CD = ? AND t.PRGM_CASE_STS='O' AND t.LST_REC_FR_MTH='Y' " +
            "  AND t.PRGM_CASE_TYPE IN ('FS', 'AF')" +
            "  AND t.STS_EFF_DT BETWEEN ? AND ? " +
            "  ORDER BY t.OFC_CD ASC, t.SPRVS_UNIT ASC, t.FUNC_AREA_CD ASC, t.WRKR_TYPE ASC, t.PSN_NMB ASC"+
            ") sub " +
            "WHERE sub.rn BETWEEN ? AND ?";
    
    private static final String GET_ALL_PCE_RECORDS_OFC_COUNT_BYDATE = "SELECT COUNT(*) FROM ##db-schema-name##.TWNRPT_MTH_CASEHST WHERE OFC_CD IN (##OFC-CD##) AND RUN_DATE = ?";
    
    private static final String GET_ALL_PCE_RECORDS_OFC_DATE = "SELECT * FROM ##db-schema-name##.TWNRPT_MTH_CASEHST WHERE OFC_CD IN (##OFC-CD##) AND RUN_DATE = ?";

    @Autowired
    @Qualifier("nswdJdbcTemplate")
    JdbcTemplate nswdJdbcTemplate;

    @Value("${db.nswd.schema}")
    String schemaName;

    @Autowired
    DataSource dataSource;

    @Autowired
    ReportMonthlyCaseHistorySorDao sorDao;

    public List<ReportMonthlyCaseHistorySorRecord> getPceRecordsByMonthly(String reportDate) {
        String sql = getSql(GET_ALL_PCE_RECORDS_MONTHLY);
         List<SorRecord> sorRecord = this.nswdJdbcTemplate.query(sql, this.sorDao.getSorMapper(), reportDate);
        
         return sorRecord.stream().map(e-> (ReportMonthlyCaseHistorySorRecord) e).collect(Collectors.toList());
    }

    public List<String> getOfficeCodes(String fromDate, String toDate) {
        String sql = getSql(GET_ALL_OFFICE_CODES);
        return nswdJdbcTemplate.queryForList(sql, String.class, fromDate, toDate);
    }

    public Integer getPceRecordsByDateCount(String reportDate) {
        String sql = getSql(GET_ALL_PCE_RECORDS_DATE_COUNT);
        return this.nswdJdbcTemplate.queryForObject(sql, Integer.class, reportDate);
    }

    public List<ReportMonthlyCaseHistorySorRecord> getPceRecordByOfcCd(String ofcCds){
    	String sql = this.getSql(GET_ALL_PCE_RECORDS_OFC.replace("##OFC-CD##", ofcCds));
    	List<SorRecord> sorRecord = this.nswdJdbcTemplate.query(sql, this.sorDao.getSorMapper());
    	return sorRecord.stream().map(e-> (ReportMonthlyCaseHistorySorRecord) e).collect(Collectors.toList());
    }

	public List<ReportMonthlyCaseHistorySorRecord> getPceRecords() {
		List<SorRecord> sorRecord = this.nswdJdbcTemplate.query(getSql(GET_ALL_PCE_RECORDS), this.sorDao.getSorMapper());
		return sorRecord.stream().map(e-> (ReportMonthlyCaseHistorySorRecord) e).collect(Collectors.toList());
	}
	
	public Integer getPceRecordByOfcCdCount(String ofcCds){
    	String sql = getSql(GET_ALL_PCE_RECORDS_OFC_COUNT.replace("##OFC-CD##", ofcCds));
    	return this.nswdJdbcTemplate.queryForObject(sql, Integer.class);
    }

	public Integer getPceRecordsCount() {
		return this.nswdJdbcTemplate.queryForObject(getSql(GET_ALL_PCE_RECORDS_COUNT), Integer.class);
	}

    public Integer countPceRecordsByOfficeCode(String officeCode, String fromDate, String toDate) {
        String sql = getSql(GET_PCE_RECORDS_OFFICE_CODE_COUNT);
        return nswdJdbcTemplate.queryForObject(sql, Integer.class, officeCode, fromDate, toDate);
    }

    public List<ReportMonthlyCaseHistorySorRecord> getDailyCaseHistoryRecordsByOfcNmWithPaging(String officeCode, int startIndex, int maxRows,
                                                                                               String fromDate, String toDate) throws SQLException {
        int fromRow = startIndex + 1;
        int toRow = startIndex + maxRows;
        List<ReportMonthlyCaseHistorySorRecord> reportRecords = new ArrayList<>();
        Connection connection = DataSourceUtils.getConnection(dataSource);
        try {
            String sql = getSql(GET_PCE_RECORDS);
            List<SorRecord> sorRecords = nswdJdbcTemplate.query(sql, this.sorDao.getSorMapper(), officeCode, fromDate, toDate, fromRow, toRow);
            reportRecords =  sorRecords.stream()
                    .map(ReportMonthlyCaseHistorySorRecord.class::cast)
                    .collect(Collectors.toList());
        } catch (Exception e) {
            connection.rollback();
        } finally {
            DataSourceUtils.releaseConnection(connection, dataSource);
        }
        return reportRecords;
    }

	@Override
	public String getSql(String sql) {
        return sql.replaceAll(Dao.SQL_DB_SCHEMA_PATTERN, schemaName);
    }
	
	public Integer getPceRecordByOfcCdByDateCount(String ofcCds, String reportDate){
    	String sql = getSql(GET_ALL_PCE_RECORDS_OFC_COUNT_BYDATE.replace("##OFC-CD##", ofcCds));
    	return this.nswdJdbcTemplate.queryForObject(sql, Integer.class, reportDate);
    }
	
	public List<ReportMonthlyCaseHistorySorRecord> getPceRecordByOfcCdDate(String ofcCds, String reportDate){
    	String sql = this.getSql(GET_ALL_PCE_RECORDS_OFC_DATE.replace("##OFC-CD##", ofcCds));
    	List<SorRecord> sorRecord = this.nswdJdbcTemplate.query(sql, this.sorDao.getSorMapper(), reportDate);
    	return sorRecord.stream().map(e-> (ReportMonthlyCaseHistorySorRecord) e).collect(Collectors.toList());
    }
}