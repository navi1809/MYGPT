PREV_FARI AS (
  SELECT
    AQ.OFC_CD, AQ.OFC_NM, AQ.ICI,
    AQ.AP_TS,
    FA.ACTN_TS  AS PREV_TS,
    FA.ACTN_TYP AS PREV_TYP,
    CH.FS_SUFX,
    ROW_NUMBER() OVER (PARTITION BY AQ.ICI ORDER BY FA.ACTN_TS DESC)             AS rn_prev,
    ROW_NUMBER() OVER (PARTITION BY AQ.ICI, FA.ACTN_TS ORDER BY CH.PRD_BEG_DT DESC) AS rn_ch
  FROM ACTION_QUERY AQ
  JOIN W026DTF1.TWNFAM_ACTNS FA
    ON FA.ICI = AQ.ICI
   AND FA.PRGM_TYP = 'FS'
   AND FA.ACTN_TS < AQ.AP_TS
   AND FA.ACTN_TYP IN ('FA','RE','RI')
  JOIN W026DTF1.TWNFAM_CASE_HSTRY CH
    ON CH.ICI = FA.ICI
   AND CH.PRD_BEG_DT <= DATE(FA.ACTN_TS)
   AND CH.PRD_END_DT >= DATE(FA.ACTN_TS)
),
S04_PREV AS (
  SELECT OFC_CD, OFC_NM, ICI, AP_TS, PREV_TS, PREV_TYP, FS_SUFX
  FROM PREV_FARI
  WHERE rn_prev = 1   -- the one previous FA/RE/RI row per ICI
    AND rn_ch   = 1   -- the one case-history row covering that prev action
)
