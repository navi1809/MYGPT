SELECT 
    PCH.ICI, PCH.PRGM_CASE_STS, PCH.PRGM_CASE_TYPE, PCH.AID_CD,
    EVR.WTHDR_TST_RSLT_CD, EVR.APL_DTH_TSTRSL_CD, 
    EVR.RSDN_TST_RSLT_CD, EVR.AGDDIS_ST_TSTRS_CD, 
    EVR.VRF_TST_RSLT_CD, EVR.SSN_TEST_RSLT_CD, 
    EVR.COOP_TEST_RSLT_CD, EVR.MRF_COMP_TSTRSL_CD, 
    EVR.BNFT_YR, EVR.BNFT_MTH, EVR.VER_NMB, 
    CAS.CASLD_EFF_DT, CAS.CASLD_ID, CAS.OFC_CD, 
    FCC.HOH_UPI, 
    OFF.OFC_NM, 
    BUDGET.GRS_INC_TST_RSLTCD, BUDGET.RSRCS_TST_RSLT_CD, 
    MBR.LST_BU_CNSD
FROM 
    TWNPRGM_CASE_HSTRY PCH, 
    TWNELIG_VERSION EVR, 
    TWNFAM_CASELD_CASE CAS, 
    TWNFAM_CASE_HSTRY FCC, 
    TWNOFFICE OFF, 
    TWNELG_VER_MBR MBR, 
    TWNELG_BDGT_UNIT BUDGET
WHERE 
    PCH.PRGM_CASE_TYPE = 'MA'
    AND PCH.PRGM_CASE_STS IN ('T', 'D')
    AND PCH.PRD_BEG_DT <= :PRD_BEG_DT
    AND PCH.PRD_END_DT >= :PRD_END_DT

    -- Join TWNELIG_VERSION
    AND EVR.ICI = PCH.ICI
    AND EVR.BNFT_MTH = :BNFT_MTH
    AND EVR.BNFT_YR = :BNFT_YR
    AND EVR.PRGM_CASE_TYPE = 'MA'
    AND EVR.LST_POSTD_VER_IND = 'Y'

    -- Join TWNFAM_CASELD_CASE (Caseload Data)
    AND CAS.ICI = PCH.ICI
    AND CAS.CASLD_EFF_DT = :CASLD_EFF_DT

    -- Join TWNFAM_CASE_HSTRY (Family Case History)
    AND FCC.ICI = PCH.ICI
    AND FCC.PRD_BEG_DT <= :PRD_BEG_DT
    AND FCC.PRD_END_DT >= :PRD_END_DT

    -- Corrected: Join TWNOFFICE using CAS.OFC_CD
    AND OFF.OFC_CD = CAS.OFC_CD

    -- Join TWNELG_VER_MBR (Eligibility Version Member)
    AND MBR.ICI = EVR.ICI
    AND MBR.PRGM_CASE_TYPE = EVR.PRGM_CASE_TYPE
    AND MBR.BNFT_YR = EVR.BNFT_YR
    AND MBR.BNFT_MTH = EVR.BNFT_MTH
    AND MBR.VER_NMB = EVR.VER_NMB
    AND MBR.UPI = FCC.HOH_UPI

    -- Join TWNELG_BDGT_UNIT (Budget Unit Data)
    AND BUDGET.ICI = MBR.ICI
    AND BUDGET.PRGM_CASE_TYPE = MBR.PRGM_CASE_TYPE
    AND BUDGET.BNFT_YR = MBR.BNFT_YR
    AND BUDGET.BNFT_MTH = MBR.BNFT_MTH
    AND BUDGET.VER_NMB = MBR.VER_NMB
    AND BUDGET.BU_NMB = MBR.LST_BU_CNSD;
