SELECT 
'UPDATE W100DP1.TWNPARIS_IN_DTLS SET ICI =' || ''''||TX.ICI ||'''' || 
', HOH_UPI =' || ''''||TRIM(TX.HOH_UPI)||''''||
', UPI =' || ''''||TRIM(TX.UPI)||''''||
', NOD_ADR_LINE1 =' || ''''||TRIM(REPLACE(TX.ADDR_LINE0,'''',''))||''''||
', NOD_ADR_LINE2 =' || ''''||TRIM(REPLACE(TX.ADDR_LINE1,'''',' ')) ||'''' ||
', NOD_ADR_LINE3 =' || ''''||TRIM(TX.ADDR_LINE2) ||'''' ||
', CELL_PHN_NMB =' || ''''||TRIM(TX.CELL_PHN_NMB) ||'''' ||
', EMAIL_ID =' || ''''||TRIM(TX.EMAIL_ID) ||'''' ||
', PR_NOTE1 = 04/29/2025'  ||
' WHERE PR_SSN = ' || ''''||TX.PR_SSN ||''''|| 
--'  AND PR_ST_CD <> ' || ''''||TX.NV_CODE ||'''' || 
'  AND PR_ST_CD = ' || ''''||TX.PR_ST_CD ||'''' ||
'  AND PR_LOADED_TS = ' || ''''||TX.PR_LOADED_TS ||'''' ||
';'

FROM

(
SELECT TY.*
FROM
(

SELECT 
ROW_NUMBER() OVER (
PARTITION BY T3.SSN
ORDER BY PR_FL_DT DESC,
(CASE WHEN PR_ST_CD IN ('AZ','CA','ID','OR','UT') THEN '1' ELSE '2' END) ASC,
PR_LOADED_TS DESC) ROW_NMB,

T0.PR_SSN, T2.UPI, T2.ICI, T4.HOH_UPI, 
T2.PRGM_CASE_TYPE, T2.BNFT_YR, T2.BNFT_MTH, T2.VER_NMB,
T5.HOUSE_NMB,
T5.STR_DIR,
T5.STR_NM ,
T5.STR_TYPE, 
T5.APT_NMB ,
T5.OTH_ADDR ,
T5.CITY,
T5.ST_CD, 
T5.ZIP_CD,
(CASE WHEN T6.CELL_PHN_NMB = ' ' 
             THEN (CASE WHEN T6.HM_PHN_NMB = ' ' 
                        THEN (CASE WHEN T6.WRK_PHN_NMB = ' ' 
                                   THEN ' ' ELSE T6.WRK_PHN_NMB END ) ELSE T6.HM_PHN_NMB END ) ELSE T6.CELL_PHN_NMB END )  CELL_PHN_NMB, 
T6.EMAIL_ID,

(CASE WHEN LENGTH(TRIM(T6.FRST_NM)) > 0     
       THEN (TRIM(T6.FRST_NM)) || ' '            
       ELSE '' END) ||
(CASE WHEN LENGTH(TRIM(T6.LST_NM)) > 0     
       THEN (TRIM(T6.LST_NM))              
       ELSE '' END) as ADDR_LINE0,


(CASE WHEN LENGTH(TRIM(T5.HOUSE_NMB)) > 0    
       THEN (TRIM(T5.HOUSE_NMB)) || ' '      
       ELSE '' END) ||                       
(CASE WHEN LENGTH(TRIM(T5.STR_DIR)) > 0      
       THEN (TRIM(T5.STR_DIR)) || ' '        
       ELSE '' END) ||                       
(CASE WHEN LENGTH(TRIM(T5.STR_NM)) > 0       
       THEN (TRIM(T5.STR_NM)) || ' '         
       ELSE '' END) ||                       
(CASE WHEN LENGTH(TRIM(T5.STR_TYPE)) > 0     
       THEN (TRIM(T5.STR_TYPE)) || ' '            
       ELSE '' END) ||
(CASE WHEN LENGTH(TRIM(T5.APT_NMB)) > 0     
       THEN (TRIM(T5.APT_NMB))  || ' '              
       ELSE '' END) ||    
(CASE WHEN LENGTH(TRIM(T5.OTH_ADDR)) > 0     
       THEN (TRIM(T5.OTH_ADDR))              
       ELSE '' END)        
                AS ADDR_LINE1,
        
(CASE WHEN LENGTH(TRIM(T5.CITY)) > 0       
       THEN (TRIM(T5.CITY)) || ' '         
       ELSE '' END) ||                       
(CASE WHEN LENGTH(TRIM(T5.ST_CD)) > 0     
       THEN (TRIM(T5.ST_CD)) || ' '            
       ELSE '' END) ||
(CASE WHEN LENGTH(TRIM(T5.ZIP_CD)) > 0     
       THEN (TRIM(T5.ZIP_CD))              
       ELSE '' END) AS ADDR_LINE2,
CHAR(T0.PR_LOADED_TS) AS PR_LOADED_TS,
CHAR(T0.PR_ST_CD) AS PR_ST_CD,
'NV' AS NV_CODE 

        

FROM
W100DP1.TWNPARIS_IN_DTLS   T0,
W100DP1.TWNELIG_VERSION    T1,                              
W100DP1.TWNELG_VER_MBR     T2,
W100DP1.TWNPERSON          T3,
W100DP1.TWNFAM_CASE_HSTRY  T4,
W100DP1.TWNPERSON_ADRS_HST T5,
W100DP1.TWNPERSON          T6
                          
WHERE T1.BNFT_YR  = 2025 
  AND T1.BNFT_MTH IN (3)
  AND T1.PRGM_CASE_TYPE IN ('AF' , 'MA')
  AND T1.LST_POSTD_VER_IND = 'Y'    
  AND T1.CASE_RSLT_CD      = 'E'                     
  AND T1.ICI               = T2.ICI                      
  AND T1.PRGM_CASE_TYPE    = T2.PRGM_CASE_TYPE           
  AND T1.BNFT_YR           = T2.BNFT_YR                  
  AND T1.BNFT_MTH          = T2.BNFT_MTH                 
  AND T1.VER_NMB           = T2.VER_NMB                  
  AND T2.ELIG_CD NOT IN (' ', '3', '7', '9')     
  AND T2.UPI              = T3.UPI
  AND T3.SSN              = T0.PR_SSN
  AND T1.ICI = T4.ICI
  AND T4.PRD_BEG_DT <= '2025-04-01'
  AND T4.PRD_END_DT >= '2025-04-01'
  AND T4.HMLS_IND   <> 'Y'
  AND T5.UPI = T4.APPL_UPI
  AND T6.UPI = T4.HOH_UPI
  AND T5.PRD_END_DT = '9999-12-31'
 -- AND T0.PR_ST_CD   <> 'NV'
  AND T0.PR_STS_CD = 'P'
  AND T0.PR_SSN  = '680026958'
  AND T5.ADR_TYPE = (SELECT MIN(S1.ADR_TYPE)
                     FROM W100DP1.TWNPERSON_ADRS_HST S1
                     WHERE T5.UPI = S1.UPI
                       AND S1.ADR_TYPE IN ('BI', 'CM', 'CR') 
                       AND S1.PRD_END_DT = '9999-12-31')
       AND  EXISTS(  SELECT T1A.ICI
                FROM
                W100DP1.TWNELIG_VERSION T1A,                              
                W100DP1.TWNELG_VER_MBR  T2A
                WHERE    T1A.BNFT_YR  = 2025
                  AND T1A.BNFT_MTH IN (4)
                  AND T1A.LST_POSTD_VER_IND = 'Y'                         
                  AND T1A.ICI               = T2A.ICI                      
                  AND T1A.PRGM_CASE_TYPE    = T2A.PRGM_CASE_TYPE           
                  AND T1A.BNFT_YR           = T2A.BNFT_YR                  
                  AND T1A.BNFT_MTH          = T2A.BNFT_MTH                 
                  AND T1A.VER_NMB           = T2A.VER_NMB                  
                  AND T1A.CASE_RSLT_CD      = 'E'                         
                  AND T2A.ELIG_CD NOT IN (' ', '3', '7', '9')     
                  AND T1A.ICI               = T1.ICI                      
                  AND T1A.PRGM_CASE_TYPE    = T1.PRGM_CASE_TYPE  
                  AND T2A.UPI = T2.UPI )
       AND  NOT EXISTS(  SELECT T3A.ICI
                FROM
                W100DP1.TWNELIG_VERSION T3A                              
                WHERE T3A.ICI               = T1.ICI
                                  AND T3A.PRGM_CASE_TYPE    IN ('TN','TC','TL','TP','SG')
                                  AND T3A.BNFT_YR  = 2025
                  AND T3A.BNFT_MTH IN (4)
                  AND T3A.LST_POSTD_VER_IND = 'Y'                         
                  AND T3A.CASE_RSLT_CD      = 'E')                      
                                  
        
ORDER BY T0.PR_SSN
 
) TY

WHERE TY.ROW_NMB = 1
) TX
 

