package IVA_Batch;
import egl.core.*;
import CommonMigratedParts.*;
import DataTables.*;
//*** PROGRAM=ARX04A ****
// COMPONENT NAME: ARX04A Create monthly program case history
// extract
// ===============
// 
// DESCRIPTION:
// ============
// This Module creates sequential program case history extract
// file.
// 
// 
// ***********************
Program ARX04A type basicProgram //VAGen Info - main batch program
  {
  includeReferencedFunctions = yes, allowUnqualifiedItemReferences = yes, 
  throwNrfEofExceptions = yes, handleHardIOErrors = no, V60ExceptionCompatibility = yes, 
  I4GLItemsNullable = no, textLiteralDefaultIsString = no, localSQLScope = yes, 
  inputRecord = VWORKSTOR
  }

  // Data Declarations
  ARX04W ARX04W; // record
  ARX04W2 ARX04W2; // record
  ARX04W3 ARX04W3; // record
  CEP01W CEP01W; // record
  GNOMADS GNOMADS; // record
  H2-3-FAC-FCH-PSY H2-3-FAC-FCH-PSY; // record
  H2-ELIG-VERSION H2-ELIG-VERSION; // record
  H2-FAM-ACTNS H2-FAM-ACTNS; // record
  H2-OFFICE H2-OFFICE; // record
  H2-REDET-RCRT-DTLS H2-REDET-RCRT-DTLS; // record
  H2-WRKR-CALNDR H2-WRKR-CALNDR; // record
  S2-2-NMU-SPT S2-2-NMU-SPT; // record
  SR-ARX04W1 SR-ARX04W1; // record
  SR-ARX04W4 SR-ARX04W4; // record
  VCOMMON VCOMMON; // record
  VCONTROL VCONTROL; // record
  VDBCOMMON VDBCOMMON; // record
  VDBCONTROL VDBCONTROL; // record
  VDTSREC VDTSREC; // record
  VMESSAGE VMESSAGE; // record
  VWORKSTOR VWORKSTOR ; // record

  // VAGen Info - items needed for migration
  VAGen_EZESYS char(8);
  VAGen_EZEREPLY num(1);
  VAGen_EZE_WAIT_TIME bin(9,2);
  VAGen_EZE_ITEMLEN int;

  // Use Declarations
  use VDB00T1 {deleteAfterUse = yes}; // table

  function main()
    // VAGen Info - initialization needed for migration
    VAGen_EZESYS = VGLib.getVAGSysType();
    ARX04P9-MAIN: ARX04P9-MAIN();
  end // end main
end // end ARX04A


// BUILD PCE FILE RECORD
Function ARX04P9-BLD-PCE()
  /* Build PCE-File record based on retreived data.*/
  /* Change due to ptr # 2429 begins*/
  SR-ARX04W1.PCE-LAST-REC-FOR-MNTH = "N";
  SR-ARX04W1.PCE-REINST-IND = "N";
  SR-ARX04W1.PCE-REOPN-IND = "N";
  SR-ARX04W1.PCE-REAPP-IND = "N";
  SR-ARX04W1.PCE-APRVL-IND = "N";
  SR-ARX04W1.PCE-REDET-IND = "N";
  SR-ARX04W1.PCE-CONFRS-IND = "N";
  SR-ARX04W1.PCE-REDET-CMPL-THIS-MNTH = "N";

  /* Changes due to WI - 16122 *** Begin*/

  ARX04W.WS-FILE-AID-CD = " ";
  ARX04W.WS-FILE-ELIG-CD = " ";

  /* Changes due to WI - 16122 *** End*/

  SR-ARX04W1.PCE-REISNT-DT = "0001-01-01";
  SR-ARX04W1.PCE-NEXT-REDET-DT = "0001-01-01";
  /* Change due to ptr # 2429 ends*/

  SR-ARX04W1.PCE-ICI = H2-3-FAC-FCH-PSY.T3-ICI;
  SR-ARX04W1.PCE-PRGM-CASE-TYPE = H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE;
  SR-ARX04W1.PCE-AID-CD = H2-3-FAC-FCH-PSY.AID-CD;
  ARX04W.WS-FILE-AID-CD = H2-3-FAC-FCH-PSY.AID-CD;
  SR-ARX04W1.PCE-PRGM-CASE-STS = H2-3-FAC-FCH-PSY.PRGM-CASE-STS;
  SR-ARX04W1.PCE-PRGM-STS-EFF-DT = H2-3-FAC-FCH-PSY.STS-EFF-DT;
  SR-ARX04W1.PCE-INIT-APRVL-DT = H2-3-FAC-FCH-PSY.INIT-APRVL-DT;
  /* changes due to ptr# 2799  begin*/
  ARX04W.WS-INIT-APRVL-DT = H2-3-FAC-FCH-PSY.INIT-APRVL-DT;
  /* changes due to ptr# 2799 end*/
  SR-ARX04W1.PCE-APPL-DT = H2-3-FAC-FCH-PSY.APPL-DT;

  /* Added per WI 16122*/
  if (H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE == "MA" && 
  (H2-3-FAC-FCH-PSY.PRGM-CASE-STS == "D" || 
  H2-3-FAC-FCH-PSY.PRGM-CASE-STS == "T"))
    SR-ARX04W1.PCE-CLSRE-RSN-CD = H2-3-FAC-FCH-PSY.CLSRE-RSN-CD;
  else
    SR-ARX04W1.PCE-CLSRE-RSN-CD = H2-3-FAC-FCH-PSY.SYS-CLSRE-DNL-RSN;
  end
  /* End WI 16122*/

  SR-ARX04W1.PCE-EXPD-FS-RSN-CD = H2-3-FAC-FCH-PSY.EXPD-FS-RSN-CD;
  SR-ARX04W1.PCE-ELIG-CD = H2-3-FAC-FCH-PSY.ELIG-CD;
  ARX04W.WS-FILE-ELIG-CD = H2-3-FAC-FCH-PSY.ELIG-CD;
  /*  */
  SR-ARX04W1.PCE-HOH-UPI = H2-3-FAC-FCH-PSY.HOH-UPI;
  SR-ARX04W1.PCE-ASSIST-CD = H2-3-FAC-FCH-PSY.FS-SUFX;
  SR-ARX04W1.PCE-CASE-STS = H2-3-FAC-FCH-PSY.CASE-STS;
  SR-ARX04W1.PCE-MTHLY-RPTR-IND = H2-3-FAC-FCH-PSY.MTHLY-RPTR-IND;
  SR-ARX04W1.PCE-HMLS-IND = H2-3-FAC-FCH-PSY.HMLS-IND;
  /*  */
  SR-ARX04W1.PCE-OFC-CD = H2-3-FAC-FCH-PSY.OFC-CD;
  SR-ARX04W1.PCE-SPRVS-UNIT = H2-3-FAC-FCH-PSY.SPRVS-UNIT;
  SR-ARX04W1.PCE-FUNC-AREA-CD = H2-3-FAC-FCH-PSY.FUNC-AREA-CD;
  SR-ARX04W1.PCE-WRKR-TYPE = H2-3-FAC-FCH-PSY.WRKR-TYPE;
  SR-ARX04W1.PCE-PSN-NMB = H2-3-FAC-FCH-PSY.PSN-NMB;
  SR-ARX04W1.PCE-CASLD-ID = H2-3-FAC-FCH-PSY.CASLD-ID;
  /*  */
end // end ARX04P9-BLD-PCE


// Check for change in caseload
Function ARX04P9-CHK-CSLD()
  /* Check for change in caseload.*/
  /*  */
  if (SR-ARX04W1.PCE-OFC-CD == ARX04W.WS-PREV-OFC-CD
   && SR-ARX04W1.PCE-SPRVS-UNIT == ARX04W.WS-PREV-SPRVS-UNIT
   && SR-ARX04W1.PCE-FUNC-AREA-CD == ARX04W.WS-PREV-FUNC-AREA-CD
   && SR-ARX04W1.PCE-WRKR-TYPE == ARX04W.WS-PREV-WRKR-TYPE
   && SR-ARX04W1.PCE-PSN-NMB == ARX04W.WS-PREV-PSN-NMB)
    /* Continue.....*/
  else
    ARX04W.WS-PREV-OFC-CD = SR-ARX04W1.PCE-OFC-CD;
    ARX04W.WS-PREV-SPRVS-UNIT = SR-ARX04W1.PCE-SPRVS-UNIT;
    ARX04W.WS-PREV-FUNC-AREA-CD = SR-ARX04W1.PCE-FUNC-AREA-CD;
    ARX04W.WS-PREV-WRKR-TYPE = SR-ARX04W1.PCE-WRKR-TYPE;
    ARX04W.WS-PREV-PSN-NMB = SR-ARX04W1.PCE-PSN-NMB;
    /*  */
    /* Get worker details.*/
    ARX04P9-WRKR-DTLS();
  end
  /*  */
  if (SR-ARX04W1.PCE-PRGM-CASE-STS == "O")
    /* Get redetermination date.*/
    ARX04P9-REDET-DTLS();
    /*  */
    /* Get conference details.*/
    ARX04P9-CONFR-DTL();
    /*  */
  end
end // end ARX04P9-CHK-CSLD


// Close PCD File
Function ARX04P9-CLS-PCE()
  /* ** Changes due to PTR # 12596- start ****/
  try
    close SR-ARX04W1 ;
  end
  if (SR-ARX04W1 is ioError)
    VDBCONTROL.UPROC-NM = "ARX04P9-CLS-PCE";
    VDBCONTROL.UPROC-OBJ = "SR-ARX04W1";
    VDBCONTROL.UPROC-OPT = "CLOSE";
    VDBCONTROL.UMSQLCODE = 0;
    VMESSAGE.UMSGINS[2] = "ARX04A";
    ARX04W.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = ARX04W.WS-ERR-LAST-FOUR;
    VDBCONTROL.UEZESQRRM = "PCEFILE FILE - I/O ERROR";
    WCM00P2-TO-CEP01A();
  end
  /* ** Changes due to PTR # 12596- end   ****/
end // end ARX04P9-CLS-PCE


// GET CONFERENCE DETAILS
Function ARX04P9-CONFR-DTL()
  /* Perform standard database application initialization*/
  WDB00PI();
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "ARX04A";
  set H2-WRKR-CALNDR empty;
  /*  */
  /* Get conference details.*/
  H2-WRKR-CALNDR.NOMADS-USRID = ARX04W.WS-WRKR-ID;
  H2-WRKR-CALNDR.UPI = SR-ARX04W1.PCE-HOH-UPI;
  H2-WRKR-CALNDR.PRGM-CASE-TYPE = SR-ARX04W1.PCE-PRGM-CASE-TYPE;
  H2-WRKR-CALNDR.ACTVY-TYPE-CD = "HC";
  H2-WRKR-CALNDR.APMNT-STS = "S";
  ARX04W.WS-LST-YY = ARX04W2.PI1-LST-DAY-MNTH-CCYY;
  ARX04W.WS-LST-MM = ARX04W2.PI1-LST-DAY-MNTH-MM;
  /*  */
  /* Read twnwrkr_calndr.*/
  ARX04P9-WRC-READ();
  /*  */
  if (ARX04W.WS-COUNT > 0)
    SR-ARX04W1.PCE-CONFRS-IND = "Y";
  else
    SR-ARX04W1.PCE-CONFRS-IND = "N";
  end /* end get confr details*/
  /*  */
  VDBCOMMON.UNRF = "Y";
  VDBCOMMON.UDUP = "N";
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
  /* Handle error conditions*/
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
end // end ARX04P9-CONFR-DTL


// GET ELIG DETAILS
Function ARX04P9-ELIG-DTL()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-ELIG-VERSION";
  VDBCONTROL.UPROC-OBJ = "H2-ELIG-VERSION";
  VDBCONTROL.UPROC-NM = "ARX04P9-ELIG-DTL";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  try
    get H2-ELIG-VERSION singleRow
      with #sql{
        select ELIG_NUM,
                CHD_NMB,
                BNFT_AMT,
                ENTLM_AMT,
                BNFT_RDCTN_AMT,
                VER_NMB,
                TOT_MTHLY_BNFT_AMT
        from TWNELIG_VERSION T1
        WHERE ICI = :ICI
        AND PRGM_CASE_TYPE = :PRGM-CASE-TYPE
        AND BNFT_YR = :BNFT-YR
        AND BNFT_MTH = :BNFT-MTH
        AND LST_POSTD_VER_IND = :LST-POSTD-VER-IND
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into ELIG-NUM,
           CHD-NMB,
           BNFT-AMT,
           ENTLM-AMT,
           BNFT-RDCTN-AMT,
           VER-NMB,
           TOT-MTHLY-BNFT-AMT ;
  end
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    VDBCONTROL.UROWR = VDBCONTROL.UROWR + 1;
  end
end // end ARX04P9-ELIG-DTL


// TWNELIG_VERSION SELECT - L1
Function ARX04P9-ELIG-L1()
  SR-ARX04W1.PCE-LAST-REC-FOR-MNTH = "Y";
  H2-ELIG-VERSION.ICI = H2-3-FAC-FCH-PSY.T3-ICI;
  H2-ELIG-VERSION.PRGM-CASE-TYPE = H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE;
  H2-ELIG-VERSION.BNFT-YR = ARX04W2.PI1-LST-DAY-MNTH-CCYY;
  H2-ELIG-VERSION.BNFT-MTH = ARX04W2.PI1-LST-DAY-MNTH-MM;
  H2-ELIG-VERSION.LST-POSTD-VER-IND = "Y";
  VDBCONTROL.UROWR = 0;
  ARX04P9-ELIG-DTL();
  if (sysVar.sqlData.sqlcode == 0)
    SR-ARX04W1.PCE-NO-OF-RCPNT = H2-ELIG-VERSION.ELIG-NUM;
    SR-ARX04W1.PCE-NO-OF-CHLD-RCPNT = H2-ELIG-VERSION.CHD-NMB;

    /* ---- Changes due to WI 16330 Begin -----------------*/

    /* MOVE H2-ELIG-VERSION.BNFT-AMT TO SR-ARX04W1.PCE-BNFT-AMT;*/

    SR-ARX04W1.PCE-BNFT-AMT = H2-ELIG-VERSION.TOT-MTHLY-BNFT-AMT;

    /* ---- Changes due to WI 16330 End   -----------------*/

    SR-ARX04W1.PCE-ENTLM-AMT = H2-ELIG-VERSION.ENTLM-AMT;
    SR-ARX04W1.PCE-BNFT-RDCTN-AMT = H2-ELIG-VERSION.BNFT-RDCTN-AMT;
    SR-ARX04W1.PCE-BNFT-MNTH = H2-ELIG-VERSION.BNFT-MTH;
    SR-ARX04W1.PCE-BNFT-YR = H2-ELIG-VERSION.BNFT-YR;
    SR-ARX04W1.PCE-VER-NMB = H2-ELIG-VERSION.VER-NMB;

  /* ** Changes due to Wi - 16122 Begin ****/
  /* The aid code and elig code pf Program case histtory is moved*/
  /* into the extract file.*/

    SR-ARX04W1.PCE-AID-CD = ARX04W.WS-FILE-AID-CD;
    SR-ARX04W1.PCE-ELIG-CD = ARX04W.WS-FILE-ELIG-CD;

  /* ** Changes due to Wi - 16122 End ****/
  else
    SR-ARX04W1.PCE-NO-OF-RCPNT = 0;
    SR-ARX04W1.PCE-NO-OF-CHLD-RCPNT = 0;
    SR-ARX04W1.PCE-BNFT-AMT = 0.00;
    SR-ARX04W1.PCE-ENTLM-AMT = 0.00;
    SR-ARX04W1.PCE-BNFT-RDCTN-AMT = 0.00;
    SR-ARX04W1.PCE-BNFT-MNTH = 0;
    SR-ARX04W1.PCE-BNFT-YR = 0;
    SR-ARX04W1.PCE-VER-NMB = 0;
  end
  VDBCOMMON.UNRF = "Y";
  VDBCOMMON.UDUP = "N";
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
  /* Handle error conditions*/
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
  /*  */
end // end ARX04P9-ELIG-L1


// TWNELIG_VERSION SELECT - Q1
Function ARX04P9-ELIG-S08()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-ELIG-VERSION";
  VDBCONTROL.UPROC-OBJ = "H2-ELIG-VERSION";
  VDBCONTROL.UPROC-NM = "ARX04P9-ELIG-P1";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  /*  */
  try
    get H2-ELIG-VERSION singleRow
      with #sql{
        select ELIG_NUM,CHD_NMB,BNFT_AMT,ENTLM_AMT,BNFT_RDCTN_AMT,BNFT_YR,
             BNFT_MTH,VER_NMB,TOT_MTHLY_BNFT_AMT
        from TWNELIG_VERSION T1
        WHERE ICI = :ICI
        AND PRGM_CASE_TYPE = :PRGM-CASE-TYPE
        AND BNFT_YR = :BNFT-YR
        AND BNFT_MTH = :BNFT-MTH
        AND VER_NMB = :VER-NMB
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into ELIG-NUM,CHD-NMB,BNFT-AMT,ENTLM-AMT,BNFT-RDCTN-AMT,BNFT-YR,
           BNFT-MTH,VER-NMB,TOT-MTHLY-BNFT-AMT ;
  end
  /*  */
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    VDBCONTROL.UROWR = VDBCONTROL.UROWR + 1;
  end
end // end ARX04P9-ELIG-S08


// edit blank fields
Function ARX04P9-ELIM-BLNK()
  /*  */
  /* wds;wi25865;2003-12-04 - make sure not blanks pass thru required fields*/
  /*  */
  SR-ARX04W1.PCE-WRKR-ID = ARX04W.WS-WRKR-ID;
  SR-ARX04W1.PCE-WRKR-NM = ARX04W.WS-WRKR-NM;
  if (SR-ARX04W1.PCE-CASLD-ID != " "
   && SR-ARX04W1.PCE-OFC-CD != " ")
    ARX04P9-WRIT-PCE();
  end
end // end ARX04P9-ELIM-BLNK


// INQURY Message Text Data
Function ARX04P9-FAC-READ()
  /* Move name of SQL row record used to common record*/
  WDB00PI();
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "ARX04A";
  VDBCOMMON.USQLREC = "H2-FAM-ACTNS";
  VDBCONTROL.UPROC-OBJ = "H2-FAM-ACTNS";
  VDBCONTROL.UPROC-NM = "ARX04P9-FAC-READ";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  /*  */
  try
    open ARX04P9-FAC-READ_RSI01
      with #sql{
        select ACTN_TYP,ACTN_TS,AID_CD,ACTN_EFF_DT,INIT_APRVL_DT,APPL_DT,
            EXPD_FS_RSN_CD,ELIG_CD,ACTN_RSN_CD,MULT_CLSRE_RSN_IND,
            BNFT_YR,BNFT_MTH,VER_NMB,FAM_APPL_TYPE
        from twnfam_actns T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE
                           ICI = :ICI
         AND    PRGM_TYP = :PRGM-TYP
        AND     YEAR(ACTN_TS) = :ARX04W.WS-LST-YY
        AND     MONTH(ACTN_TS) = :ARX04W.WS-LST-MM
        ORDER BY ACTN_TS desc
      }      
      into ACTN-TYP,ACTN-TS,AID-CD,ACTN-EFF-DT,INIT-APRVL-DT,APPL-DT,
           EXPD-FS-RSN-CD,ELIG-CD,ACTN-RSN-CD,MULT-CLSRE-RSN-IND,
           BNFT-YR,BNFT-MTH,VER-NMB,FAM-APPL-TYPE
      for H2-FAM-ACTNS ;
  end
  if (sysVar.sqlData.sqlcode == 0)
    ARX04P9-SCAN-FAM();
  end
end // end ARX04P9-FAC-READ


// GET FAM ACTION DETAILS
Function ARX04P9-FAM-ACTN()
  /* ************************************************************************/
  /* CHANGE DUE TO PHASE3 REWORK BEGIN*/
  /* ************************************************************************/
  /*  */
  /* Added for WI 17199*/
  set H2-FAM-ACTNS empty;
  H2-FAM-ACTNS.ICI = H2-3-FAC-FCH-PSY.T3-ICI;
  H2-FAM-ACTNS.PRGM-TYP = H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE;

  /* **************************************************************/
  /* 03/22/2000;CMcK;wi19273: Modified to pass actn_typ from     */
  /* TWNFAM_ACTNS to the pce-file.  Change in GET-AP-DT SQL      */
  /* **************************************************************/

  ARX04P9-GET-AP-DT();
  ARX04W.WS-ACT-APPL-DT-TS = H2-FAM-ACTNS.ACTN-TS;
  SR-ARX04W1.PCE-ACTN-TYPE = H2-FAM-ACTNS.ACTN-TYP;
  SR-ARX04W1.PCE-ACT-APPL-DT = ARX04W.WS-ACT-APPL-DT;
  /* End for WI 17199*/

  set H2-FAM-ACTNS empty;
  H2-FAM-ACTNS.ICI = H2-3-FAC-FCH-PSY.T3-ICI;
  H2-FAM-ACTNS.PRGM-TYP = H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE;
  ARX04W.WS-LST-YY = ARX04W2.PI1-LST-DAY-MNTH-CCYY;
  ARX04W.WS-LST-MM = ARX04W2.PI1-LST-DAY-MNTH-MM;
  ARX04W.WS-FLAG = "Y";
  ARX04W.WS-FAM-UROWR = 0;
  ARX04P9-FAC-READ();
  /*  */
  ARX04W.WS-SQCOD = sysVar.sqlData.sqlcode;
  /*  */
  /* If no record exist in twnfam_actns and twnprgm_case_hstry's*/
  /* prgm_case_sts = 'd' or 't', then do not write in pce_file else*/
  /* write record in pce_file using twnprgm_case_hstry details*/
  /*  */
  if (H2-FAM-ACTNS is noRecordFound)
    if (H2-3-FAC-FCH-PSY.PRGM-CASE-STS == "D" || 
    H2-3-FAC-FCH-PSY.PRGM-CASE-STS == "T")
      /*  */
      set SR-ARX04W1 empty;
      ARX04W.WS-FLAG = "N";
      /* Fetch next record.*/
      return;
    end
    ARX04P9-CHK-CSLD();
  end
  /*  */
  /* For each record in twnfam_actns a record will be cerated in the*/
  /* extract file.*/
  /* For the last record of the case in fam_actns set flag pce_last_rec_for*/
  /* _mth to 'y'*/
  /* If no record exist in fam_actns then write record with prgm_case_hstry*/
  while (H2-FAM-ACTNS not noRecordFound && H2-FAM-ACTNS not ioError)
    ARX04W.WS-FLAG = "N";
    /*  */
    /* Skip the intermediate approval fam action record*/
    if (H2-FAM-ACTNS.ACTN-TYP == "AP" && 
    H2-FAM-ACTNS.FAM-APPL-TYPE == " " && 
     /**/
     /* Beg Comment Changes due to WI 16122*/
     /* *** Begin*/
     /* Approvals for the current month would*/
     /* be written into the PCE file'*/
     /**/
    (H2-FAM-ACTNS.BNFT-YR > ARX04W2.PI1-LST-DAY-MNTH-CCYY || 
    H2-FAM-ACTNS.BNFT-MTH > ARX04W2.PI1-LST-DAY-MNTH-MM || 
    H2-FAM-ACTNS.BNFT-YR < ARX04W2.PI1-LST-DAY-MNTH-CCYY || 
    H2-FAM-ACTNS.BNFT-MTH < ARX04W2.PI1-LST-DAY-MNTH-MM))
  /*  */
  /* Beg Comment Changes due to WI 16122 *** End*/
  /*  */
      ARX04W.WS-FAM-UROWR = ARX04W.WS-FAM-UROWR - 1;
      ARX04P9-CHK-CSLD();
      ARX04P9-SCAN-FAM();
    else
      /*  */
      /* Write pcefile record before formatting the next record*/
      if (ARX04W.WS-FAM-UROWR > 1)
  /*  */
  /* wds;wi25865;2003-12-03 - eliminate blank fields that cause OC7*/
        ARX04P9-ELIM-BLNK(); /* write out populated pce recs only*/
  /*  */
      end
      SR-ARX04W1.PCE-AID-CD = H2-FAM-ACTNS.AID-CD;
      SR-ARX04W1.PCE-PRGM-STS-EFF-DT = H2-FAM-ACTNS.ACTN-EFF-DT;
      SR-ARX04W1.PCE-EXPD-FS-RSN-CD = H2-FAM-ACTNS.EXPD-FS-RSN-CD;
      SR-ARX04W1.PCE-ELIG-CD = H2-FAM-ACTNS.ELIG-CD;

      if (H2-FAM-ACTNS.APPL-DT != "0001-01-01")
        SR-ARX04W1.PCE-APPL-DT = H2-FAM-ACTNS.APPL-DT;
      end
      SR-ARX04W1.PCE-MULT-CLSRE-IND = " ";
      SR-ARX04W1.PCE-CLSRE-RSN-CD = " ";
      SR-ARX04W1.PCE-LAST-REC-FOR-MNTH = "N";
      SR-ARX04W1.PCE-REINST-IND = "N";
      SR-ARX04W1.PCE-REOPN-IND = "N";
      SR-ARX04W1.PCE-REAPP-IND = "N";
      SR-ARX04W1.PCE-APRVL-IND = "N";
      SR-ARX04W1.PCE-REDET-IND = "N";
      /* Change due to ptr # 2429 begins*/
      SR-ARX04W1.PCE-CONFRS-IND = "N";
      SR-ARX04W1.PCE-REDET-CMPL-THIS-MNTH = "N";
      SR-ARX04W1.PCE-REISNT-DT = "0001-01-01";
      SR-ARX04W1.PCE-NEXT-REDET-DT = "0001-01-01";
      /* Change due to ptr # 2429 ends*/
      /*  */
      /* Based on the elig code of the fam actn record, set default program*/
      /* this may be overwritten if actn type is 'AP','DN', OR 'TR'.*/
      /* changes due ptr# 2799 begin*/
      if (SR-ARX04W1.PCE-INIT-APRVL-DT == "0001-01-01")
        SR-ARX04W1.PCE-INIT-APRVL-DT = ARX04W.WS-INIT-APRVL-DT;
      end
      /* changes due to ptr# 2799 end;*/

      /* ********************************************************************/
      /* Changes due to ptr arx04001 starts*/
      /* ********************************************************************/
      /*  */
      /* If actn type is 'AP' or 'DN' or 'TR', then based on the fam appl*/
      /* type of the fam action record, set the various indicators.*/
      if (H2-FAM-ACTNS.ACTN-TYP == "AP" || 
      H2-FAM-ACTNS.ACTN-TYP == "DN" || 
      H2-FAM-ACTNS.ACTN-TYP == "TR")
        /*  */
        if (H2-FAM-ACTNS.FAM-APPL-TYPE == "FT")
          SR-ARX04W1.PCE-INIT-APRVL-DT = H2-FAM-ACTNS.INIT-APRVL-DT;
        end
        /*  */
        if (H2-FAM-ACTNS.FAM-APPL-TYPE == "RC")
          SR-ARX04W1.PCE-REDET-IND = "Y";
        end
        /*  */
        if (H2-FAM-ACTNS.FAM-APPL-TYPE == "RP")
          SR-ARX04W1.PCE-REAPP-IND = "Y";
        end
        /*  */
        if (H2-FAM-ACTNS.FAM-APPL-TYPE == "RO")
          SR-ARX04W1.PCE-REOPN-IND = "Y";
        end
        /*  */
        if (H2-FAM-ACTNS.FAM-APPL-TYPE == "RI")
          SR-ARX04W1.PCE-REINST-IND = "Y";
          SR-ARX04W1.PCE-REISNT-DT = H2-FAM-ACTNS.ACTN-EFF-DT;
        end
      end
      /*  */
      /* ********************************************************************/
      /* Changes due to ptr arx04001 ends*/
      /* ********************************************************************/
      /*  */
      /* Based on the elig code of the fam action record , set default*/
      /* program case status this may be overwritten if action type is*/
      /* 'AP','DN' or 'TR'.*/
      if (H2-FAM-ACTNS.ELIG-CD == "7")
        SR-ARX04W1.PCE-PRGM-CASE-STS = "P";
        SR-ARX04W1.PCE-INIT-APRVL-DT = "0001-01-01";
      else
        if (H2-FAM-ACTNS.ELIG-CD == "3" || 
        H2-FAM-ACTNS.ELIG-CD == "9")
          SR-ARX04W1.PCE-PRGM-CASE-STS = "D";
        else
          SR-ARX04W1.PCE-PRGM-CASE-STS = "O";
        end
      end
      /*  */
      if (H2-FAM-ACTNS.ACTN-TYP == "FA")
        SR-ARX04W1.PCE-REAPP-IND = "N";
      end
      if (H2-FAM-ACTNS.ACTN-TYP == "RA")
        SR-ARX04W1.PCE-REDET-IND = "Y";
      end
      /*  */
      if (H2-FAM-ACTNS.ACTN-TYP == "AP") /* (Approval)*/
        SR-ARX04W1.PCE-APRVL-IND = "Y";
        SR-ARX04W1.PCE-PRGM-CASE-STS = "O";
      end
      /*  */
      if (H2-FAM-ACTNS.ACTN-TYP == "DN")
        SR-ARX04W1.PCE-MULT-CLSRE-IND = H2-FAM-ACTNS.MULT-CLSRE-RSN-IND;
        SR-ARX04W1.PCE-PRGM-CASE-STS = "D";
        SR-ARX04W1.PCE-CLSRE-RSN-CD = H2-FAM-ACTNS.ACTN-RSN-CD;
        /*  */
   /* ***** Change due to phase IV rework starts ****************/
   /* IF H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE = 'MA';             */
   /* PERFORM ARX04P9-READ-CMH;                            */
   /* END;                                                   */
   /* ***** Change due to phase IV rework ends*****************/
        /*  */
      end
      /*  */
      if (H2-FAM-ACTNS.ACTN-TYP == "TR")
        SR-ARX04W1.PCE-MULT-CLSRE-IND = H2-FAM-ACTNS.MULT-CLSRE-RSN-IND;
        SR-ARX04W1.PCE-PRGM-CASE-STS = "T";
        SR-ARX04W1.PCE-CLSRE-RSN-CD = H2-FAM-ACTNS.ACTN-RSN-CD;
        /*  */
   /* ***** Change due to phase IV rework starts***************/
   /* IF H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE = 'MA';           */
   /* PERFORM ARX04P9-READ-CMH;                          */
   /* END;                                                 */
   /* ***//** Change due to phase IV rework ends*****************/
        /*  */
      end
      /*  */
      /* Change due to phase III rework starts*/
      if (H2-FAM-ACTNS.ACTN-TYP == "RE")
        /*  */
        /* CHANGES DUE TO PTR# 5994 START*/
        /*  */
        if (H2-FAM-ACTNS.FAM-APPL-TYPE == "RP" /* (REAPPLICATION)*/
         || H2-FAM-ACTNS.FAM-APPL-TYPE == "RH")
        /* (REAPPLICATION FOR HIGHER AID CODE)*/
          /* CHANGES DUE TO PTR# 5994 END*/
          /*  */
          SR-ARX04W1.PCE-REAPP-IND = "Y";
        else
          SR-ARX04W1.PCE-REOPN-IND = "Y";
        end
      end
      /*  */
      if (H2-FAM-ACTNS.ACTN-TYP == "RI")
        SR-ARX04W1.PCE-REINST-IND = "Y";
        SR-ARX04W1.PCE-REISNT-DT = H2-FAM-ACTNS.ACTN-EFF-DT;
  /* ELSE;*/
  /* MOVE '0001-01-01' TO SR-ARX04W1.PCE-REISNT-DT;*/
      end
      /*  */
      /* Change due to phase III rework ends*/
      /*  */
      /* If the fam actn record has the elig version key fetch the elig ver*/
      /* details else initialize the field populated from elig version*/
      if (H2-FAM-ACTNS.BNFT-YR != 0 && 
      H2-FAM-ACTNS.BNFT-YR != null)
        ARX04P9-RD-ELG-S08();
      else
        SR-ARX04W1.PCE-NO-OF-RCPNT = 0;
        SR-ARX04W1.PCE-NO-OF-CHLD-RCPNT = 0;
        SR-ARX04W1.PCE-BNFT-AMT = 0.00;
        SR-ARX04W1.PCE-ENTLM-AMT = 0.00;
        SR-ARX04W1.PCE-BNFT-RDCTN-AMT = 0.00;
        SR-ARX04W1.PCE-BNFT-MNTH = 0;
        SR-ARX04W1.PCE-BNFT-YR = 0;
        SR-ARX04W1.PCE-VER-NMB = 0;
      end
      ARX04P9-CHK-CSLD();
      ARX04P9-SCAN-FAM();
    end /* End of actn_type = 'AP'*/
  end /* End while loop fam_actions setinq*/
  /*  */
  /* Move the row count of fam_case scan to db control variable, since*/
  /* sqlerror common routine set's message occordingly.*/
  VDBCONTROL.UROWR = ARX04W.WS-FAM-UROWR;
  VDBCOMMON.UNRF = "1";
  VDBCOMMON.UDUP = "N";
  /*  */
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
  /*  */
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
  /*  */
  /* Last record will have PCE-LAST-REC-FOR-MNTH to 'Y'.The latest elig*/
  /* version record for the month will be fetched and attached to this*/
  /* record.*/
  ARX04P9-ELIG-L1();
  /*  */
  /* wds;wi99999;2003-12-03 - eliminate blank fields that cause OC7*/
  ARX04P9-ELIM-BLNK(); /* write out populated pce recs only*/
  /*  */
  /* Changes due to release I system testing 04/11/95 ends*/
end // end ARX04P9-FAM-ACTN


// INQURY Message Text Data
Function ARX04P9-GET-AP-DT()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-FAM-ACTNS";
  VDBCONTROL.UPROC-OBJ = "H2-FAM-ACTNS";
  VDBCONTROL.UPROC-NM = "ARX04P9-GET-AP-DT";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  /*  */
  try
    get H2-FAM-ACTNS singleRow
      with #sql{
        select t1.ACTN_TS, t1.ACTN_TYP
        from twnfam_actns T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE
                T1.ICI = :ICI
         AND    T1.PRGM_TYP = :PRGM-TYP
         AND    T1.ACTN_TYP IN ('FA','RA','RE')
        and T1.ACTN_TS in (select Max(T2.ACTN_TS)
                        from twnfam_actns t2
                        WHERE  T2.ICI = :ICI
        AND    T2.PRGM_TYP = :PRGM-TYP
        AND    T2.ACTN_TYP IN ('FA','RA','RE'))
         --** INSERT ORDER BY CLAUSE HERE **
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into ACTN-TS, ACTN-TYP ;
  end
end // end ARX04P9-GET-AP-DT


// RETRIVE PCH DATA
Function ARX04P9-GET-DB-DAT()
  /* Select all program case records for the month*/
  /* Read twnprgm_case_hstry using ARX04A_S01 (set inquiry)*/
  WS-OFF-DATA = "NONE";
  ARX04P9-OFC-INQ();
  while (H2-OFFICE not ioError && H2-OFFICE not noRecordFound)
    ARX04P9-OFC-SCAN();
    VDBCOMMON.UNRF = "1";
    VDBCOMMON.UDUP = "N";
    WDB00PE-SQLERR();
    if (VDBCONTROL.URC > 104)
      WCM00P2-TO-CEP01A();
    end
    if (H2-OFFICE not ioError && H2-OFFICE not noRecordFound)
      H2-3-FAC-FCH-PSY.OFC-CD = H2-OFFICE.OFC-CD;
      ARX04P9-PCY-INQ();
      if (sysVar.sqlData.sqlcode == 0)
        ARX04P9-PCY-SCAN();
        VDBCOMMON.UNRF = "1";
        VDBCOMMON.UDUP = "N";
        WDB00PE-SQLERR();
        if (VDBCONTROL.URC > 104)
          WCM00P2-TO-CEP01A();
        end
        while (H2-3-FAC-FCH-PSY not noRecordFound && H2-3-FAC-FCH-PSY not ioError)
          WS-OFF-DATA = "SOME";
          ARX04P9-BLD-PCE();
          ARX04P9-FAM-ACTN();
          set SR-ARX04W1 empty;
          ARX04P9-PCY-SCAN();
          VDBCOMMON.UNRF = "1";
          VDBCOMMON.UDUP = "N";
          WDB00PE-SQLERR();
          if (VDBCONTROL.URC > 104)
            WCM00P2-TO-CEP01A();
          end
        end
      end
    end
  end
  if (sysVar.sqlData.sqlcode == 100 && WS-OFF-DATA == "NONE")
    VDBCONTROL.UPROC-OBJ = "H2-3-FAC-FCH-PSY";
    VDBCONTROL.UPROC-NM = "ARX04P9-GET-DB-DAT";
    VDBCONTROL.UPROC-OPT = "SCAN";
    VMESSAGE.UMSGINS[2] = "ARX04A";
    VMESSAGE.UMSGCODE = "ARX0401E";
  /* **MOVE 'NO DATA TO EXTRACT FOR PCEFILE' TO VDBCONTROL.UEZESQRRM;*/
    VMESSAGE.UMSGCODE-JCL-ERR = 8;
    WCM00P2-TO-CEP01A();
    exit program;
  end
  /* Move the row count of fam_case scan to db control variable, since*/
  /* sqlerror common routine set's message occordingly.*/
  VDBCONTROL.UROWR = ARX04W.WS-FAC-UROWR;
  VDBCOMMON.UNRF = "1";
  VDBCOMMON.UDUP = "N";
  WDB00PE-SQLERR();
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
end // end ARX04P9-GET-DB-DAT


// INITIALIZATION PROCESS
Function ARX04P9-INITIALIZE()
  /* ** Changes due to PTR # 12537- start ****/
  VGVar.handleHardIOErrors = 1;
  /* ** Changes due to PTR # 12537- end   ****/

  /* Initailise working storage*/
  set ARX04W empty;
  set SR-ARX04W1 empty;
  set ARX04W2 empty;
  set ARX04W3 empty;
end // end ARX04P9-INITIALIZE


// SCAN PCE FILE
Function ARX04P9-INP-SCAN()
  /* ************************************************************************/
  /* This process scans the input file and stores it in the*/
  /* serial record*/
  /* ************************************************************************/
  /*  */
  try
    get next SR-ARX04W4 ;
  end
  /*  */
  if (SR-ARX04W4 is ioError)
    VMESSAGE.UMSGINS[2] = "ARX04A";
    VDBCONTROL.UPROC-NM = "ARX04P9-MAIN";
    VDBCONTROL.UPROC-OBJ = "SR-ARX04W4";
    VDBCONTROL.UPROC-OPT = "SCAN";
  /* ** Changes due to PTR # 12537- start ****/
    VDBCONTROL.UMSQLCODE = 0;
  /* **  MOVE EZERT8 TO VMESSAGE.UMSGCODE;*/
  /* ** Changes due to PTR # 12537- end   ****/
    ARX04W.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = ARX04W.WS-ERR-LAST-FOUR;
    VDBCONTROL.UEZESQRRM = "INPUT PARAMETER FILE - I/O ERROR";
    WCM00P2-TO-CEP01A();
  end
end // end ARX04P9-INP-SCAN


// Main process
Function ARX04P9-MAIN()
  /* ************************************************************************/
  /* Main process for arx04a application, Creates sequential program case*/
  /* history extrace file. The run sequence is before executing any*/
  /* application that prints monthly program case level statistics.*/
  /*  */
  /* 1. Initailise working storage*/
  /* 2. Scan input file*/
  /* 3. Validate date fields read*/
  /* 4. Perform computation process*/
  /* 5. End application*/
  /* ************************************************************************/
  /*  */
  /* Initailise working storage*/
  ARX04P9-INITIALIZE();
  /*  */
  /* Scan input file*/
  ARX04P9-INP-SCAN();
  /*  */
  /* Validate input data (date validation)*/
  ARX04P9-VALIDATE();
  /*  */
  /* Get program case history details process*/
  ARX04P9-GET-DB-DAT();
  /*  */
  /* Close PCEFILE*/
  ARX04P9-CLS-PCE();
end // end ARX04P9-MAIN


// GET WORKER DETAILS
Function ARX04P9-NMU-READ()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "S2-2-NMU-SPT";
  VDBCONTROL.UPROC-OBJ = "S2-2-NMU-SPT";
  VDBCONTROL.UPROC-NM = "ARX04P9-NMU-READ";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  /*  */
  try
    get S2-2-NMU-SPT singleRow
      with #sql{
        select T1.NOMADS_USRID, T1.FRST_NM, T1.LST_NM
        from TWNNOMADS_USER T1,
             TWNSUP_UNT_POS_HST T2
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE
                      T2.OFC_CD = :OFC-CD
        AND    T2.PRGM_OFC_TYPE = :PRGM-OFC-TYPE
        AND       T2.SPRVS_UNIT = :SPRVS-UNIT
        AND          T2.PSN_NMB = :PSN-NMB
        AND     T2.NOMADS_USRID = T1.NOMADS_USRID
        AND     T2.ASMNT_BEG_DT <= :ARX04W2.PI1-LST-DAY-MNTH
        AND     T2.ASMNT_END_DT >= :ARX04W2.PI1-LST-DAY-MNTH
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into NOMADS-USRID, FRST-NM, LST-NM ;
  end
  /*  */
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    VDBCONTROL.UROWR = VDBCONTROL.UROWR + 1;
  end
end // end ARX04P9-NMU-READ


// SET CURSOR FOR OFFICE SQL
Function ARX04P9-OFC-INQ()
  /* Perform database application initialization*/
  WDB00PI();
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "ARX04A";
  /*  */
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-OFFICE";
  VDBCONTROL.UPROC-OBJ = "H2-OFFICE";
  VDBCONTROL.UPROC-NM = "ARX04P9-OFC-INQ";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  try
    open ARX04P9-OFC-INQ_RSI01
      with #sql{
        select t1.OFC_CD
        from TWNOFFICE T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        where
        T1.OFC_TYP = 'A'
        AND T1.OFC_CD BETWEEN 'AA' AND '01'
         --** INSERT ORDER BY CLAUSE HERE **
      }      
      into OFC-CD
      for H2-OFFICE ;
  end
end // end ARX04P9-OFC-INQ


// READ OFFICE ROWS
Function ARX04P9-OFC-SCAN()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-OFFICE";
  VDBCONTROL.UPROC-OBJ = "H2-OFFICE";
  VDBCONTROL.UPROC-NM = "ARX04P9-OFC-SCAN";
  VDBCONTROL.UPROC-OPT = "SCAN";
  /*  */
  try
    get next H2-OFFICE ;
  end
  /*  */
end // end ARX04P9-OFC-SCAN


// RETRIEVE CASE DETAILS
Function ARX04P9-PCY-INQ()
  /* Perform database application initialization*/
  WDB00PI();
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "ARX04A";
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-3-FAC-FCH-PSY";
  VDBCONTROL.UPROC-OBJ = "H2-3-FAC-FCH-PSY";
  VDBCONTROL.UPROC-NM = "ARX04P9-PCY-INQ";
  VDBCONTROL.UPROC-OPT = "SETINQ";
  /*  */
  try
    open ARX04P9-PCY-INQ_RSI01
      with #sql{
        select T1.OFC_CD,  T1.SPRVS_UNIT,
            T1.PSN_NMB, T1.FUNC_AREA_CD, T1.WRKR_TYPE,
            T1.CASLD_ID, T2.CASE_STS,
            T2.MTHLY_RPTR_IND,  T2.HOH_UPI,  T2.FS_SUFX,
            T2.HMLS_IND,
            T3.ICI, T3.PRGM_CASE_TYPE,
            T3.STS_EFF_DT, T3.PRGM_CASE_STS,
            T3.EXPD_FS_RSN_CD, T3.INIT_APRVL_DT, T3.APPL_DT,
            T3.AID_CD,
            T3.ELIG_CD, T3.CLSRE_RSN_CD,
            T3.MULT_CLSRE_RSN_IND, T3.SYS_CLSRE_DNL_RSN
        from TWNFAM_CASELD_CASE T1,
             TWNFAM_CASE_HSTRY T2,
             TWNPRGM_CASE_HSTRY T3
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE
        T1.ofc_cd = :OFC-CD AND
        T3.PRD_BEG_DT <= :ARX04W2.PI1-LST-DAY-MNTH AND
        T3.PRD_END_DT >= :ARX04W2.PI1-LST-DAY-MNTH AND
        T3.PRGM_CASE_TYPE IN ('AF', 'FS', 'MA', 'TC', 'TL',
                              'TN', 'TP', 'SG', 'MC', 'AO') AND
        T2.PRD_BEG_DT <= :ARX04W2.PI1-LST-DAY-MNTH AND
        T2.PRD_END_DT >= :ARX04W2.PI1-LST-DAY-MNTH AND
        T2.ICI = T3.ICI AND
        T1.ICI = T3.ICI
        ORDER BY
        T1.OFC_CD ASC, T1.SPRVS_UNIT ASC,
        T1.FUNC_AREA_CD ASC, T1.WRKR_TYPE ASC,T1.PSN_NMB ASC,T3.ICI ASC,
        T3.PRGM_CASE_TYPE ASC,T3.AID_CD
      }      
      into OFC-CD, SPRVS-UNIT, PSN-NMB,
           FUNC-AREA-CD, WRKR-TYPE, CASLD-ID,
           CASE-STS, MTHLY-RPTR-IND, HOH-UPI,
           FS-SUFX, HMLS-IND,
           T3-ICI, PRGM-CASE-TYPE, STS-EFF-DT,
           PRGM-CASE-STS, EXPD-FS-RSN-CD,
           INIT-APRVL-DT, APPL-DT,
           AID-CD, ELIG-CD, CLSRE-RSN-CD,
           MULT-CLSRE-RSN-IND, SYS-CLSRE-DNL-RSN
      for H2-3-FAC-FCH-PSY ;
  end
end // end ARX04P9-PCY-INQ


// SCAN CASE DETAILS
Function ARX04P9-PCY-SCAN()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-3-FAC-FCH-PSY";
  VDBCONTROL.UPROC-OBJ = "H2-3-FAC-FCH-PSY";
  VDBCONTROL.UPROC-NM = "ARX04P9-PCY-SCAN";
  VDBCONTROL.UPROC-OPT = "SCAN";
  /*  */
  try
    get next H2-3-FAC-FCH-PSY ;
  end
  /*  */
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    ARX04W.WS-FAC-UROWR = ARX04W.WS-FAC-UROWR + 1;
  end
end // end ARX04P9-PCY-SCAN


// TWNELIG_VERSION SELECT - P1
Function ARX04P9-RD-ELG-S08()
  /* Changes due to release I system testing 04/11/95 begin*/
  VDBCONTROL.UROWR = 0;
  set H2-ELIG-VERSION empty;
  H2-ELIG-VERSION.ICI = H2-3-FAC-FCH-PSY.T3-ICI;
  H2-ELIG-VERSION.PRGM-CASE-TYPE = H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE;
  H2-ELIG-VERSION.BNFT-YR = H2-FAM-ACTNS.BNFT-YR;
  H2-ELIG-VERSION.BNFT-MTH = H2-FAM-ACTNS.BNFT-MTH;
  H2-ELIG-VERSION.VER-NMB = H2-FAM-ACTNS.VER-NMB;
  /*  */
  ARX04P9-ELIG-S08();
  /*  */
  if (sysVar.sqlData.sqlcode == 0)
    SR-ARX04W1.PCE-NO-OF-RCPNT = H2-ELIG-VERSION.ELIG-NUM;
    SR-ARX04W1.PCE-NO-OF-CHLD-RCPNT = H2-ELIG-VERSION.CHD-NMB;

    /* ---- Changes due to WI 16330 Begin -----------------*/
    /* MOVE H2-ELIG-VERSION.BNFT-AMT TO SR-ARX04W1.PCE-BNFT-AMT;*/
    /* ---- Changes due to WI 16330 End   -----------------*/

    SR-ARX04W1.PCE-BNFT-AMT = H2-ELIG-VERSION.TOT-MTHLY-BNFT-AMT;
    SR-ARX04W1.PCE-ENTLM-AMT = H2-ELIG-VERSION.ENTLM-AMT;
    SR-ARX04W1.PCE-BNFT-RDCTN-AMT = H2-ELIG-VERSION.BNFT-RDCTN-AMT;
    SR-ARX04W1.PCE-BNFT-MNTH = H2-ELIG-VERSION.BNFT-MTH;
    SR-ARX04W1.PCE-BNFT-YR = H2-ELIG-VERSION.BNFT-YR;
    SR-ARX04W1.PCE-VER-NMB = H2-ELIG-VERSION.VER-NMB;

  /* Changes due to Wi 16122 *** Begin*/
  /* The AID code and Elig code from Program case history is moved*/
   /* to extract file ****/
    SR-ARX04W1.PCE-AID-CD = ARX04W.WS-FILE-AID-CD;
    SR-ARX04W1.PCE-ELIG-CD = ARX04W.WS-FILE-ELIG-CD;
  /* Changes due to Wi 16122 *** End*/
  else
    SR-ARX04W1.PCE-NO-OF-RCPNT = 0;
    SR-ARX04W1.PCE-NO-OF-CHLD-RCPNT = 0;
    SR-ARX04W1.PCE-BNFT-AMT = 0.00;
    SR-ARX04W1.PCE-ENTLM-AMT = 0.00;
    SR-ARX04W1.PCE-BNFT-RDCTN-AMT = 0.00;
    SR-ARX04W1.PCE-BNFT-MNTH = 0;
    SR-ARX04W1.PCE-BNFT-YR = 0;
    SR-ARX04W1.PCE-VER-NMB = 0;
  end
  /*  */
  VDBCOMMON.UNRF = "Y";
  VDBCOMMON.UDUP = "N";
  /*  */
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
  /*  */
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
  /* Changes due to release I system testing 04/11/95 ends*/
end // end ARX04P9-RD-ELG-S08


// GET REDETERMINATION DETAILS
Function ARX04P9-REDET-DTLS()
  /* Perform standard database application initialization*/
  WDB00PI();
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "ARX04A";
  set H2-REDET-RCRT-DTLS empty;
  /*  */
  /* Get next redetermination date.*/
  H2-REDET-RCRT-DTLS.ICI = H2-3-FAC-FCH-PSY.T3-ICI;
  H2-REDET-RCRT-DTLS.PRGM-CASE-TYPE = H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE;
  H2-REDET-RCRT-DTLS.REDET-CMPLT-DT = null;
  /*  */
  /* Read twnredet-rcrt-dtl.*/
  ARX04P9-RRD-READ();
  /*  */
  if (sysVar.sqlData.sqlcode == 0)
    SR-ARX04W1.PCE-NEXT-REDET-DT = H2-REDET-RCRT-DTLS.NEXT-REDET-DT;
  else
    /* Move null date.*/
    SR-ARX04W1.PCE-NEXT-REDET-DT = "0001-01-01";
  end
  VDBCOMMON.UNRF = "Y";
  VDBCOMMON.UDUP = "N";
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
  /* Handle error conditions*/
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
  /*  */
  /* Perform standard database application initialization*/
  WDB00PI();
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "ARX04A";
  set H2-REDET-RCRT-DTLS empty;
  /*  */
  /* Get current month redetermination deatails*/
  H2-REDET-RCRT-DTLS.ICI = H2-3-FAC-FCH-PSY.T3-ICI;
  H2-REDET-RCRT-DTLS.PRGM-CASE-TYPE = H2-3-FAC-FCH-PSY.PRGM-CASE-TYPE;
  ARX04W.WS-LST-YY = ARX04W2.PI1-LST-DAY-MNTH-CCYY;
  ARX04W.WS-LST-MM = ARX04W2.PI1-LST-DAY-MNTH-MM;
  /*  */
  /* Read twnredet-rcrt-dtl.*/
  ARX04P9-RRD-RD();
  /*  */
  if (ARX04W.WS-COUNT > 0)
    SR-ARX04W1.PCE-REDET-CMPL-THIS-MNTH = "Y";
  else
    SR-ARX04W1.PCE-REDET-CMPL-THIS-MNTH = "N";
  end
  /*  */
  VDBCOMMON.UNRF = "Y";
  VDBCOMMON.UDUP = "N";
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
  /* Handle error conditions*/
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
end // end ARX04P9-REDET-DTLS


// GET CURRENT REDET DATE
Function ARX04P9-RRD-RD()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-REDET-RCRT-DTLS";
  VDBCONTROL.UPROC-OBJ = "H2-REDET-RCRT-DTLS";
  VDBCONTROL.UPROC-NM = "ARX04P9-RRD-RD";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  /*  */
  try
    get H2-REDET-RCRT-DTLS singleRow
      with #sql{
        select COUNT(*)
        from TWNREDET_RCRT_DTLS T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE
             ICI = :ICI
        AND PRGM_CASE_TYPE = :PRGM-CASE-TYPE
        AND YEAR(REDET_CMPLT_DT)  = :ARX04W.WS-LST-YY
        AND MONTH(REDET_CMPLT_DT) = :ARX04W.WS-LST-MM
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into ARX04W.WS-COUNT ;
  end
  /*  */
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    VDBCONTROL.UROWR = VDBCONTROL.UROWR + 1;
  end
end // end ARX04P9-RRD-RD


// GET NEXT REDET DATE
Function ARX04P9-RRD-READ()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-REDET-RCRT-DTLS";
  VDBCONTROL.UPROC-OBJ = "H2-REDET-RCRT-DTLS";
  VDBCONTROL.UPROC-NM = "ARX04P9-RRD-READ";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  /*  */
  try
    get H2-REDET-RCRT-DTLS singleRow
      with #sql{
        select MAX(NEXT_REDET_DT)
         --WI#25217;wds;2003-06-13 - add "MAX" to elim. mult. rows
        from TWNREDET_RCRT_DTLS T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE
                         ICI = :ICI
        AND   PRGM_CASE_TYPE = :PRGM-CASE-TYPE
        AND (REDET_CMPLT_DT IS NULL
        OR   REDET_CMPLT_DT = '9999-12-31'
        OR   REDET_CMPLT_DT = '0001-01-01')
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into NEXT-REDET-DT ;
  end
  /*  */
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    VDBCONTROL.UROWR = VDBCONTROL.UROWR + 1;
  end
end // end ARX04P9-RRD-READ


// SCAN FAM ACTION CURSOR
Function ARX04P9-SCAN-FAM()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-FAM-ACTNS";
  VDBCONTROL.UPROC-OBJ = "H2-FAM-ACTNS";
  VDBCONTROL.UPROC-NM = "ARX04P9-SCAN-FAM";
  VDBCONTROL.UPROC-OPT = "SCAN";
  /*  */
  try
    get next H2-FAM-ACTNS ;
  end
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    ARX04W.WS-FAM-UROWR = ARX04W.WS-FAM-UROWR + 1;
  end
end // end ARX04P9-SCAN-FAM


// VALIDATE INPUT PARMS
Function ARX04P9-VALIDATE()
  /* ************************************************************************/
  /* Validate input parameter.*/
  /* ************************************************************************/

  /* ** Changes due to PTR # 11846 - start ****/

  VDBCONTROL.UPROC-NM = "ARX04P9-VALIDATE";
  VDBCONTROL.UPROC-OBJ = "SR-ARX04W4";
  VDBCONTROL.UPROC-OPT = "SCAN";
  VMESSAGE.UMSGINS[2] = "ARX04A";

  /* ** Changes due to PTR # 11846 - end   ****/

  /* Move serial record values to working storage*/

  ARX04W3.PI1-LST-DAY-MNTH = SR-ARX04W4.IN-DATE;
  ARX04W2.PI1-LST-DAY-MNTH-CCYY = ARX04W3.PI1-LST-DAY-MNTH-CCYY;
  ARX04W2.PI1-LST-DAY-MNTH-MM = ARX04W3.PI1-LST-DAY-MNTH-MM;
  ARX04W2.PI1-LST-DAY-MNTH-DD = ARX04W3.PI1-LST-DAY-MNTH-DD;
  ARX04W2.PL1-FIL1 = "-";
  ARX04W2.PL1-FIL2 = "-";
  /*  */
  VDTSREC.UDATMM = ARX04W2.PI1-LST-DAY-MNTH-MM;
  VDTSREC.UDATDD = ARX04W2.PI1-LST-DAY-MNTH-DD;
  VDTSREC.UDATYY = ARX04W2.PI1-LST-DAY-MNTH-CCYY;
  /*  */
  /* Call date validation routine*/
  call "WDT10A" (VCONTROL, VDTSREC) {isNoRefresh = yes};
  /*  */
  /* On date error exit application*/
  if (VCONTROL.URC != 0)

  /* ** Changes due to PTR # 11846 - start ****/
    VMESSAGE.UMSGCODE = "ARX0402E";
  /* **  MOVE 'INVALID INPUT PARAMETER - DATE' TO VDBCONTROL.UEZESQRRM;*/
  /* ** Changes due to PTR # 11846 - end   ****/

    WCM00P2-TO-CEP01A();
    exit program;
  end
  /*  */
  /* Display error if the date is not the last day of the month*/
  if ((ARX04W2.PI1-LST-DAY-MNTH-MM == 1
   || ARX04W2.PI1-LST-DAY-MNTH-MM == 3
   || ARX04W2.PI1-LST-DAY-MNTH-MM == 5
   || ARX04W2.PI1-LST-DAY-MNTH-MM == 7
   || ARX04W2.PI1-LST-DAY-MNTH-MM == 8
   || ARX04W2.PI1-LST-DAY-MNTH-MM == 10
   || ARX04W2.PI1-LST-DAY-MNTH-MM == 12) && 
  ARX04W2.PI1-LST-DAY-MNTH-DD != 31)

  /* ** Changes due to PTR # 11846 - start ****/
    VMESSAGE.UMSGCODE = "ARX0403E";
  /* **  MOVE 'DATE ENTERED MUST BE LAST DATE OF THE MONTH'*/
  /* **    TO VDBCONTROL.UEZESQRRM;*/
  /* ** Changes due to PTR # 11846 - end   ****/

    WCM00P2-TO-CEP01A();
    exit program;
  else
    if ((ARX04W2.PI1-LST-DAY-MNTH-MM == 4
     || ARX04W2.PI1-LST-DAY-MNTH-MM == 6
     || ARX04W2.PI1-LST-DAY-MNTH-MM == 9
     || ARX04W2.PI1-LST-DAY-MNTH-MM == 11) && 
    ARX04W2.PI1-LST-DAY-MNTH-DD != 30)

  /* ** Changes due to PTR # 11846 - start ****/
      VMESSAGE.UMSGCODE = "ARX0403E";
  /* **    MOVE 'INPUT DATE MUST BE LAST DAY OF THE MONTH'*/
  /* **      TO VDBCONTROL.UEZESQRRM;*/
  /* ** Changes due to PTR # 11846 - end   ****/

      WCM00P2-TO-CEP01A();
      exit program;
    end
  end
  /*  */
  /* Check for leap year and check for last day of the month*/
  /* Display error if the date is not the last day of the month*/
  if (ARX04W2.PI1-LST-DAY-MNTH-MM == 2)
    ARX04W.WS-LEAP-FLAG = "N";
    ARX04W.WS-TEMP = ARX04W2.PI1-LST-DAY-MNTH-CCYY % 4;
    if ((ARX04W.WS-TEMP == 0))
      ARX04W.WS-TEMP = ARX04W2.PI1-LST-DAY-MNTH-CCYY % 100;
      if (ARX04W.WS-TEMP != 0)
        ARX04W.WS-LEAP-FLAG = "Y";
      else
        ARX04W.WS-TEMP = ARX04W2.PI1-LST-DAY-MNTH-CCYY % 400;
        if (ARX04W.WS-TEMP == 0)
          ARX04W.WS-LEAP-FLAG = "Y";
        end
      end
    end
  end
  /*  */
  /* If leap year then last day of the month should be checked for 29*/
  /* else 28.*/
  if ((ARX04W.WS-LEAP-FLAG == "Y" && 
  ARX04W2.PI1-LST-DAY-MNTH-DD != 29) || 
  (ARX04W.WS-LEAP-FLAG == "N" && 
  ARX04W2.PI1-LST-DAY-MNTH-DD != 28))

  /* ** Changes due to PTR # 11846 - start ****/
    VMESSAGE.UMSGCODE = "ARX0403E";
  /* **  MOVE 'INPUT DATE MUST BE LAST DAY OF THE MONTH'*/
  /* **    TO VDBCONTROL.UEZESQRRM;*/
  /* ** Changes due to PTR # 11846 - end   ****/

    WCM00P2-TO-CEP01A();
    exit program;
  end
end // end ARX04P9-VALIDATE


// RETRIEVE WORKER CALENDAR DTLS
Function ARX04P9-WRC-READ()
  /* Move name of SQL row record used to common record*/
  VDBCOMMON.USQLREC = "H2-WRKR-CALNDR";
  VDBCONTROL.UPROC-OBJ = "H2-WRKR-CALNDR";
  VDBCONTROL.UPROC-NM = "ARX04P9-WRC-READ";
  VDBCONTROL.UPROC-OPT = "INQUIRY";
  /*  */
  try
    get H2-WRKR-CALNDR singleRow
      with #sql{
        select COUNT(*)
        from TWNWRKR_CALNDR T1
         --** INSERT WHERE, GROUP BY AND HAVING CLAUSES HERE **
        WHERE
                           UPI = :UPI
         AND    PRGM_CASE_TYPE = :PRGM-CASE-TYPE
        AND          YEAR(APMNT_DT) = :ARX04W.WS-LST-YY
        AND          MONTH(APMNT_DT) = :ARX04W.WS-LST-MM
        AND         ACTVY_TYPE_CD = :ACTVY-TYPE-CD
        AND          APMNT_STS = :APMNT-STS
        AND        NOMADS_USRID = :NOMADS-USRID
         --** INSERT ORDER BY CLAUSE HERE **
      }
      into ARX04W.WS-COUNT ;
  end
  /*  */
  /* Increment count of rows retrieved*/
  if (sysVar.sqlData.sqlcode == 0)
    VDBCONTROL.UROWR = VDBCONTROL.UROWR + 1;
  end
end // end ARX04P9-WRC-READ


// WRITE PCE FILE
Function ARX04P9-WRIT-PCE()
  /* Write into PCE file*/
  try
    add SR-ARX04W1 ;
  end
  if (SR-ARX04W1 is ioError)
    VDBCONTROL.UPROC-NM = "ARX04P9-WRIT-PCE";
    VDBCONTROL.UPROC-OBJ = "SR-ARX04W1";
    VDBCONTROL.UPROC-OPT = "ADD";
    VMESSAGE.UMSGINS[2] = "ARX04A";
    VDBCONTROL.UMSQLCODE = 0;
    VMESSAGE.UMSGCODE = " ";
    ARX04W.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = ARX04W.WS-ERR-LAST-FOUR;
    VDBCONTROL.UEZESQRRM = "INPUT PARAMETER FILE - I/O ERROR";
    WCM00P2-TO-CEP01A();
  end
end // end ARX04P9-WRIT-PCE


// RETRIEVE WORKER DETAILS
Function ARX04P9-WRKR-DTLS()
  /* Perform standard database application initialization*/
  WDB00PI();
  VDBCONTROL.UACCTYP = "R";
  VDBCOMMON.UAPPLNAM = "ARX04A";
  set S2-2-NMU-SPT empty;
  /*  */
  /* Get worker details.*/
  S2-2-NMU-SPT.OFC-CD = SR-ARX04W1.PCE-OFC-CD;
  S2-2-NMU-SPT.PRGM-OFC-TYPE = "A";
  S2-2-NMU-SPT.SPRVS-UNIT = SR-ARX04W1.PCE-SPRVS-UNIT;
  S2-2-NMU-SPT.PSN-NMB = SR-ARX04W1.PCE-PSN-NMB;
  /*  */
  /* Read twnnomads_user.*/
  ARX04P9-NMU-READ();
  /*  */
  if (sysVar.sqlData.sqlcode == 0)
    ARX04W.WS-WRKR-ID = S2-2-NMU-SPT.NOMADS-USRID;
    ARX04W.WS-LST = S2-2-NMU-SPT.LST-NM;
    ARX04W.WS-FRST = S2-2-NMU-SPT.FRST-NM;
    ARX04W.WS-WRKR-LST-NM = ARX04W.WS-LST-NM;
    ARX04W.WS-WRKR-FRST-NM = ARX04W.WS-FRST-NM;
    ARX04W.WS-WRKR-SPACE-NM = " ";
  end
  /*  */
  VDBCOMMON.UNRF = "Y";
  VDBCOMMON.UDUP = "N";
  /*  */
  /* Perform DBM error processing*/
  WDB00PE-SQLERR();
  /*  */
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
  /*  */
  SR-ARX04W1.PCE-WRKR-ID = ARX04W.WS-WRKR-ID;
  SR-ARX04W1.PCE-WRKR-NM = ARX04W.WS-WRKR-NM;
  /* End get worker details*/
end // end ARX04P9-WRKR-DTLS


Record ARX04W type basicRecord
  10 WS-FILE-AID-CD char(3) ; 
  10 WS-FILE-ELIG-CD char(1) ; 
  10 WS-PREV-OFC-CD char(2) ; 
  10 WS-PREV-SPRVS-UNIT char(1) ; 
  10 WS-PREV-FUNC-AREA-CD char(1) ; 
  10 WS-PREV-WRKR-TYPE char(1) ; 
  10 WS-PREV-PSN-NMB smallint ; 
  10 WS-WRKR-ID char(8) ; 
  10 WS-WRKR-NM char(30) ; 
    15 WS-WRKR-LST-NM char(15) ; 
    15 WS-WRKR-SPACE-NM char(1) ; 
    15 WS-WRKR-FRST-NM char(14) ; 
  10 WS-COUNT smallint ; 
  10 WS-WRKR-NAME char(37) ; 
    15 WS-LST char(21) ; 
      20 WS-LST-NM char(15) ; 
      20 WS-FIL1 char(6) ; 
    15 WS-FRST char(16) ; 
      20 WS-FRST-NM char(14) ; 
      20 WS-FIL2 char(2) ; 
  10 WS-LST-YY smallint ; 
  10 WS-LST-MM smallint ; 
  10 WS-INC smallint ; 
  10 WS-FLAG char(1) ; 
  10 WS-COUNT1 smallint ; 
  10 WS-TEMP num(4) ; 
  10 WS-SQCOD num(9) ; 
  10 WS-LEAP-FLAG char(1) ; 
  10 WS-UROWR int ; 
  10 WS-FAM-UROWR int ; 
  10 WS-FAC-UROWR int ; 
  10 WS-INIT-APRVL-DT char(10) ; 
  10 WS-ERR-CD char(8) ; 
    15 WS-ERR-FIRST-FOUR char(4) ; 
    15 WS-ERR-LAST-FOUR char(4) ; 
  10 WS-ACT-APPL-DT-TS char(26) ; 
    15 WS-ACT-APPL-DT char(10) ; 
    15 FILLER char(16) ; 
  10 WS-OFF-DATA char(4) ; 
end // end ARX04W


Record ARX04W2 type basicRecord
  10 PI1-LST-DAY-MNTH char(10) ; 
    15 PI1-LST-DAY-MNTH-CCYY num(4) ; 
    15 PL1-FIL1 char(1) ; 
    15 PI1-LST-DAY-MNTH-MM num(2) ; 
    15 PL1-FIL2 char(1) ; 
    15 PI1-LST-DAY-MNTH-DD num(2) ; 
end // end ARX04W2


Record ARX04W3 type basicRecord
  10 PI1-LST-DAY-MNTH char(8) ; 
    15 PI1-LST-DAY-MNTH-CCYY num(4) ; 
    15 PI1-LST-DAY-MNTH-MM num(2) ; 
    15 PI1-LST-DAY-MNTH-DD num(2) ; 
end // end ARX04W3


