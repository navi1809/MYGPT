-- 1) Build an S04-like base tied to FA/RE/RI actions
APPRV_BASE AS (
  SELECT
    T1.OFC_CD,
    OFC.OFC_NM,
    T2.ICI,
    T2.FS_SUFX,
    T3.RCRT_APL_DT,
    RPT.RPT_BEG_DT,
    RPT.RPT_END_DT,
    TFA.ACTN_TYP,
    TFA.ACTN_TS,
    ROW_NUMBER() OVER (PARTITION BY T2.ICI ORDER BY TFA.ACTN_TS DESC) AS rn
  FROM {?SCHEMA}.TWNFAM_CASELD_CASE  T1
  JOIN {?SCHEMA}.TWNFAM_CASE_HSTRY   T2  ON T1.ICI = T2.ICI
  JOIN {?SCHEMA}.TWNPRGM_CASE_HSTRY  T3  ON T1.ICI = T3.ICI AND T3.PRGM_CASE_TYPE = 'FS'
  JOIN {?SCHEMA}.TWNFAM_ACTNS        TFA ON T1.ICI = TFA.ICI                    -- Family Actions
  JOIN OFFICE_DATA OFC                    ON T1.OFC_CD = OFC.OFC_CD
  JOIN RPT_DATES RPT                      ON 1=1
  WHERE
    T2.PRD_BEG_DT <= RPT.RPT_END_DT
    AND T2.PRD_END_DT >= RPT.RPT_END_DT
    AND TFA.ACTN_TYP IN ('FA','RE','RI')                                        -- <-- legacy S04 filter
),
-- 2) One row per case (latest action), then compute PABNFT/NABNFT and NEW/SUBS
APPRV_DEDUP AS (
  SELECT *
  FROM APPRV_BASE
  WHERE rn = 1
),
MAIN2 AS (  -- replaces your existing MAIN2
  SELECT
    OFC_CD,
    OFC_NM,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PABNFT,   -- FULL BENEFIT (PA)
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') AND RCRT_APL_DT BETWEEN RPT_BEG_DT AND RPT_END_DT THEN 1 ELSE 0 END) AS PANEW,
    SUM(CASE WHEN FS_SUFX IN ('P','S','G','A') AND (RCRT_APL_DT < RPT_BEG_DT OR RCRT_APL_DT > RPT_END_DT) THEN 1 ELSE 0 END) AS PASUBS,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NABNFT,  -- FULL BENEFIT (NA)
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') AND RCRT_APL_DT BETWEEN RPT_BEG_DT AND RPT_END_DT THEN 1 ELSE 0 END) AS NANEW,
    SUM(CASE WHEN FS_SUFX NOT IN ('P','S','G','A') AND (RCRT_APL_DT < RPT_BEG_DT OR RCRT_APL_DT > RPT_END_DT) THEN 1 ELSE 0 END) AS NASUBS
  FROM APPRV_DEDUP
  GROUP BY OFC_CD, OFC_NM
)
