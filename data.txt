WITH CaseData AS (
    SELECT 
        T1.ICI,
        T1.PRGM_CASE_STS,
        T1.PRGM_CASE_TYPE,
        T1.AID_CD,
        T2.WTHDR_TST_RSLT_CD,
        T2.APL_DTH_TSTRSL_CD,
        T2.RSDN_TST_RSLT_CD,
        T2.AGDDIS_ST_TSTRS_CD,
        T2.VRF_TST_RSLT_CD,
        T2.SSN_TEST_RSLT_CD,
        T2.COOP_TEST_RSLT_CD,
        T2.MRF_COMP_TSTRSL_CD,
        T2.BNFT_YR,
        T2.BNFT_MTH,
        T2.VER_NMB,
        T3.LST_BU_CNSD,
        T4.GRS_INC_TST_RSLTCD,
        T4.RSRCS_TST_RSLT_CD,
        T5.CASLD_EFF_DT,
        T6.HOH_UPI,
        T5.OFC_CD,
        T5.CASLD_ID,  -- Case Load ID now considered
        T7.OFC_NM,
        -- Determine Closure Reason Code
        CASE
            WHEN T2.WTHDR_TST_RSLT_CD = 'F' THEN 1
            WHEN T2.APL_DTH_TSTRSL_CD = 'F' THEN 2
            WHEN T2.RSDN_TST_RSLT_CD = 'F' THEN 3
            WHEN T2.AGDDIS_ST_TSTRS_CD = 'F' THEN 4
            WHEN T2.VRF_TST_RSLT_CD = 'F'
                OR T2.SSN_TEST_RSLT_CD = 'F'
                OR T2.COOP_TEST_RSLT_CD = 'F'
                OR T2.MRF_COMP_TSTRSL_CD = 'F' THEN 5
            WHEN T4.RSRCS_TST_RSLT_CD = 'F' THEN 7
            WHEN T4.GRS_INC_TST_RSLTCD = 'F' THEN 8
            ELSE 6  -- Default case (FAILED ALL CATEGORIES)
        END AS PCE_RSN_CD,
        -- Determine Closure Reason Description
        CASE
            WHEN T2.WTHDR_TST_RSLT_CD = 'F' THEN 'CASE WITHDRAWAL'
            WHEN T2.APL_DTH_TSTRSL_CD = 'F' THEN 'DEATH'
            WHEN T2.RSDN_TST_RSLT_CD = 'F' THEN 'NOT MEETING RESIDENCE REQ'
            WHEN T2.AGDDIS_ST_TSTRS_CD = 'F' THEN 'FAILED AGED/DIS REQUIREMENTS'
            WHEN T2.VRF_TST_RSLT_CD = 'F'
                OR T2.SSN_TEST_RSLT_CD = 'F'
                OR T2.COOP_TEST_RSLT_CD = 'F'
                OR T2.MRF_COMP_TSTRSL_CD = 'F' THEN 'FAILED TO COOPERATE'
            WHEN T4.RSRCS_TST_RSLT_CD = 'F' THEN 'FAILED RESOURCE TEST'
            WHEN T4.GRS_INC_TST_RSLTCD = 'F' THEN 'FAILED GROSS INCOME TEST'
            ELSE 'FAILED ALL CATEGORIES'
        END AS PCE_RSN
    FROM W026DT91.TWNPRGM_CASE_HSTRY T1
    JOIN W026DT91.TWNELIG_VERSION T2 ON T1.ICI = T2.ICI
    JOIN W026DT91.TWNELG_VER_MBR T3 ON T3.ICI = T1.ICI AND T3.PRGM_CASE_TYPE = T1.PRGM_CASE_TYPE
        AND T3.BNFT_YR = T2.BNFT_YR AND T3.BNFT_MTH = T2.BNFT_MTH AND T3.VER_NMB = T2.VER_NMB
    JOIN W026DT91.TWNELG_BDGT_UNIT T4 ON T4.ICI = T1.ICI AND T4.PRGM_CASE_TYPE = T1.PRGM_CASE_TYPE
        AND T4.BNFT_YR = T2.BNFT_YR AND T4.BNFT_MTH = T2.BNFT_MTH AND T4.VER_NMB = T2.VER_NMB
        AND T4.BU_NMB = T3.LST_BU_CNSD
    JOIN W026DT91.TWNFAM_CASELD_CASE T5 ON T5.ICI = T1.ICI
    JOIN W026DT91.TWNFAM_CASE_HSTRY T6 ON T6.ICI = T1.ICI AND T6.HOH_UPI = T3.UPI
    JOIN W026DT91.TWNOFFICE T7 ON T7.OFC_CD = T5.OFC_CD
    WHERE T1.PRGM_CASE_TYPE = 'MA'
        AND T1.PRGM_CASE_STS IN ('T', 'D')
        AND T1.PRD_BEG_DT <= '2024-01-01'
        AND T1.PRD_END_DT >= '2024-01-31'
        AND T2.BNFT_MTH = 1
        AND T2.BNFT_YR = 2024
        AND T2.PRGM_CASE_TYPE = 'MA'
        AND T2.LST_POSTD_VER_IND = 'Y'
        AND T6.PRD_BEG_DT <= '2024-01-01'
        AND T6.PRD_END_DT >= '2024-01-31'
)
-- Accumulate terminations by Office, Aid Code, Case Load, and Closure Reason
SELECT
    OFC_CD,
    OFC_NM,
    CASLD_ID,  -- Added Caseload ID for detailed accumulation
    AID_CD,
    PCE_RSN_CD,
    PCE_RSN,
    COUNT(*) AS TERM_COUNT
FROM CaseData
GROUP BY OFC_CD, OFC_NM, CASLD_ID, AID_CD, PCE_RSN_CD, PCE_RSN
ORDER BY OFC_CD, CASLD_ID, AID_CD, PCE_RSN_CD;
