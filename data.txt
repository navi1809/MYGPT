-- AME37A — Full benefits by office (TOTAL, PA, NA) for Jan 2025
-- Use the SAME structure as your earlier (38) query, but fix the edge cases:
--  • half-open month window (avoid 23:59:59 cutoff issues)
--  • classify PA/NA by FS suffix as of the PREVIOUS action’s timestamp
--  • one AP per ICI (earliest AP in month), admin offices only

SELECT
  FAC.OFC_CD,
  COUNT(*) AS FULL_BENEFITS_TOTAL,
  SUM(CASE WHEN HS.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PA_BENEFITS,
  SUM(CASE WHEN HS.FS_SUFX IN ('P','S','G','A') THEN 0 ELSE 1 END) AS NA_BENEFITS
FROM
(
  /* earliest AP in Jan-2025 per ICI, limited to admin offices */
  SELECT
    C.OFC_CD,
    A.ICI,
    MIN(A.ACTN_TS) AS AP_TS
  FROM W026DTF1.TWNFAM_ACTNS A
  JOIN W026DTF1.TWNFAM_CASELD_CASE C
    ON C.ICI = A.ICI
   AND C.PRGM_OFC_TYPE = 'A'
  WHERE A.PRGM_TYP = 'FS'
    AND A.ACTN_TYP = 'AP'
    AND A.ACTN_TS >= TIMESTAMP('2025-01-01-00.00.00')
    AND A.ACTN_TS <  TIMESTAMP('2025-02-01-00.00.00')   -- half-open window
  GROUP BY C.OFC_CD, A.ICI
) FAC
/* previous FS action before that AP (must be FA/RE/RI) */
JOIN
(
  SELECT
    F.ICI,
    MAX(P.ACTN_TS) AS PREV_TS
  FROM
  (
    SELECT A.ICI, MIN(A.ACTN_TS) AS AP_TS
    FROM W026DTF1.TWNFAM_ACTNS A
    WHERE A.PRGM_TYP = 'FS'
      AND A.ACTN_TYP = 'AP'
      AND A.ACTN_TS >= TIMESTAMP('2025-01-01-00.00.00')
      AND A.ACTN_TS <  TIMESTAMP('2025-02-01-00.00.00')
    GROUP BY A.ICI
  ) F
  JOIN W026DTF1.TWNFAM_ACTNS P
    ON P.ICI = F.ICI
   AND P.PRGM_TYP = 'FS'
   AND P.ACTN_TS < F.AP_TS
  GROUP BY F.ICI
) PREV
  ON PREV.ICI = FAC.ICI
JOIN W026DTF1.TWNFAM_ACTNS PREVROW
  ON PREVROW.ICI = FAC.ICI
 AND PREVROW.ACTN_TS = PREV.PREV_TS
 AND PREVROW.PRGM_TYP = 'FS'
 AND PREVROW.ACTN_TYP IN ('FA','RE','RI')            -- same as EGL (FA/RE/RI)
 /* classify PA/NA by suffix at the time of the PREVIOUS action */
JOIN W026DTF1.TWNFAM_CASE_HSTRY HS
  ON HS.ICI = FAC.ICI
 AND HS.PRD_BEG_DT <= DATE(PREV.PREV_TS)
 AND COALESCE(HS.PRD_END_DT, DATE('9999-12-31')) >= DATE(PREV.PREV_TS)
GROUP BY FAC.OFC_CD
ORDER BY FAC.OFC_CD;
