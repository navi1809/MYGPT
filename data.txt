package PGM_C_Batch;
import egl.core.*;
import CommonMigratedParts.*;
import DataTables.*;

Program CIN02A type basicProgram //VAGen Info - main batch program
  {
  includeReferencedFunctions = yes, allowUnqualifiedItemReferences = yes, 
  throwNrfEofExceptions = yes, handleHardIOErrors = no, V60ExceptionCompatibility = yes, 
  I4GLItemsNullable = no, textLiteralDefaultIsString = no, localSQLScope = yes, 
  inputRecord = VWORKSTOR
  }

  // Data Declarations
  BDATEREC BDATEREC; // record
  CEP01W CEP01W; // record
  CIN02W CIN02W; // record
  GDW GDW; // record
  H2-NH-ACTVY H2-NH-ACTVY; // record
  H2-SDNH H2-SDNH; // record
  REP-COMMON REP-COMMON; // record
  SR-CIN02-RECIN SR-CIN02-RECIN; // record
  VDBCOMMON VDBCOMMON; // record
  VDBCONTROL VDBCONTROL; // record
  VMESSAGE VMESSAGE; // record
  VWORKSTOR VWORKSTOR ; // record

  // VAGen Info - items needed for migration
  VAGen_EZESYS char(8);
  VAGen_EZEREPLY num(1);
  VAGen_EZE_WAIT_TIME bin(9,2);
  VAGen_EZE_ITEMLEN int;

  // Use Declarations
  use VDB00T1 {deleteAfterUse = yes}; // table

  function main()
    // VAGen Info - initialization needed for migration
    VAGen_EZESYS = VGLib.getVAGSysType();
    CIN02P9-MAIN: CIN02P9-MAIN();
  end // end main
end // end CIN02A


Function CIN02P9-INIT()
  /*  */
  set SR-CIN02-RECIN empty;
  /*  */
  CIN02P9-SCAN-SEQIP();
  /*  */
end // end CIN02P9-INIT


Function CIN02P9-MAIN()
  /* ---------------------------------------------------------*/
  /* THIS PROCESS IS TO PURGE THE SDNH TABLE BASED ON THE    */
  /* DATES RECEIVED FROM THE PARAMETERS INPUT                */
  /* ---------------------------------------------------------*/
  /*  */
  /*  */
  /*  */
  WCM00P3-FETCHBDTS();
  CIN02W.WS-CURRENT-DATE-CC = BDATEREC.BDATE-PROCESS-DATE-CC;
  CIN02W.WS-CURRENT-DT-CC = BDATEREC.BDATE-PROCESS-DATE-CC;
  CIN02W.WS-CURRENT-DATE-YY = BDATEREC.BDATE-PROCESS-DATE-YY;
  CIN02W.WS-CURRENT-DT-YY = BDATEREC.BDATE-PROCESS-DATE-YY;
  CIN02W.WS-CURRENT-DATE-MM = BDATEREC.BDATE-PROCESS-DATE-MM;
  CIN02W.WS-CURRENT-DT-MM = BDATEREC.BDATE-PROCESS-DATE-MM;
  CIN02W.WS-CURRENT-DATE-DD = BDATEREC.BDATE-PROCESS-DATE-DD;
  CIN02W.WS-CURRENT-DT-DD = BDATEREC.BDATE-PROCESS-DATE-DD;
  CIN02W.WS-HYPHEN-1 = "-";
  CIN02W.WS-HYPHEN-2 = "-";
  CIN02W.WS-HYPHEN-3 = "-";
  CIN02W.WS-HYPHEN-4 = "-";
  /*  */
  CIN02P9-INIT();

  /*  */
  CIN02P9-PURGE-REQ();
  /*  */
  CIN02P9-PURGE-IVD();
  /*  */
end // end CIN02P9-MAIN


Function CIN02P9-PURGE()
  /*  */
  WDB00PI();
  VDBCOMMON.USQLREC = "H2-SDNH";
  VDBCONTROL.UPROC-OBJ = "H2-SDNH";
  VDBCONTROL.UPROC-OPT = "SQLEXEC";
  VDBCONTROL.UPROC-NM = "CIN02P9-PURGE";
  VDBCOMMON.USQLREC = "H2-SDNH";
  /*  */
  try
    execute 
      #sql{
        DELETE FROM TWNSDNH
         WHERE CRTN_DT < :CRTN-DT
      }
      for H2-SDNH ; // model = none
  end
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
  /*  */
end // end CIN02P9-PURGE


Function CIN02P9-PURGE-4D()
  /*  */
  WDB00PI();
  VDBCOMMON.USQLREC = "H2-IVD-NH-ACTVY";
  VDBCONTROL.UPROC-OBJ = "H2-IVD-NH-ACTVY";
  VDBCONTROL.UPROC-OPT = "SQLEXEC";
  VDBCONTROL.UPROC-NM = "CIN02P9-PURGE-4D";
  VDBCOMMON.USQLREC = "H2-IVD-NH-ACTVY";
  /*  */
  try
    execute 
      #sql{
        DELETE FROM TWNIVD_NH_ACTVY
          WHERE RPT_YR < :RPT-YR
             OR (RPT_YR = :RPT-YR AND RPT_MTH <= :RPT-MTH)
      }
      for H2-NH-ACTVY ; // model = none
  end
  /*  */
  if (VDBCONTROL.URC > 104)
    WCM00P2-TO-CEP01A();
  end
  /*  */
end // end CIN02P9-PURGE-4D


Function CIN02P9-PURGE-IVD()
  while (CIN02W.WS-CURRENT-DT-MM <= SR-CIN02-RECIN.IVD-NH-ACTVY-MTHS)
    CIN02P9-SET-STR4();
  end
  CIN02W.WS-CURRENT-DT-MM = CIN02W.WS-CURRENT-DT-MM -   SR-CIN02-RECIN.SDNH-MONTHS;
  H2-NH-ACTVY.RPT-MTH = CIN02W.WS-CURRENT-DT-MM;
  H2-NH-ACTVY.RPT-YR = CIN02W.WS-CURRENT-DT-CY;
  CIN02P9-PURGE-4D();
  /*  */
end // end CIN02P9-PURGE-IVD


Function CIN02P9-PURGE-REQ()
  while (CIN02W.WS-CURRENT-DATE-MM <= SR-CIN02-RECIN.SDNH-MONTHS)
    CIN02P9-SET-STRT();
  end
  CIN02W.WS-CURRENT-DATE-MM = CIN02W.WS-CURRENT-DATE-MM -   SR-CIN02-RECIN.SDNH-MONTHS;
  if (CIN02W.WS-CURRENT-DATE-MM == 04 || 
  CIN02W.WS-CURRENT-DATE-MM == 06 || 
  CIN02W.WS-CURRENT-DATE-MM == 09 || 
  CIN02W.WS-CURRENT-DATE-MM == 11)
    CIN02W.WS-CURRENT-DATE-DD = "30";
  else
    CIN02W.WS-CURRENT-DATE-DD = "31";
  end
  if (CIN02W.WS-CURRENT-DATE-MM == 02)
    REP-COMMON.WS-YYYY = CIN02W.WS-CURRENT-DATE-CY;
    LEAP-YEAR-CHECK();
    if (REP-COMMON.WS-LEAP-FLAG == "Y")
      CIN02W.WS-CURRENT-DATE-DD = "29";
    else
      CIN02W.WS-CURRENT-DATE-DD = "28";
    end
  end
  H2-SDNH.CRTN-DT = CIN02W.WS-CURRENT-DATE;
  CIN02P9-PURGE();
end // end CIN02P9-PURGE-REQ


Function CIN02P9-SCAN-SEQIP()
  try
    get next SR-CIN02-RECIN ;
  end
  if (SR-CIN02-RECIN is ioError
   || SR-CIN02-RECIN.SDNH-MONTHS < 01
   || SR-CIN02-RECIN.IVD-NH-ACTVY-MTHS < 01)
    VDBCONTROL.UPROC-OPT = "SCAN";
    WEZERT8-TO-URC();
    VMESSAGE.UMSGCODE = VDBCONTROL.URC;
    VDBCONTROL.UPROC-NM = "CIN02P9-SCAN-SEQIP";
    VDBCONTROL.UPROC-OBJ = "CIN02P9-SCAN-SEQIPI";
    CIN02W.WS-ERR-CD = sysVar.errorCode;
    VMESSAGE.UMSGINS[1] = CIN02W.WS-ERR-LAST-FOUR;
    VMESSAGE.UMSGCODE = "AML0009E";
    VMESSAGE.UMSGCODE-JCL-ERR = 04;
    VMESSAGE.UMSGINS[2] = "CIN02A";
    WCM00P2-TO-CEP01A();
    exit program;
  end
end // end CIN02P9-SCAN-SEQIP


Function CIN02P9-SET-STR4()
  if (SR-CIN02-RECIN.IVD-NH-ACTVY-MTHS >= CIN02W.WS-CURRENT-DT-MM)
    CIN02W.WS-CURRENT-DT-MM = CIN02W.WS-CURRENT-DT-MM + 12;
    CIN02W.WS-CURRENT-DT-CY = CIN02W.WS-CURRENT-DT-CY - 01;
  end
end // end CIN02P9-SET-STR4


Function CIN02P9-SET-STRT()
  if (SR-CIN02-RECIN.SDNH-MONTHS >= CIN02W.WS-CURRENT-DATE-MM)
    CIN02W.WS-CURRENT-DATE-MM = CIN02W.WS-CURRENT-DATE-MM + 12;
    CIN02W.WS-CURRENT-DATE-CY = CIN02W.WS-CURRENT-DATE-CY - 01;
  end
end // end CIN02P9-SET-STRT


Record CIN02W type basicRecord
  10 WS-WORK-ITEM char(3) ; 
  10 WS-CURRENT-DATE char(10) ; 
    15 WS-CURRENT-DATE-CY num(4) ; 
      20 WS-CURRENT-DATE-CC num(2) ; 
      20 WS-CURRENT-DATE-YY num(2) ; 
    15 WS-HYPHEN-1 char(1) ; 
    15 WS-CURRENT-DATE-MM num(2) ; 
    15 WS-HYPHEN-2 char(1) ; 
    15 WS-CURRENT-DATE-DD num(2) ; 
  10 WS-ERR-CD char(8) ; 
    15 WS-ERR-FRST-FOUR char(4) ; 
    15 WS-ERR-LAST-FOUR char(4) ; 
  10 WS-CURRENT-DT char(10) ; 
    15 WS-CURRENT-DT-CY num(4) ; 
      20 WS-CURRENT-DT-CC num(2) ; 
      20 WS-CURRENT-DT-YY num(2) ; 
    15 WS-HYPHEN-3 char(1) ; 
    15 WS-CURRENT-DT-MM num(2) ; 
    15 WS-HYPHEN-4 char(1) ; 
    15 WS-CURRENT-DT-DD num(2) ; 
end // end CIN02W


