WITH AMA44_OUTPUT AS (
    SELECT
        T1.ICI,
        T1.PRGM_CASE_STS,
        T1.PRGM_CASE_TYPE,
        T1.AID_CD,
        T2.WTHDR_TST_RSLT_CD,
        T2.APL_DTH_TSTRSL_CD,
        T2.RSDN_TST_RSLT_CD,
        T2.AGDDIS_ST_TSTRS_CD,
        T2.VRF_TST_RSLT_CD,
        T2.SSN_TEST_RSLT_CD,
        T2.COOP_TEST_RSLT_CD,
        T2.MRF_COMP_TSTRSL_CD,
        T2.BNFT_YR,
        T2.BNFT_MTH,
        T2.VER_NMB,
        T3.OFC_CD,
        T3.CASLD_ID,
        T4.OFC_NM,
        T5.HOH_UPI,
        T6.RSRCS_TST_RSLT_CD,
        T6.GRS_INC_TST_RSLTCD,
        CASE
            WHEN T2.WTHDR_TST_RSLT_CD = 'F' THEN 'CASE WITHDRAWL'
            WHEN T2.APL_DTH_TSTRSL_CD = 'F' THEN 'DEATH'
            WHEN T2.RSDN_TST_RSLT_CD = 'F' THEN 'NOT MEETING RESIDENCE REQ'
            WHEN T2.AGDDIS_ST_TSTRS_CD = 'F' THEN 'FAILED AGED/DIS REQUIREMENTS'
            WHEN T2.VRF_TST_RSLT_CD = 'F' OR T2.SSN_TEST_RSLT_CD = 'F' OR T2.COOP_TEST_RSLT_CD = 'F' OR T2.MRF_COMP_TSTRSL_CD = 'F' THEN 'FAILED TO COOPERATE'
            WHEN T6.RSRCS_TST_RSLT_CD = 'F' THEN 'FAILED RESOURCE TEST'
            WHEN T6.GRS_INC_TST_RSLTCD = 'F' THEN 'FAILED GROSS INCOME TEST'
            ELSE 'FAILED ALL CATEGORIES'
        END AS PCE_RSN
    FROM W026DT91.TWNPRGM_CASE_HSTRY T1
    JOIN W026DT91.TWNELIG_VERSION T2 ON T1.ICI = T2.ICI
    JOIN W026DT91.TWNFAM_CASELD_CASE T3 ON T1.ICI = T3.ICI
    JOIN W026DT91.TWNOFFICE T4 ON T3.OFC_CD = T4.OFC_CD
    JOIN W026DT91.TWNFAM_CASE_HSTRY T5 ON T1.ICI = T5.ICI
    JOIN W026DT91.TWNELG_BDGT_UNIT T6 ON T1.ICI = T6.ICI
    WHERE T1.PRGM_CASE_TYPE = 'MA'
        AND T1.PRGM_CASE_STS IN ('T', 'D')
        AND T1.PRD_BEG_DT <= CURRENT_DATE
        AND T1.PRD_END_DT >= CURRENT_DATE
        AND T2.LST_POSTD_VER_IND = 'Y'
),

AMA12_STATS AS (
    SELECT
        PCE_AID_CD,
        PCE_RSN,
        OFC_CD,
        CASLD_ID,
        HOH_UPI,
        COUNT(*) AS TERMINATION_COUNT
    FROM AMA44_OUTPUT
    GROUP BY PCE_AID_CD, PCE_RSN, OFC_CD, CASLD_ID, HOH_UPI
)

SELECT 
    A.PCE_AID_CD, 
    A.PCE_RSN, 
    A.OFC_CD, 
    A.CASLD_ID, 
    A.HOH_UPI,
    B.OFC_NM,
    A.TERMINATION_COUNT,
    C.ADDITIONAL_METRICS
FROM AMA12_STATS A
LEFT JOIN TWNOFFICE B ON A.OFC_CD = B.OFC_CD
LEFT JOIN (
    SELECT 
        PCE_AID_CD, 
        COUNT(*) AS ADDITIONAL_METRICS 
    FROM AMA44_OUTPUT
    WHERE PCE_RSN IN ('FAILED TO COOPERATE', 'FAILED AGED/DIS REQUIREMENTS', 'FAILED RESOURCE TEST', 'FAILED GROSS INCOME TEST')
    GROUP BY PCE_AID_CD
) C ON A.PCE_AID_CD = C.PCE_AID_CD
ORDER BY A.OFC_CD, A.PCE_AID_CD, A.PCE_RSN;
