-- Full benefits by office (TOTAL, PA, NA) for Jan 2025 â€” DB2-compatible, no CTEs

SELECT
  C.OFC_CD,
  COUNT(*) AS FULL_BENEFITS_TOTAL,
  SUM(CASE WHEN H.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PA_BENEFITS,
  SUM(CASE WHEN H.FS_SUFX IN ('P','S','G','A') THEN 0 ELSE 1 END) AS NA_BENEFITS
FROM W026DTF1.TWNFAM_ACTNS       A
JOIN W026DTF1.TWNFAM_CASELD_CASE C
  ON C.ICI = A.ICI
 AND C.PRGM_OFC_TYPE = 'A'                         -- Admin office caseload
JOIN W026DTF1.TWNFAM_CASE_HSTRY  H
  ON H.ICI = A.ICI
 AND H.PRD_BEG_DT <= DATE(A.ACTN_TS)               -- FS suffix as of action timestamp
 AND COALESCE(H.PRD_END_DT, DATE('9999-12-31')) >= DATE(A.ACTN_TS)
WHERE A.PRGM_TYP = 'FS'
  AND A.ACTN_TYP IN ('FA','RE','RI')               -- Full benefit approvals
  AND A.ACTN_TS >= TIMESTAMP('2025-01-01-00.00.00')
  AND A.ACTN_TS <= TIMESTAMP('2025-01-31-23.59.59')
GROUP BY C.OFC_CD
ORDER BY C.OFC_CD;
