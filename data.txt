WITH
RPT_DATES AS (
  SELECT
    -- Report window for 2025-01
    (DATE('2025-01-01') - (DAY(DATE('2025-01-01')) - 1) DAYS)                                   AS RPT_BEG_DT,
    LAST_DAY(DATE('2025-01-01'))                                                                  AS RPT_END_DT,
    TIMESTAMP((DATE('2025-01-01') - (DAY(DATE('2025-01-01')) - 1) DAYS))                          AS RPT_BEG_TS,
    (TIMESTAMP(LAST_DAY(DATE('2025-01-01'))) + 1 DAY - 1 MICROSECOND)                             AS RPT_END_TS,
    MONTH(DATE('2025-01-01'))                                                                     AS RPT_MONTH_BIN,
    YEAR(DATE('2025-01-01'))                                                                      AS RPT_YEAR_BIN,
    CASE WHEN MONTH(DATE('2025-01-01')) = 1 THEN 12 ELSE MONTH(DATE('2025-01-01')) - 1 END        AS PREV_RPT_MTH,
    CASE WHEN MONTH(DATE('2025-01-01')) = 1 THEN YEAR(DATE('2025-01-01')) - 1 ELSE YEAR(DATE('2025-01-01')) END AS PREV_RPT_YR
  FROM SYSIBM.SYSDUMMY1
),
OFFICES AS (
  SELECT DISTINCT T1.OFC_CD, T.OFC_NM
  FROM W026DTF1.TWNCASELD_DEBTLD T1
  JOIN W026DTF1.TWNOFFICE T ON T.OFC_CD = T1.OFC_CD
  WHERE T1.PRGM_OFC_TYPE = 'A' AND T1.OFC_CD NOT IN ('DC','DH','DL','DR')
),
OFFICE_DATA AS (
  SELECT OFC.OFC_CD, OFC.OFC_NM
  FROM OFFICES OFC
),

/* ===== ACTIVE CASELOAD ===== */
ACT_CASELD_INFO AS (
  SELECT
    T1.OFC_CD, OFC.OFC_NM,
    T2.FS_SUFX, T2.MTHLY_RPTR_IND,
    T3.EXPD_SRVC_IND, T3.MTHD_OF_ISNCE, T3.ISNCE_MTHD
  FROM W026DTF1.TWNFAM_CASELD_CASE T1
  JOIN W026DTF1.TWNFAM_CASE_HSTRY T2 ON T1.ICI = T2.ICI
  JOIN W026DTF1.TWNFS_ISNCE      T3 ON T2.ICI = T3.ICI
  JOIN OFFICE_DATA OFC              ON T1.OFC_CD = OFC.OFC_CD
  JOIN RPT_DATES RPT                ON 1=1
  WHERE
    T2.PRD_BEG_DT <= RPT.RPT_END_DT
    AND T2.PRD_END_DT >= RPT.RPT_END_DT
    AND T3.ISNCE_DT <= RPT.RPT_END_DT
    AND T3.BNFT_MTH = RPT.RPT_MONTH_BIN
    AND T3.BNFT_YR  = RPT.RPT_YEAR_BIN
    AND T3.BNFT_TYPE = 'RG'
    AND T3.FS_ISNCE_STS IN ('IS','RD')
),
MAIN0 AS (
  SELECT
    ACI.OFC_CD, ACI.OFC_NM,
    SUM(CASE WHEN ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PACASES,
    SUM(CASE WHEN ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NACASES,
    SUM(CASE WHEN ACI.EXPD_SRVC_IND = 'Y' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAEXPCASE,
    SUM(CASE WHEN ACI.EXPD_SRVC_IND = 'Y' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAEXPCASE,
    SUM(CASE WHEN ACI.ISNCE_MTHD = 'E' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAEBTCASE,
    SUM(CASE WHEN ACI.ISNCE_MTHD = 'E' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAEBTCASE,
    SUM(CASE WHEN ACI.ISNCE_MTHD = 'E' THEN 1 ELSE 0 END) AS DMIEBT,
    SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '3' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PADAMS,
    SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE = '3' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NADAMS,
    SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE <> '3' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PASPHNDL,
    SUM(CASE WHEN ACI.ISNCE_MTHD <> 'E' AND ACI.MTHD_OF_ISNCE <> '3' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NASPHNDL,
    SUM(CASE WHEN ACI.MTHLY_RPTR_IND = 'Y' AND ACI.FS_SUFX IN ('P','S','G','A') THEN 1 ELSE 0 END) AS PAMRC,
    SUM(CASE WHEN ACI.MTHLY_RPTR_IND = 'Y' AND ACI.FS_SUFX NOT IN ('P','S','G','A') THEN 1 ELSE 0 END) AS NAMRC
  FROM ACT_CASELD_INFO ACI
  GROUP BY ACI.OFC_CD, ACI.OFC_NM
),

/* ===== LAST MONTH ISSUES / REVISED ===== */
LST_MTH_CSLD AS (
  SELECT T1.OFC_CD, OFC.OFC_NM, T2.FS_SUFX, T3.ISNCE_DT, RPT.RPT_BEG_DT, RPT.RPT_END_DT
  FROM W026DTF1.TWNFAM_CASELD_CASE T1
  JOIN W026DTF1.TWNFAM_CASE_HSTRY T2 ON T1.ICI = T2.ICI
